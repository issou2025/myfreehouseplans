{% extends "base.html" %}

{% block meta_description %}
{% set meta_fallback = plan.short_description or plan.architectural_summary or plan.description or '' %}
{{ (meta.description if meta else meta_fallback)|striptags|truncate(160, True, '…') }}
{% endblock %}

{% block structured_data %}
{% if product_schema %}
<script type="application/ld+json">{{ product_schema | tojson | safe }}</script>
{% endif %}
{% if breadcrumb_schema %}
<script type="application/ld+json">{{ breadcrumb_schema | tojson | safe }}</script>
{% endif %}
{% if faq_schema %}
<script type="application/ld+json">{{ faq_schema | tojson | safe }}</script>
{% endif %}
{% endblock %}

{% block content %}
{% set hero_image = plan.image_url if plan is defined and plan.image_url else (plan.cover_image or plan.main_image) %}
{% set placeholder_src = url_for('static', filename='images/placeholder.svg') %}
{% set hero_src = upload_url(hero_image) if hero_image else placeholder_src %}
{% set hero_thumb = hero_src or placeholder_src %}
{% set plan_title = plan.title|default('House Plan', true) %}
{% set plan_ref = plan.reference_code|default(plan.id, true) %}
{% set plan_slug = plan.slug|default('', true) %}
<div class="shell">
    <article class="plan-detail" itemscope itemtype="https://schema.org/Product">
           <div data-plan-track hidden
                         data-plan-slug="{{ plan_slug }}"
                         data-plan-title="{{ plan_title }}"
                         data-plan-reference="{{ plan_ref }}"
                                                 data-plan-thumb="{{ hero_thumb }}"
             data-plan-area="{{ plan.area_sqft or plan.total_area_sqft or plan.square_feet or '' }}"
               data-plan-bedrooms="{{ plan.bedrooms_count or plan.number_of_bedrooms or plan.bedrooms or '' }}"
               data-plan-price="{{ plan.starting_paid_price or '' }}"></div>
        <nav class="breadcrumbs" aria-label="Breadcrumb">
            <a href="{{ url_for('main.index') }}">Home</a>
            <a href="{{ url_for('main.packs') }}">Plans</a>
                        <span aria-current="page">{{ plan_title }}</span>
        </nav>

        <div class="plan-hero">
            <div class="plan-hero__media">
                <figure>
                    {% if hero_image %}
                        {{ picture_tag(hero_image, alt=plan_title, preset=HERO_PRESET, variant='base', loading='eager', decoding='async', css_class='plan-hero__img', itemprop='image') }}
                    {% else %}
                        <img
                            src="{{ hero_src }}"
                            alt="{{ plan_title }}"
                            loading="eager"
                            decoding="async"
                            itemprop="image"
                            onerror="this.onerror=null;this.src='{{ placeholder_src }}';">
                    {% endif %}
                    <figcaption>{{ plan_title }} · {{ 'Perspective study' if hero_image else 'Image coming soon' }}</figcaption>
                </figure>
                <div class="plan-hero__tags">
                    {% if plan.is_featured %}<span class="badge badge--glow">Signature pick</span>{% endif %}
                    {% if plan.suitable_climate %}<span class="badge badge--outline">{{ plan.suitable_climate }}</span>{% endif %}
                </div>
            </div>
            <div class="plan-hero__summary">
                <p class="plan-card__eyebrow">
                    {% if plan.categories %}
                        {% for c in plan.categories %}
                            <a href="{{ url_for('main.plans_by_category', slug=c.slug) }}">{{ c.name }}</a>{% if not loop.last %} · {% endif %}
                        {% endfor %}
                    {% else %}
                        {{ plan.category.name if plan.category else (category_name|default('Uncategorized', true)) }}
                    {% endif %}
                </p>
                <h1 itemprop="name">{{ plan_title }}</h1>
                <p class="plan-hero__lead" itemprop="description">{{ plan.architectural_summary if plan.architectural_summary else 'A thoughtfully designed house plan.' }}</p>
                <div class="plan-meta-bar">
                    <span class="badge badge--ghost">Ref {{ plan_ref }}</span>
                    {% if pack_visibility.get(1) and plan.has_free_download %}
                        <span class="badge badge--soft">Free pack ready</span>
                    {% else %}
                        <span class="badge badge--outline">Free preview coming soon</span>
                    {% endif %}
                </div>
                <div class="plan-hero__favorites">
                    <button
                        class="favorite-toggle favorite-toggle--inline"
                        type="button"
                        aria-pressed="false"
                        data-favorite-toggle
                        data-plan-id="{{ plan.id }}"
                        data-plan-slug="{{ plan.slug }}"
                        data-plan-title="{{ plan_title }}"
                        data-plan-reference="{{ plan_ref }}"
                        data-plan-thumb="{{ hero_thumb }}">
                        <span class="favorite-toggle__icon" aria-hidden="true">♡</span>
                        <span class="favorite-toggle__label">Add to favorites</span>
                    </button>
                    <p class="microcopy">Favorites are stored locally—no sign-up needed.</p>
                </div>
                <div class="plan-hero__compare">
                    <button
                        class="compare-toggle compare-toggle--inline"
                        type="button"
                        aria-pressed="false"
                        data-compare-toggle
                        data-plan-id="{{ plan.id }}"
                        data-plan-slug="{{ plan_slug }}"
                        data-plan-title="{{ plan_title }}"
                        data-plan-reference="{{ plan_ref }}"
                        data-plan-thumb="{{ hero_thumb }}"
                        data-plan-area="{{ plan.area_sqft or plan.total_area_sqft or plan.square_feet or '' }}"
                        data-plan-area-m2="{{ plan.area_m2 or '' }}"
                        data-plan-bedrooms="{{ plan.bedrooms_count or plan.number_of_bedrooms or plan.bedrooms or '' }}"
                        data-plan-bathrooms="{{ plan.bathrooms_count or plan.number_of_bathrooms or plan.bathrooms or '' }}"
                        data-plan-floors="{{ plan.floors_count or plan.number_of_floors or '' }}"
                        data-plan-parking="{{ plan.parking_count or '' }}"
                        data-plan-price="{{ plan.starting_paid_price or '' }}"
                        data-plan-free="{{ '1' if plan.has_free_download else '0' }}"
                        data-plan-categories="{{ plan.categories|map(attribute='name')|join(' · ') if plan.categories else '' }}"
                        data-plan-url="{{ url_for('main.pack_detail', slug=plan_slug) }}">
                        <span class="compare-toggle__label">Add to compare</span>
                    </button>
                    <p class="microcopy">Pick up to three plans to compare side by side.</p>
                </div>
                <div class="plan-trust-badges" role="list" aria-label="Trust notes">
                    <span role="listitem">Architect-designed</span>
                    <span role="listitem">Build-ready drawings</span>
                    <span role="listitem">Reference {{ plan_ref }}</span>
                </div>
                <blockquote class="plan-testimonial">
                    “We deliver the same level of care as for our private clients: clear documentation, responsive humans, no surprises.”
                    <cite>— Studio principal</cite>
                </blockquote>
                <p class="trust-row" aria-label="Trust notes">
                    <span>Architect-curated</span>
                    <span aria-hidden="true">·</span>
                    <span>Clear, build-ready sheets</span>
                    <span aria-hidden="true">·</span>
                    <span>Friendly support if you need it</span>
                </p>
                <div class="plan-quick-specs" aria-label="Quick specs">
                    {% if plan.area_sqft or plan.area_m2 %}
                    <span class="plan-quick-spec" data-unitable data-sqft="{{ plan.area_sqft|round|int if plan.area_sqft else '' }}" data-m2="{{ plan.area_m2|round(1) if plan.area_m2 else '' }}">
                        <small>Area</small>
                        <strong class="unit-value">{% if plan.area_sqft %}{{ plan.area_sqft|round|int }} sq ft{% elif plan.area_m2 %}{{ plan.area_m2|round(1) }} m²{% else %}—{% endif %}</strong>
                    </span>
                    {% endif %}
                    {% if plan.bedrooms_count %}
                    <span class="plan-quick-spec">
                        <small>Bedrooms</small>
                        <strong>{{ plan.bedrooms_count }}</strong>
                    </span>
                    {% endif %}
                    {% if plan.bathrooms_count %}
                    <span class="plan-quick-spec">
                        <small>Bathrooms</small>
                        <strong>{{ plan.bathrooms_count }}</strong>
                    </span>
                    {% endif %}
                    {% if plan.floors_count %}
                    <span class="plan-quick-spec">
                        <small>Levels</small>
                        <strong>{{ plan.floors_count }}</strong>
                    </span>
                    {% endif %}
                    {% if plan.parking_count %}
                    <span class="plan-quick-spec">
                        <small>Parking</small>
                        <strong>{{ plan.parking_count }}</strong>
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <section class="plan-overview" aria-labelledby="overview-heading">
            {% set raw_overview = (plan.short_description | striptags) if plan.short_description else ((plan.description | striptags) if plan.description else '') %}
            {% set overview_snippet = raw_overview[:280] if raw_overview else 'Studio-ready concept for modern living and hospitality projects.' %}
            {% set desc_length = (plan.description | striptags | length) if plan.description else 0 %}
            <div class="plan-overview__summary">
                <p class="eyebrow">Overview</p>
                <h2 id="overview-heading">Project snapshot</h2>
                <p class="lead">{{ overview_snippet }}{% if (not plan.short_description) and desc_length > 280 %}…{% endif %}</p>
                <div class="plan-keynotes">
                    <div>
                        <span class="plan-keynotes__label">Suitable climate</span>
                        <span>{{ plan.suitable_climate or 'Any temperate region' }}</span>
                    </div>
                    <div>
                        <span class="plan-keynotes__label">Ideal occupants</span>
                        <span>{{ plan.ideal_for or 'Growing families or boutique hospitality' }}</span>
                    </div>
                    <div>
                        <span class="plan-keynotes__label">Construction complexity</span>
                        <span>{{ plan.construction_complexity or 'Standard GC coordination' }}</span>
                    </div>
                </div>
            </div>
            <div class="plan-overview__facts">
                <div class="unit-toggle" role="group" aria-label="Unit toggle" data-unit-toggle>
                    <button type="button" class="unit-toggle__btn is-active" data-unit="sqft">sq ft</button>
                    <button type="button" class="unit-toggle__btn" data-unit="m2">m²</button>
                </div>
                <dl class="plan-facts">
                    <div>
                        <dt>Total area</dt>
                        <dd>
                            <span class="unit-value" data-unitable data-sqft="{{ plan.area_sqft|round|int if plan.area_sqft else '' }}" data-m2="{{ plan.area_m2|round(1) if plan.area_m2 else '' }}">
                                {% if plan.area_sqft %}{{ plan.area_sqft|round|int }} sq ft{% elif plan.area_m2 %}{{ plan.area_m2|round(1) }} m²{% else %}—{% endif %}
                            </span>
                        </dd>
                    </div>
                    <div><dt>Footprint</dt><dd>{{ plan.dimensions_summary or 'Awaiting field data' }}</dd></div>
                    <div><dt>Bedrooms</dt><dd>{{ plan.bedrooms_count or '—' }}</dd></div>
                    <div><dt>Bathrooms</dt><dd>{{ plan.bathrooms_count or '—' }}</dd></div>
                    <div><dt>Levels</dt><dd>{{ plan.floors_count or '—' }}</dd></div>
                    <div><dt>Parking</dt><dd>{{ plan.parking_count or '—' }}</dd></div>
                    <div><dt>Roof</dt><dd>{{ plan.roof_type or 'Flexible' }}</dd></div>
                    <div><dt>Structure</dt><dd>{{ plan.structure_type or 'Conventional frame' }}</dd></div>
                    <div><dt>Foundation</dt><dd>{{ plan.foundation_type or 'Slab or crawlspace' }}</dd></div>
                    <div><dt>Ceiling height</dt><dd>{% if plan.ceiling_height %}{{ plan.ceiling_height }} m{% else %}Varies{% endif %}</dd></div>
                </dl>
            </div>
        </section>

        <!-- Frequently Asked Questions -->
        <section class="plan-faqs" aria-labelledby="faq-heading">
            <div class="section-heading">
                <div>
                    <p class="eyebrow">Questions</p>
                    <h2 id="faq-heading">Frequently asked questions about this plan</h2>
                    <p class="muted">Answers tailored to this plan to help you move forward with confidence.</p>
                </div>
            </div>
            <div class="faq-list" id="faq-list">
                {% if faqs %}
                {% for item in faqs %}
                    {% if item.question %}
                    <div class="faq-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
                        <button class="faq-question" aria-expanded="false" aria-controls="faq-answer-{{ loop.index }}">
                            <span class="faq-question__text" itemprop="name">{{ item.question }}</span>
                            <span class="faq-question__chev">▾</span>
                        </button>
                        <div class="faq-answer" id="faq-answer-{{ loop.index }}" hidden itemprop="acceptedAnswer" itemscope itemtype="https://schema.org/Answer">
                            <div itemprop="text">{{ item.answer if item.answer else 'No answer provided yet.' }}</div>
                        </div>
                    </div>
                    {% elif item.get('question') %}
                    <div class="faq-item">
                        <button class="faq-question" aria-expanded="false" aria-controls="faq-answer-{{ loop.index }}">
                            <span class="faq-question__text">{{ item['question'] }}</span>
                            <span class="faq-question__chev">▾</span>
                        </button>
                        <div class="faq-answer" id="faq-answer-{{ loop.index }}" hidden>{{ item.get('answer', 'No answer provided yet.') }}</div>
                    </div>
                    {% endif %}
                {% endfor %}
                {% else %}
                <p class="muted">No FAQs available for this plan yet. Contact us if you have questions.</p>
                {% endif %}
            </div>
        </section>

        {# 1) Plan use cases (human, quick scan) #}
        {% set use_cases = [] %}
        {% if plan.plan_type == 'family' %}
            {% set _ = use_cases.append('Family living') %}
        {% elif plan.plan_type == 'rental' %}
            {% set _ = use_cases.append('Rental investment') %}
        {% elif plan.plan_type == 'luxury' %}
            {% set _ = use_cases.append('Professional development') %}
        {% endif %}
        {% if plan.has_free_download %}
            {% set _ = use_cases.append('Fast client review') %}
        {% endif %}
        {% if plan.customization_potential %}
            {% set _ = use_cases.append('Custom builds') %}
        {% endif %}
        {% if plan.area_sqft and plan.area_sqft < 1300 %}
            {% set _ = use_cases.append('Compact living') %}
        {% endif %}
        {% if use_cases %}
        <section class="plan-use-cases" aria-label="Plan use cases">
            <div class="section-heading">
                <div>
                    <p class="eyebrow">Perfect for</p>
                    <h2>Who this plan fits</h2>
                    <p class="muted">A quick way to see if this matches your project.</p>
                </div>
            </div>
            <ul class="use-case-chips" aria-label="Use cases">
                {% for item in use_cases[:4] %}
                    <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}

        <section class="pack-comparison" aria-labelledby="pack-heading" itemprop="offers" itemscope itemtype="https://schema.org/AggregateOffer">
            <div class="section-heading">
                <div>
                    <p class="eyebrow">Pack comparison</p>
                    <h2 id="pack-heading">Choose the documentation that fits your stage</h2>
                    <p class="muted">Clear pricing up front. Simple choices. Pick what you need today.</p>
                </div>
            </div>

            <div class="decision-guide" aria-label="Guidance">
                <p class="decision-guide__title">Not sure which one to choose?</p>
                <ul class="decision-guide__list">
                    {% if pack_visibility.get(1) %}
                    <li><strong>Pack 1</strong> is best for quick viewing and sharing.</li>
                    {% endif %}
                    {% if pack_visibility.get(2) %}
                    <li><strong>Pack 2</strong> is best when you need the full PDF set.</li>
                    {% endif %}
                    {% if pack_visibility.get(3) %}
                    <li><strong>Pack 3</strong> is best when you need editable CAD or BIM files (DWG / RVT / IFC).</li>
                    {% endif %}
                </ul>
                <p class="microcopy">Your files stay available after updates. You can re-download your packs anytime.</p>
            </div>
            {% set package_meta_default = {
                'name': 'Studio Pack',
                'description': 'Comprehensive documentation suitable for coordination and review.',
                'features': ['Portable PDF deliverable', 'Studio support via email'],
                'cta_label': 'Contact the studio',
                'card_class': 'standard',
                'button_class': 'package-button--neutral'
            } %}
            {% set package_meta = {
                1: {
                    'name': 'Free Pack',
                    'description': 'Preview-ready PDF sampler for early client reviews and fast references.',
                    'features': ['Metric + imperial teaser sheets', 'Reference schedules and finishes summary'],
                    'cta_label': 'Free Download',
                    'card_class': 'free',
                    'button_class': 'package-button--free'
                },
                2: {
                    'name': 'PDF Pro Pack',
                    'description': 'Full PDF set for permit coordination, elevations, and annotated sections.',
                    'features': ['Complete PDF deliverable', 'Elevation + section annotations'],
                    'cta_label': 'Buy PDF Pack',
                    'card_class': 'pro',
                    'button_class': 'package-button--pro'
                },
                3: {
                    'name': 'Ultimate CAD Pack',
                    'description': 'Editable files for professional workflows, plus the full PDF set.',
                    'features': ['DWG files', 'Revit (RVT) files', 'IFC files'],
                    'cta_label': 'Buy CAD Pack',
                    'card_class': 'cad',
                    'button_class': 'package-button--cad'
                }
            } %}
            {% set visible_tiers = filter_pack_tiers(plan.pricing_tiers, pack_visibility) %}
            {% if visible_tiers %}
            <div class="pack-comparison__grid">
                {% for tier in visible_tiers %}
                    {% set meta = package_meta.get(tier.pack, package_meta_default) %}
                    <article class="package-card package-card--{{ meta.card_class }}" aria-label="{{ meta.name }}">
                        <header class="package-card__header">
                            <p class="eyebrow">Pack 0{{ tier.pack }}</p>
                            <h3>{{ meta.name }}</h3>
                            <p class="package-price">
                                {% if tier.price is not none and tier.price > 0 %}
                                    ${{ tier.price|round(0)|int }} USD
                                {% elif tier.pack == 1 %}
                                    Free
                                {% else %}
                                    Contact for quote
                                {% endif %}
                            </p>
                        </header>
                        <p class="package-copy">{{ meta.description }}</p>
                        <ul class="package-points" aria-label="What you get">
                            {% for point in meta.features %}
                                <li>{{ point }}</li>
                            {% endfor %}
                        </ul>
                        <div class="package-cta">
                            {% if tier.pack == 1 %}
                                {% if plan.free_pdf_file %}
                                    <a class="package-button {{ meta.button_class }}" href="{{ url_for('main.download_free', plan_id=plan.id) }}">{{ meta.cta_label }}</a>
                                    <p class="microcopy">Instant download · No registration required</p>
                                {% else %}
                                    <button class="package-button package-button--disabled" disabled>Preview unavailable</button>
                                    <p class="microcopy">We’re finishing this file. Check back soon.</p>
                                {% endif %}
                            {% elif tier.pack == 2 %}
                                {% if plan.gumroad_pack_2_url %}
                                    <a class="package-button {{ meta.button_class }}" href="{{ url_for('main.gumroad_redirect', slug=plan.slug, pack=2) }}">{{ meta.cta_label }}</a>
                                    <p class="microcopy">You’ll be redirected to Gumroad for secure checkout.</p>
                                {% else %}
                                    <button class="package-button package-button--disabled" disabled>Reserve via studio</button>
                                    <p class="microcopy">Email us and we’ll help you get it.</p>
                                {% endif %}
                            {% else %}
                                {% if plan.gumroad_pack_3_url %}
                                    <a class="package-button {{ meta.button_class }}" href="{{ url_for('main.gumroad_redirect', slug=plan.slug, pack=3) }}">{{ meta.cta_label }}</a>
                                    <p class="microcopy">Works with AutoCAD, Revit, and many BIM tools.</p>
                                {% else %}
                                    <button class="package-button package-button--disabled" disabled>CAD bundle in progress</button>
                                    <p class="microcopy">We’ll publish it as soon as it’s ready.</p>
                                {% endif %}
                            {% endif %}
                        </div>
                    </article>
                {% endfor %}
            </div>
            {% else %}
            <p class="muted">Packs are temporarily hidden. Please check back later or contact support.</p>
            {% endif %}
            <p class="package-note">Need licensing help? <a href="{{ url_for('main.contact') }}">Email entreprise2rc@gmail.com</a> or <a href="https://wa.me/22796380877" target="_blank" rel="noopener">message us on WhatsApp</a>.</p>
            {% set visible_paid_price = visible_starting_price(plan.pricing_tiers, pack_visibility) %}
            <meta itemprop="priceCurrency" content="USD">
            <meta itemprop="lowPrice" content="{{ visible_paid_price or 0 }}">
            <meta itemprop="offerCount" content="{{ visible_tiers|length }}">
        </section>

        <section class="plan-panels" aria-label="Plan insights">
            <article class="plan-panel">
                <div class="plan-panel__head">
                    <p class="eyebrow">Key characteristics</p>
                    <h2>Project data</h2>
                </div>
                <div class="spec-grid">
                    <div class="spec-item"><div class="spec-k">Total area</div><div class="spec-v">{% if plan.area_sqft %}{{ plan.area_sqft|round|int }} sq ft{% else %}—{% endif %}{% if plan.area_m2 %}<span class="muted"> · {{ plan.area_m2|round(1) }} m²</span>{% endif %}</div></div>
                    <div class="spec-item"><div class="spec-k">Footprint</div><div class="spec-v">{{ plan.dimensions_summary or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Bedrooms</div><div class="spec-v">{{ plan.bedrooms_count or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Bathrooms</div><div class="spec-v">{{ plan.bathrooms_count or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Levels</div><div class="spec-v">{{ plan.floors_count or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Parking</div><div class="spec-v">{{ plan.parking_count or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Roof</div><div class="spec-v">{{ plan.roof_type or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Structure</div><div class="spec-v">{{ plan.structure_type or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Foundation</div><div class="spec-v">{{ plan.foundation_type or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Ceiling height</div><div class="spec-v">{% if plan.ceiling_height %}{{ plan.ceiling_height }} m{% else %}—{% endif %}</div></div>
                    <div class="spec-item"><div class="spec-k">Complexity</div><div class="spec-v">{{ plan.construction_complexity or '—' }}</div></div>
                    <div class="spec-item"><div class="spec-k">Ideal for</div><div class="spec-v">{{ plan.ideal_for or '—' }}</div></div>
                </div>
            </article>

            <article class="plan-panel">
                <div class="plan-panel__head">
                    <p class="eyebrow">Editorial note</p>
                    <h2>The story of this plan</h2>
                </div>
                <div class="rich-text" itemprop="description">{{ plan.description|default('Description coming soon.', true) | safe }}</div>
            </article>

            {% if plan.design_philosophy or plan.lifestyle_suitability or plan.customization_potential %}
            <article class="plan-panel">
                <div class="plan-panel__head">
                    <p class="eyebrow">Studio depth</p>
                    <h2>How it feels to live here</h2>
                </div>
                <div class="plan-accordion" aria-label="Expandable plan insights">
                    {% if plan.design_philosophy %}
                    <details class="plan-accordion__item" open>
                        <summary>Why it was designed this way</summary>
                        <div class="rich-text">{{ plan.design_philosophy|default('', true) | replace('\n','<br>') | safe }}</div>
                    </details>
                    {% endif %}
                    {% if plan.lifestyle_suitability %}
                    <details class="plan-accordion__item">
                        <summary>What lifestyle it supports</summary>
                        <div class="rich-text">{{ plan.lifestyle_suitability|default('', true) | replace('\n','<br>') | safe }}</div>
                    </details>
                    {% endif %}
                    {% if plan.customization_potential %}
                    <details class="plan-accordion__item">
                        <summary>How it adapts to your needs</summary>
                        <div class="rich-text">{{ plan.customization_potential|default('', true) | replace('\n','<br>') | safe }}</div>
                    </details>
                    {% endif %}
                </div>
            </article>
            {% endif %}

            {% if plan.main_features %}
            <article class="plan-panel">
                <div class="plan-panel__head">
                    <p class="eyebrow">Highlights</p>
                    <h2>Main features</h2>
                </div>
                <div class="rich-text">{{ plan.main_features|default('', true) | replace('\n','<br>') | safe }}</div>
            </article>
            {% endif %}

            {% if plan.room_details %}
            <article class="plan-panel">
                <div class="plan-panel__head">
                    <p class="eyebrow">Layouts</p>
                    <h2>Room-by-room</h2>
                </div>
                <div class="rich-text">{{ plan.room_details|default('', true) | replace('\n','<br>') | safe }}</div>
            </article>
            {% endif %}

            {% if plan.construction_notes or plan.estimated_construction_cost_note %}
            <article class="plan-panel">
                <div class="plan-panel__head">
                    <p class="eyebrow">Site & build</p>
                    <h2>Construction notes</h2>
                </div>
                {% if plan.estimated_construction_cost_note %}
                    <p class="muted">{{ plan.estimated_construction_cost_note }}</p>
                {% endif %}
                {% if plan.construction_notes %}
                    <div class="rich-text">{{ plan.construction_notes|default('', true) | replace('\n','<br>') | safe }}</div>
                {% endif %}
            </article>
            {% endif %}
        </section>

        <section class="plan-faq" aria-labelledby="plan-faq-heading">
            <div class="section-heading">
                <div>
                    <p class="eyebrow">Quick questions</p>
                    <h2 id="plan-faq-heading">Short FAQ so you can keep moving</h2>
                    <p class="muted">Direct answers without jargon.</p>
                </div>
            </div>
            <div class="plan-faq__grid">
                <article>
                    <h3>Can we modify the plans?</h3>
                    <p>Yes. <strong>Pack 3</strong> includes DWG / Revit / IFC files ready for your engineers. We can also recommend partners if needed.</p>
                </article>
                <article>
                    <h3>How are the files delivered?</h3>
                    <p>Downloads come via a secure link (Gumroad or our vault). Files stay accessible even after studio updates.</p>
                </article>
                <article>
                    <h3>What if my climate is different?</h3>
                    <p>{{ plan.suitable_climate or 'Most plans suit temperate or tropical regions; email us to confirm your site constraints.' }}</p>
                </article>
                <article>
                    <h3>What support do I get after purchase?</h3>
                    <p>You can reply to the delivery email or write us directly. We gladly share field notes or adaptation tips.</p>
                </article>
            </div>
        </section>

        <section class="plan-version" aria-labelledby="plan-version-heading">
            <div class="section-heading">
                <div>
                    <p class="eyebrow">Version history</p>
                    <h2 id="plan-version-heading">Release timeline</h2>
                    <p class="muted">Transparent view of how this file set evolves.</p>
                </div>
            </div>
            <ul>
                <li>Last update · {{ plan.updated_at.strftime('%B %d, %Y') if plan.updated_at else 'To confirm' }}</li>
                <li>First publication · {{ plan.created_at.strftime('%B %d, %Y') if plan.created_at else 'To confirm' }}</li>
                <li>File reference · {{ plan.reference_code }}</li>
            </ul>
        </section>

        <section class="plan-related plan-related--history" aria-labelledby="recently-heading" data-recently-section hidden>
            <div class="section-heading">
                <div>
                    <p class="eyebrow">Continue exploring</p>
                    <h2 id="recently-heading">Recently viewed</h2>
                    <p class="muted" data-recently-empty>Plans you open will show up here for quick access.</p>
                </div>
            </div>
            <div class="plan-grid plan-grid--scroll plan-related__grid" data-recently-grid data-recently-limit="6"></div>
        </section>

        {% if similar_plans %}
        <section class="plan-related" aria-label="Similar plans" data-similar-section data-similar-static="true">
            <div class="section-heading">
                <div>
                    <p class="eyebrow">You might also like</p>
                    <h2>Similar layouts</h2>
                    <p class="muted">We matched these using categories, bedroom count, and footprint.</p>
                </div>
            </div>
            <div class="plan-grid plan-grid--catalog plan-related__grid">
                {% with plans=similar_plans %}
                    {% include "_plan_cards.html" with context %}
                {% endwith %}
            </div>
        </section>
        {% endif %}

        {% set sticky_primary_url = None %}
        {% set sticky_primary_label = None %}
        {% if pack_visibility.get(2) and plan.gumroad_pack_2_url %}
            {% set sticky_primary_url = url_for('main.gumroad_redirect', slug=plan_slug, pack=2) %}
            {% set sticky_primary_label = 'Buy Pack 02' %}
        {% elif pack_visibility.get(3) and plan.gumroad_pack_3_url %}
            {% set sticky_primary_url = url_for('main.gumroad_redirect', slug=plan_slug, pack=3) %}
            {% set sticky_primary_label = 'Buy Pack 03' %}
        {% endif %}
        <div class="sticky-cta" aria-label="Primary actions">
            <div>
                <strong>{{ plan_title }}</strong>
                <span class="muted">Ref {{ plan_ref }}</span>
            </div>
            <div class="sticky-cta__actions">
                {% if pack_visibility.get(1) and plan.has_free_download %}
                    <a class="btn btn-outline" href="{{ url_for('main.download_free', plan_id=plan.id) }}">Free PDF</a>
                {% endif %}
                {% if sticky_primary_url %}
                    <a class="btn btn-primary" href="{{ sticky_primary_url }}">{{ sticky_primary_label }}</a>
                {% else %}
                    <a class="btn btn-primary" href="{{ url_for('main.contact') }}">Talk to us</a>
                {% endif %}
            </div>
        </div>
    </article>
</div>
{% endblock %}