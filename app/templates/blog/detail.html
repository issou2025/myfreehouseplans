{% extends "base.html" %}

{% block title %}{{ meta.title if meta else post.title }}{% endblock %}

{% block meta_robots %}
        {% set _seo = (extras or {}).get('seo', {}) if extras is defined else {} %}
        {{ _seo.get('robots', 'index,follow') }}
{% endblock %}

{% block structured_data %}
        {% set _faq = (extras or {}).get('faq', []) if extras is defined else [] %}
        {% if _faq and _faq|length > 0 %}
                <script type="application/ld+json">
                {
                    "@context": "https://schema.org",
                    "@type": "FAQPage",
                    "mainEntity": [
                        {% for item in _faq %}
                        {
                            "@type": "Question",
                            "name": {{ (item.get('question','')|string)|tojson }},
                            "acceptedAnswer": {
                                "@type": "Answer",
                                "text": {{ (item.get('answer','')|string)|tojson }}
                            }
                        }{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ]
                }
                </script>
        {% endif %}
{% endblock %}

{% block content %}
<div class="reading-progress" aria-hidden="true">
    <span class="reading-progress__bar" data-reading-progress></span>
</div>

<section class="section blog-article" aria-labelledby="article-heading">
    <div class="shell blog-article__layout">
        {% set _extras = extras if extras is defined else {} %}
        {% set _aff = (_extras or {}).get('affiliate', {}) %}
        {% set _img = (_extras or {}).get('images', {}) %}
        {% set _media = (_extras or {}).get('media', {}) %}
        {% set _recs_all = (_extras or {}).get('recommendations', []) %}
        {% set ns = namespace(recs=[]) %}
        {% for rec in (_recs_all if _recs_all else []) %}
            {% if rec and rec.get('active', True) and rec.get('url') and rec.get('title') %}
                {% set ns.recs = ns.recs + [rec] %}
            {% endif %}
        {% endfor %}
        {% set _recs = ns.recs[:3] %}
        {% set _has_recs = _recs and _recs|length > 0 %}
        {% set _faq = (_extras or {}).get('faq', []) %}

        <article class="blog-article__main" itemscope itemtype="https://schema.org/Article">
            <header class="blog-article__header">
                <p class="eyebrow"><i class="fa-solid fa-book-open" aria-hidden="true"></i> Editorial</p>
                <h1 id="article-heading" itemprop="headline">{{ post.title }}</h1>
                <p class="blog-article__meta">{{ post.created_at.strftime('%B %d, %Y') }}</p>
            </header>

            {% if post.cover_image %}
                <figure class="blog-article__cover">
                    <img src="{{ upload_url(post.cover_image) }}" alt="{{ post.title }}" loading="lazy" decoding="async" itemprop="image">
                </figure>
            {% elif (_media or {}).get('featured', {}).get('url') %}
                {% set _f = (_media or {}).get('featured', {}) %}
                <figure class="blog-article__cover">
                    <img src="{{ _f.get('url') }}" alt="{{ _f.get('alt') or post.title }}" loading="lazy" decoding="async" itemprop="image">
                    {% if _f.get('caption') %}
                        <figcaption style="opacity:.85; margin-top:.35rem;">{{ _f.get('caption') }}</figcaption>
                    {% endif %}
                </figure>
            {% elif _img.get('featured') %}
                <figure class="blog-article__cover">
                    <img src="{{ _img.get('featured') }}" alt="{{ post.title }}" loading="lazy" decoding="async" itemprop="image">
                </figure>
            {% endif %}

            {% if (not _has_recs) and _aff and _aff.get('affiliate_url') and (_aff.get('display_position','after') == 'before') %}
                <section class="blog-affiliate" aria-label="Recommended product">
                    <div class="blog-affiliate__card">
                        <p class="eyebrow"><i class="fa-solid fa-bag-shopping" aria-hidden="true"></i> Recommended</p>
                        <h2 class="blog-affiliate__title">{{ _aff.get('product_title') or 'Recommended product' }}</h2>
                        {% if _aff.get('short_description') %}
                            <p class="blog-affiliate__desc">{{ _aff.get('short_description') }}</p>
                        {% endif %}
                        <a class="btn btn-primary" href="{{ _aff.get('affiliate_url') }}" target="_blank" rel="sponsored noopener noreferrer">
                            {{ _aff.get('button_text') or 'Learn more' }}
                        </a>
                    </div>
                </section>
            {% endif %}

                <div class="blog-article__content" itemprop="articleBody">
                    {{ post.content|safe }}
                </div>

            {% if (not _has_recs) and _aff and _aff.get('affiliate_url') and (_aff.get('display_position','after') != 'before') %}
                <section class="blog-affiliate" aria-label="Recommended product">
                    <div class="blog-affiliate__card">
                        <p class="eyebrow"><i class="fa-solid fa-bag-shopping" aria-hidden="true"></i> Recommended</p>
                        <h2 class="blog-affiliate__title">{{ _aff.get('product_title') or 'Recommended product' }}</h2>
                        {% if _aff.get('short_description') %}
                            <p class="blog-affiliate__desc">{{ _aff.get('short_description') }}</p>
                        {% endif %}
                        <a class="btn btn-primary" href="{{ _aff.get('affiliate_url') }}" target="_blank" rel="sponsored noopener noreferrer">
                            {{ _aff.get('button_text') or 'Learn more' }}
                        </a>
                    </div>
                </section>
            {% endif %}

            {% if (_media or {}).get('gallery') and (_media or {}).get('gallery')|length > 0 %}
                <section class="blog-gallery" aria-label="Gallery">
                    <h2 class="blog-gallery__title">Gallery</h2>
                    <div class="blog-gallery__grid">
                        {% for img in (_media or {}).get('gallery') %}
                            {% if img and img.get('url') %}
                                <figure class="blog-gallery__item">
                                    <img src="{{ img.get('url') }}" alt="{{ img.get('alt') or post.title }}" loading="lazy" decoding="async">
                                    {% if img.get('caption') %}
                                        <figcaption style="opacity:.85; padding:.5rem .75rem;">{{ img.get('caption') }}</figcaption>
                                    {% endif %}
                                </figure>
                            {% endif %}
                        {% endfor %}
                    </div>
                </section>
            {% elif _img.get('gallery') and _img.get('gallery')|length > 0 %}
                <section class="blog-gallery" aria-label="Gallery">
                    <h2 class="blog-gallery__title">Gallery</h2>
                    <div class="blog-gallery__grid">
                        {% for src in _img.get('gallery') %}
                            <figure class="blog-gallery__item">
                                <img src="{{ src }}" alt="{{ post.title }}" loading="lazy" decoding="async">
                            </figure>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            {% if _faq and _faq|length > 0 %}
                <section class="blog-faq" aria-label="Frequently asked questions">
                    <h2>FAQ</h2>
                    <div class="blog-faq__list">
                        {% for item in _faq %}
                            {% if item.get('question') and item.get('answer') %}
                                <details class="blog-faq__item">
                                    <summary>{{ item.get('question') }}</summary>
                                    <div class="blog-faq__answer">
                                        {{ item.get('answer') }}
                                    </div>
                                </details>
                            {% endif %}
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            {% if _has_recs %}
                <section class="blog-recs" aria-label="Recommendations">
                    <h2 class="blog-recs__title">Recommendations</h2>
                    <div class="blog-recs__list">
                        {% for rec in _recs %}
                            <div class="blog-affiliate__card">
                                <p class="eyebrow"><i class="fa-solid fa-bag-shopping" aria-hidden="true"></i> Recommended</p>
                                <h3 class="blog-affiliate__title">{{ rec.get('title') }}</h3>
                                {% if rec.get('justification') %}
                                    <p class="blog-affiliate__desc">{{ rec.get('justification') }}</p>
                                {% endif %}
                                <a class="btn btn-primary" href="{{ rec.get('url') }}" target="_blank" rel="sponsored noopener noreferrer">Learn more</a>
                            </div>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            {% if post.linked_plan %}
            <section class="blog-cta" aria-label="Linked plan">
                <div class="blog-cta__content">
                    <p class="eyebrow"><i class="fa-solid fa-tag" aria-hidden="true"></i> Featured Plan</p>
                    <h2>{{ post.linked_plan.title }}</h2>
                    <p>{{ post.linked_plan.short_description or post.linked_plan.description }}</p>
                    {% set starting_price = visible_starting_price(post.linked_plan.pricing_tiers, pack_visibility) %}
                    <div class="blog-cta__price">
                        <span class="badge badge--outline">{{ post.linked_plan.reference_code }}</span>
                        <strong>{% if starting_price %}From ${{ starting_price|round(0)|int }}{% else %}Free{% endif %}</strong>
                    </div>
                    <div class="blog-cta__actions">
                        <a class="btn btn-primary" href="{{ url_for('main.pack_detail', slug=post.linked_plan.slug) }}">Buy plan</a>
                        <a class="btn btn-ghost" href="{{ url_for('main.packs') }}">Browse all plans</a>
                    </div>
                </div>
                {% if post.linked_plan.cover_image or post.linked_plan.main_image %}
                <div class="blog-cta__media">
                    {% set plan_image = post.linked_plan.cover_image or post.linked_plan.main_image %}
                    <img src="{{ upload_url(plan_image) }}" alt="{{ post.linked_plan.title }}" loading="lazy" decoding="async">
                </div>
                {% endif %}
            </section>
            {% endif %}
        </article>

        <aside class="blog-article__aside" aria-label="Sidebar">
            <div class="aside-card">
                <h3>Most popular plans</h3>
                <ul class="blog-aside-list">
                    {% for plan in popular_plans %}
                    <li>
                        <a href="{{ url_for('main.pack_detail', slug=plan.slug) }}">{{ plan.title }}</a>
                        <span>{{ plan.reference_code }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </aside>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const bar = document.querySelector('[data-reading-progress]');
        if (!bar) return;
        function update() {
            const doc = document.documentElement;
            const scrollTop = doc.scrollTop || document.body.scrollTop;
            const scrollHeight = doc.scrollHeight - doc.clientHeight;
            const percent = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            bar.style.width = `${percent}%`;
        }
        document.addEventListener('scroll', update, { passive: true });
        window.addEventListener('resize', update);
        update();
    })();
</script>
{% endblock %}
