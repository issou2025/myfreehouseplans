{% extends "base.html" %}

{% block title %}{{ meta.title if meta else post.title }}{% endblock %}

{% block meta_robots %}
        {% set _seo = (extras or {}).get('seo', {}) if extras is defined else {} %}
        {{ _seo.get('robots', 'index,follow') }}
{% endblock %}

{% block structured_data %}
        {% set _faq = (extras or {}).get('faq', []) if extras is defined else [] %}
        {% if _faq and _faq|length > 0 %}
                <script type="application/ld+json">
                {
                    "@context": "https://schema.org",
                    "@type": "FAQPage",
                    "mainEntity": [
                        {% for item in _faq %}
                        {
                            "@type": "Question",
                            "name": {{ (item.get('question','')|string)|tojson }},
                            "acceptedAnswer": {
                                "@type": "Answer",
                                "text": {{ (item.get('answer','')|string)|tojson }}
                            }
                        }{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ]
                }
                </script>
        {% endif %}
{% endblock %}

{% block content %}
<div class="reading-progress" aria-hidden="true">
    <span class="reading-progress__bar" data-reading-progress></span>
</div>

<section class="section blog-article" aria-labelledby="article-heading">
    <div class="shell blog-article__layout">
        {% set _extras = extras if extras is defined else {} %}
        {% set _aff = (_extras or {}).get('affiliate', {}) %}
        {% set _img = (_extras or {}).get('images', {}) %}
        {% set _media = (_extras or {}).get('media', {}) %}
        {% set _recs_all = (_extras or {}).get('recommendations', []) %}
        {% set ns = namespace(recs=[]) %}
        {% for rec in (_recs_all if _recs_all else []) %}
            {% if rec and rec.get('active', True) and rec.get('url') and rec.get('title') %}
                {% set ns.recs = ns.recs + [rec] %}
            {% endif %}
        {% endfor %}
        {% set _recs = ns.recs[:3] %}
        {% set _has_recs = _recs and _recs|length > 0 %}
        {% set _faq = (_extras or {}).get('faq', []) %}
        {% set _summary = post.meta_description or ((_extras or {}).get('seo', {}) or {}).get('meta_description') %}

        <article class="blog-article__main" itemscope itemtype="https://schema.org/Article">
            <header class="blog-article__header">
                <p class="eyebrow"><i class="fa-solid fa-book-open" aria-hidden="true"></i> Editorial</p>
                <h1 id="article-heading" itemprop="headline">{{ post.title }}</h1>
                <div class="blog-article__meta-row">
                    <span class="blog-article__meta-pill">{{ post.created_at.strftime('%B %d, %Y') }}</span>
                    <span class="blog-article__meta-pill" data-reading-time>Estimated reading time</span>
                    <button class="blog-article__favorite-btn" type="button" data-favorite-article aria-label="Save article">
                        <i class="fa-regular fa-heart" aria-hidden="true"></i>
                        <span>Save</span>
                    </button>
                </div>
                <div class="blog-share" role="group" aria-label="Share this article">
                    <a class="blog-share__btn" href="#" data-share="twitter" target="_blank" rel="noopener noreferrer" aria-label="Share on X">
                        <i class="fa-brands fa-x-twitter" aria-hidden="true"></i>
                        <span>Share</span>
                    </a>
                    <a class="blog-share__btn" href="#" data-share="linkedin" target="_blank" rel="noopener noreferrer" aria-label="Share on LinkedIn">
                        <i class="fa-brands fa-linkedin" aria-hidden="true"></i>
                        <span>LinkedIn</span>
                    </a>
                    <a class="blog-share__btn" href="#" data-share="facebook" target="_blank" rel="noopener noreferrer" aria-label="Share on Facebook">
                        <i class="fa-brands fa-facebook" aria-hidden="true"></i>
                        <span>Facebook</span>
                    </a>
                    <button class="blog-share__btn" type="button" data-share="copy" aria-label="Copy link">
                        <i class="fa-regular fa-copy" aria-hidden="true"></i>
                        <span>Copy link</span>
                    </button>
                </div>
            </header>

            {% if _summary %}
                <div class="blog-article__summary" aria-label="Article summary">
                    <div class="blog-article__summary-icon" aria-hidden="true">
                        <i class="fa-solid fa-lightbulb"></i>
                    </div>
                    <div class="blog-article__summary-body">
                        <p class="eyebrow">Quick summary</p>
                        <p>{{ _summary }}</p>
                    </div>
                </div>
            {% endif %}

            <div class="blog-author-bio">
                <div class="blog-author-bio__avatar">
                    <img src="{{ url_for('static', filename='images/placeholder.svg') }}" alt="Author" loading="lazy">
                </div>
                <div class="blog-author-bio__content">
                    <h3>Written by MyFreeHousePlans Team</h3>
                    <p>Expert architects and designers sharing insights on house planning, construction, and home design trends.</p>
                    <div class="blog-author-bio__social">
                        <a href="#" aria-label="Follow on Twitter"><i class="fa-brands fa-x-twitter"></i></a>
                        <a href="#" aria-label="Follow on LinkedIn"><i class="fa-brands fa-linkedin"></i></a>
                    </div>
                </div>
            </div>

            {% if related_experience %}
                <section class="blog-cta" aria-label="Apply this to your room" style="margin: 1rem 0 1.25rem 0;">
                    <div class="blog-cta__content">
                        <p class="eyebrow"><i class="fa-solid fa-compass" aria-hidden="true"></i> Space planning</p>
                        <h2 style="margin: 0 0 .5rem 0;">{{ related_experience.heading }}</h2>
                        <p style="margin: 0 0 1rem 0;">{{ related_experience.body }}</p>
                        <div class="blog-cta__actions">
                            <a class="btn btn-primary" href="{{ related_experience.href }}">{{ related_experience.cta }}</a>
                            <a class="btn btn-ghost" href="{{ url_for('space_planner.index') }}">Browse Space Planner</a>
                        </div>
                    </div>
                </section>
            {% endif %}

            {% if tool_links %}
                <section class="blog-cta blog-tool-links" aria-label="Apply this with a planning tool">
                    <div class="blog-cta__content">
                        <p class="eyebrow"><i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i> Helpful tools</p>
                        <h2 class="blog-tool-links__title">Turn this article into a plan</h2>
                        <div class="blog-tool-links__grid">
                            {% for tool in tool_links %}
                                <div class="blog-tool-links__card">
                                    <h3>{{ tool.label }}</h3>
                                    <p class="blog-tool-links__desc">{{ tool.body }}</p>
                                    <a class="btn btn-primary" href="{{ tool.href }}">{{ tool.cta }}</a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </section>
            {% endif %}

            {% if post.cover_image %}
                <figure class="blog-article__cover">
                    <img src="{{ upload_url(post.cover_image) }}" alt="{{ post.title }}" loading="lazy" decoding="async" itemprop="image">
                </figure>
            {% elif (_media or {}).get('featured', {}).get('url') %}
                {% set _f = (_media or {}).get('featured', {}) %}
                <figure class="blog-article__cover">
                    <img src="{{ _f.get('url') }}" alt="{{ _f.get('alt') or post.title }}" loading="lazy" decoding="async" itemprop="image">
                    {% if _f.get('caption') %}
                        <figcaption>{{ _f.get('caption') }}</figcaption>
                    {% endif %}
                </figure>
            {% elif _img.get('featured') %}
                <figure class="blog-article__cover">
                    <img src="{{ _img.get('featured') }}" alt="{{ post.title }}" loading="lazy" decoding="async" itemprop="image">
                </figure>
            {% endif %}

            <nav class="blog-toc blog-toc--inline" aria-label="Table of contents" data-toc>
                <h2 class="blog-toc__title">On this page</h2>
                <ul class="blog-toc__list" data-toc-list></ul>
            </nav>

            {% if (not _has_recs) and _aff and _aff.get('affiliate_url') and (_aff.get('display_position','after') == 'before') %}
                <section class="blog-affiliate" aria-label="Recommended product">
                    <div class="blog-affiliate__card">
                        <p class="eyebrow"><i class="fa-solid fa-bag-shopping" aria-hidden="true"></i> Recommended</p>
                        <h2 class="blog-affiliate__title">{{ _aff.get('product_title') or 'Recommended product' }}</h2>
                        {% if _aff.get('short_description') %}
                            <p class="blog-affiliate__desc">{{ _aff.get('short_description') }}</p>
                        {% endif %}
                        <a class="btn btn-primary" href="{{ _aff.get('affiliate_url') }}" target="_blank" rel="sponsored noopener noreferrer">
                            {{ _aff.get('button_text') or 'Learn more' }}
                        </a>
                    </div>
                </section>
            {% endif %}

                <div class="blog-article__content" itemprop="articleBody">
                    {{ post.content|safe }}
                </div>

            {% if (not _has_recs) and _aff and _aff.get('affiliate_url') and (_aff.get('display_position','after') != 'before') %}
                <section class="blog-affiliate" aria-label="Recommended product">
                    <div class="blog-affiliate__card">
                        <p class="eyebrow"><i class="fa-solid fa-bag-shopping" aria-hidden="true"></i> Recommended</p>
                        <h2 class="blog-affiliate__title">{{ _aff.get('product_title') or 'Recommended product' }}</h2>
                        {% if _aff.get('short_description') %}
                            <p class="blog-affiliate__desc">{{ _aff.get('short_description') }}</p>
                        {% endif %}
                        <a class="btn btn-primary" href="{{ _aff.get('affiliate_url') }}" target="_blank" rel="sponsored noopener noreferrer">
                            {{ _aff.get('button_text') or 'Learn more' }}
                        </a>
                    </div>
                </section>
            {% endif %}

            {% if (_media or {}).get('gallery') and (_media or {}).get('gallery')|length > 0 %}
                <section class="blog-gallery" aria-label="Gallery">
                    <h2 class="blog-gallery__title">Gallery</h2>
                    <div class="blog-gallery__grid">
                        {% for img in (_media or {}).get('gallery') %}
                            {% if img and img.get('url') %}
                                <figure class="blog-gallery__item">
                                    <img src="{{ img.get('url') }}" alt="{{ img.get('alt') or post.title }}" loading="lazy" decoding="async">
                                    {% if img.get('caption') %}
                                        <figcaption style="opacity:.85; padding:.5rem .75rem;">{{ img.get('caption') }}</figcaption>
                                    {% endif %}
                                </figure>
                            {% endif %}
                        {% endfor %}
                    </div>
                </section>
            {% elif _img.get('gallery') and _img.get('gallery')|length > 0 %}
                <section class="blog-gallery" aria-label="Gallery">
                    <h2 class="blog-gallery__title">Gallery</h2>
                    <div class="blog-gallery__grid">
                        {% for src in _img.get('gallery') %}
                            <figure class="blog-gallery__item">
                                <img src="{{ src }}" alt="{{ post.title }}" loading="lazy" decoding="async">
                            </figure>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            {% if _faq and _faq|length > 0 %}
                <section class="blog-faq" aria-label="Frequently asked questions">
                    <h2>FAQ</h2>
                    <div class="blog-faq__list">
                        {% for item in _faq %}
                            {% if item.get('question') and item.get('answer') %}
                                <details class="blog-faq__item">
                                    <summary>{{ item.get('question') }}</summary>
                                    <div class="blog-faq__answer">
                                        {{ item.get('answer') }}
                                    </div>
                                </details>
                            {% endif %}
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            {% if _has_recs %}
                <section class="blog-recs" aria-label="Recommendations">
                    <h2 class="blog-recs__title">Recommendations</h2>
                    <div class="blog-recs__list">
                        {% for rec in _recs %}
                            <div class="blog-affiliate__card">
                                <p class="eyebrow"><i class="fa-solid fa-bag-shopping" aria-hidden="true"></i> Recommended</p>
                                <h3 class="blog-affiliate__title">{{ rec.get('title') }}</h3>
                                {% if rec.get('justification') %}
                                    <p class="blog-affiliate__desc">{{ rec.get('justification') }}</p>
                                {% endif %}
                                <a class="btn btn-primary" href="{{ rec.get('url') }}" target="_blank" rel="sponsored noopener noreferrer">Learn more</a>
                            </div>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            {% if post.linked_plan %}
            <section class="blog-cta" aria-label="Linked plan">
                <div class="blog-cta__content">
                    <p class="eyebrow"><i class="fa-solid fa-tag" aria-hidden="true"></i> Featured Plan</p>
                    <h2>{{ post.linked_plan.title }}</h2>
                    <p>{{ post.linked_plan.short_description or post.linked_plan.description }}</p>
                    {% set starting_price = visible_starting_price(post.linked_plan.pricing_tiers, pack_visibility) %}
                    <div class="blog-cta__price">
                        <span class="badge badge--outline">{{ post.linked_plan.reference_code }}</span>
                        <strong>{% if starting_price %}From ${{ starting_price|round(0)|int }}{% else %}Free{% endif %}</strong>
                    </div>
                    <div class="blog-cta__actions">
                        <a class="btn btn-primary" href="{{ url_for('main.pack_detail', slug=post.linked_plan.slug) }}">Buy plan</a>
                        <a class="btn btn-ghost" href="{{ url_for('main.packs') }}">Browse all plans</a>
                    </div>
                </div>
                {% if post.linked_plan.cover_image or post.linked_plan.main_image %}
                <div class="blog-cta__media">
                    {% set plan_image = post.linked_plan.cover_image or post.linked_plan.main_image %}
                    <img src="{{ upload_url(plan_image) }}" alt="{{ post.linked_plan.title }}" loading="lazy" decoding="async">
                </div>
                {% endif %}
            </section>
            {% endif %}

            <section class="blog-newsletter" aria-label="Newsletter signup">
                <div class="blog-newsletter__content">
                    <h2>Stay Updated</h2>
                    <p>Get the latest house plans, design tips, and construction insights delivered to your inbox.</p>
                    <form class="blog-newsletter__form" action="#" method="post">
                        <input type="email" name="email" placeholder="Enter your email" required>
                        <button type="submit" class="btn btn-primary">Subscribe</button>
                    </form>
                </div>
            </section>

            <section class="blog-related" aria-label="Related content">
                <h2>You might also like</h2>
                <div class="blog-related__grid">
                    {% for plan in popular_plans[:3] %}
                    <article class="blog-related__item">
                        {% set card_image = plan.cover_image or plan.main_image %}
                        <a href="{{ url_for('main.pack_detail', slug=plan.slug) }}" class="blog-related__link">
                            {% if card_image %}
                            <img src="{{ upload_url(card_image) }}" alt="{{ plan.title }}" loading="lazy" decoding="async">
                            {% endif %}
                            <h3>{{ plan.title }}</h3>
                            <p>{{ plan.short_description or plan.description|truncate(100) }}</p>
                            <span class="badge badge--outline">{{ plan.reference_code }}</span>
                        </a>
                    </article>
                    {% endfor %}
                </div>
            </section>
        </article>

        <aside class="blog-article__aside" aria-label="Sidebar">
            <div class="aside-card blog-toc blog-toc--aside" aria-label="Table of contents" data-toc>
                <h3 class="blog-toc__title">On this page</h3>
                <ul class="blog-toc__list" data-toc-list></ul>
            </div>
            <div class="aside-card blog-share-card" aria-label="Share this article">
                <h3>Share</h3>
                <div class="blog-share blog-share--stack">
                    <a class="blog-share__btn" href="#" data-share="twitter" target="_blank" rel="noopener noreferrer" aria-label="Share on X">
                        <i class="fa-brands fa-x-twitter" aria-hidden="true"></i>
                        <span>Share</span>
                    </a>
                    <a class="blog-share__btn" href="#" data-share="linkedin" target="_blank" rel="noopener noreferrer" aria-label="Share on LinkedIn">
                        <i class="fa-brands fa-linkedin" aria-hidden="true"></i>
                        <span>LinkedIn</span>
                    </a>
                    <a class="blog-share__btn" href="#" data-share="facebook" target="_blank" rel="noopener noreferrer" aria-label="Share on Facebook">
                        <i class="fa-brands fa-facebook" aria-hidden="true"></i>
                        <span>Facebook</span>
                    </a>
                    <button class="blog-share__btn" type="button" data-share="copy" aria-label="Copy link">
                        <i class="fa-regular fa-copy" aria-hidden="true"></i>
                        <span>Copy link</span>
                    </button>
                </div>
            </div>
            <div class="aside-card">
                <h3>Most popular plans</h3>
                <ul class="blog-aside-list">
                    {% for plan in popular_plans %}
                    <li>
                        <a href="{{ url_for('main.pack_detail', slug=plan.slug) }}">{{ plan.title }}</a>
                        <span>{{ plan.reference_code }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </aside>
    </div>
</section>

<button class="back-to-top" type="button" data-back-to-top aria-label="Back to top">
    <i class="fa-solid fa-arrow-up" aria-hidden="true"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const bar = document.querySelector('[data-reading-progress]');
        const content = document.querySelector('.blog-article__content');
        const readingTimeEl = document.querySelector('[data-reading-time]');
        const backToTop = document.querySelector('[data-back-to-top]');
        const tocContainers = document.querySelectorAll('[data-toc]');
        const shareButtons = document.querySelectorAll('[data-share]');

        function updateProgress() {
            if (!bar) return;
            const doc = document.documentElement;
            const scrollTop = doc.scrollTop || document.body.scrollTop;
            const scrollHeight = doc.scrollHeight - doc.clientHeight;
            const percent = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            bar.style.width = `${percent}%`;
        }

        function updateBackToTop() {
            if (!backToTop) return;
            const show = window.scrollY > 500;
            backToTop.classList.toggle('is-visible', show);
        }

        function initReadingTime() {
            if (!content || !readingTimeEl) return;
            const text = content.textContent || '';
            const words = text.trim().split(/\s+/).filter(Boolean).length;
            const minutes = Math.max(1, Math.ceil(words / 220));
            readingTimeEl.textContent = `${minutes} min read`;
        }

        function initToc() {
            if (!content || !tocContainers.length) return;
            const headings = content.querySelectorAll('h2, h3');
            if (!headings.length) {
                tocContainers.forEach(container => container.classList.add('is-empty'));
                return;
            }
            headings.forEach((heading, index) => {
                if (!heading.id) {
                    heading.id = `section-${index + 1}`;
                }
            });
            tocContainers.forEach(container => {
                const list = container.querySelector('[data-toc-list]');
                if (!list) return;
                list.innerHTML = '';
                headings.forEach(heading => {
                    const li = document.createElement('li');
                    li.className = `toc-item toc-${heading.tagName.toLowerCase()}`;
                    const link = document.createElement('a');
                    link.href = `#${heading.id}`;
                    link.textContent = heading.textContent || '';
                    li.appendChild(link);
                    list.appendChild(li);
                });
            });
        }

        function initShare() {
            if (!shareButtons.length) return;
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            shareButtons.forEach(btn => {
                const platform = btn.getAttribute('data-share');
                if (platform === 'twitter') {
                    btn.href = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
                }
                if (platform === 'linkedin') {
                    btn.href = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
                }
                if (platform === 'facebook') {
                    btn.href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                }
                if (platform === 'copy') {
                    btn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(window.location.href);
                            btn.classList.add('is-copied');
                            setTimeout(() => btn.classList.remove('is-copied'), 1500);
                        } catch (err) {
                            window.prompt('Copy this link:', window.location.href);
                        }
                    });
                }
            });
        }

        function initFavorite() {
            const favoriteBtn = document.querySelector('[data-favorite-article]');
            if (!favoriteBtn) return;
            
            // Check if already favorited (from localStorage or user data)
            const articleId = '{{ post.id }}';
            const isFavorited = localStorage.getItem(`favorite-article-${articleId}`) === 'true';
            if (isFavorited) {
                favoriteBtn.classList.add('is-favorited');
            }
            
            favoriteBtn.addEventListener('click', () => {
                const currentlyFavorited = favoriteBtn.classList.contains('is-favorited');
                if (currentlyFavorited) {
                    favoriteBtn.classList.remove('is-favorited');
                    localStorage.removeItem(`favorite-article-${articleId}`);
                } else {
                    favoriteBtn.classList.add('is-favorited');
                    localStorage.setItem(`favorite-article-${articleId}`, 'true');
                }
                // Here you could send to server for persistent storage
            });
        }

        document.addEventListener('scroll', () => {
            updateProgress();
            updateBackToTop();
        }, { passive: true });
        window.addEventListener('resize', updateProgress);
        if (backToTop) {
            backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        }
        initReadingTime();
        initToc();
        initShare();
        initFavorite();
        updateProgress();
        updateBackToTop();
    })();
</script>
{% endblock %}
