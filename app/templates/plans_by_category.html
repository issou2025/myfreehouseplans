{% extends "base.html" %}

{% block structured_data %}
{% if category_schema %}
<script type="application/ld+json">{{ category_schema | tojson | safe }}</script>
{% endif %}
{% endblock %}

{% block content %}
<div class="shell">
    <header class="section-heading">
        <div>
            <p class="eyebrow">Category</p>
            <h1>{{ category.name }}</h1>
            {% if category.description %}
                <p class="lead">{{ category.description }}</p>
            {% else %}
                <p class="lead">A focused group of plans sharing similar proportions, daylight strategies, and detailing.</p>
            {% endif %}
        </div>
    </header>

    {% if categories %}
    <nav class="category-nav" aria-label="Browse categories">
        {% for c in categories %}
            <a class="category-chip {% if c.id == category.id %}is-active{% endif %}" href="{{ url_for('main.plans_by_category', slug=c.slug) }}">{{ c.name }}</a>
        {% endfor %}
    </nav>
    {% endif %}

    {% if plans %}
        <div class="plan-grid plan-grid--catalog">
            {% for plan in plans %}
            <article class="plan-card" itemscope itemtype="https://schema.org/Product">
                <a class="plan-card__media" href="{{ url_for('main.pack_detail', slug=plan.slug) }}" itemprop="url">
                    {% set card_image = plan.cover_image or plan.main_image %}
                    {% if card_image %}
                        {{ picture_tag(card_image, alt=plan.title, preset=CARD_PRESET, variant='base', loading='lazy', decoding='async', itemprop='image') }}
                    {% else %}
                        <div class="plan-card__placeholder">Visual coming soon</div>
                    {% endif %}
                    <div class="plan-card__labels">
                        {% if plan.is_featured %}<span class="badge badge--glow">Featured</span>{% endif %}
                        {% if plan.is_on_sale %}<span class="badge badge--outline">On sale</span>{% endif %}
                    </div>
                </a>
                <div class="plan-card__body">
                    <p class="plan-card__eyebrow">
                        {% if plan.categories %}
                            {% for c in plan.categories %}
                                <a href="{{ url_for('main.plans_by_category', slug=c.slug) }}">{{ c.name }}</a>{% if not loop.last %} Â· {% endif %}
                            {% endfor %}
                        {% else %}
                            Residential
                        {% endif %}
                    </p>
                    <h3 itemprop="name"><a href="{{ url_for('main.pack_detail', slug=plan.slug) }}">{{ plan.title }}</a></h3>
                    <p class="plan-card__summary" itemprop="description">{{ plan.architectural_summary }}</p>
                    <dl class="plan-card__specs" aria-label="Key characteristics">
                        {% if plan.area_sqft %}<div><dt>Area</dt><dd>{{ plan.area_sqft|round|int }} sq ft</dd></div>{% endif %}
                        {% if plan.bedrooms_count %}<div><dt>Beds</dt><dd>{{ plan.bedrooms_count }}</dd></div>{% endif %}
                        {% if plan.bathrooms_count %}<div><dt>Baths</dt><dd>{{ plan.bathrooms_count }}</dd></div>{% endif %}
                        {% if plan.floors_count %}<div><dt>Levels</dt><dd>{{ plan.floors_count }}</dd></div>{% endif %}
                    </dl>
                    {% set visible_tiers = filter_pack_tiers(plan.pricing_tiers, pack_visibility) %}
                    {% if visible_tiers %}
                    <div class="plan-card__tiers" aria-label="Pack pricing overview">
                        {% for tier in visible_tiers %}
                        <div class="plan-card__tier {% if not tier.available %}plan-card__tier--muted{% endif %}">
                            <span>Pack 0{{ tier.pack }}</span>
                            <span>
                                {% if tier.price and tier.price > 0 %}
                                    ${{ tier.price|round(0)|int }}
                                {% elif tier.pack == 1 %}
                                    Free
                                {% else %}
                                    Forthcoming
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <div class="plan-card__footer" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                        <div class="plan-card__price">
                            {% if plan.is_on_sale %}
                                <span class="price price--strike">${{ plan.price }}</span>
                                <span class="price price--primary" itemprop="price">${{ plan.current_price }}</span>
                            {% else %}
                                <span class="price price--primary" itemprop="price">${{ plan.current_price }}</span>
                            {% endif %}
                            <meta itemprop="priceCurrency" content="USD">
                        </div>
                        <div class="plan-card__cta">
                            <a href="{{ url_for('main.pack_detail', slug=plan.slug) }}" class="btn btn-soft" aria-label="View plan {{ plan.title }}">View plan</a>
                            <a class="text-link" href="{{ url_for('main.contact') }}">Ask about this set</a>
                        </div>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <p>No plans found in this category yet.</p>
            <a href="{{ url_for('main.packs') }}" class="btn btn-outline">Browse all plans</a>
        </div>
    {% endif %}
</div>
{% endblock %}
