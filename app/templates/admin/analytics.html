{% extends "base.html" %}

{% block content %}
<div class="shell admin-shell">
    <header class="admin-header">
        <div class="admin-header__content">
            <p class="admin-eyebrow">üõ°Ô∏è Smart Analytics</p>
            <h1 class="admin-title">Traffic &amp; security overview</h1>
            <p class="admin-subtitle">Signal-over-noise analytics: humans, SEO bots, and blocked probe attacks. Recent logs are retained briefly; daily stats stay compact.</p>
            {% if cleanup_ran %}
                <p class="admin-subtitle" style="margin-top: 8px; opacity: .85;">Maintenance ran on load (retention cleanup).</p>
            {% elif cleanup_error %}
                <p class="admin-subtitle" style="margin-top: 8px; opacity: .85;">Maintenance error: {{ cleanup_error }}</p>
            {% endif %}
        </div>
        <div class="admin-header__actions">
            <a class="btn-admin btn-admin--secondary" href="{{ url_for('admin.dashboard') }}">
                <span class="btn-admin__icon">‚Ü©</span>
                <span>Back to dashboard</span>
            </a>
        </div>
    </header>

    <section class="visitor-metrics" aria-label="Smart analytics highlights">
        <article class="visitor-card visitor-card--primary">
            <p class="visitor-card__label">Humans ({{ payload.window_days | default(7) }} days)</p>
            <strong class="visitor-card__value">{{ payload.totals.human | default(0) }}</strong>
            <p class="visitor-card__note">Estimated real visitors.</p>
        </article>
        <article class="visitor-card visitor-card--accent">
            <p class="visitor-card__label">Bots ({{ payload.window_days | default(7) }} days)</p>
            <strong class="visitor-card__value">{{ payload.totals.bot | default(0) }}</strong>
            <p class="visitor-card__note">Includes SEO crawlers (not blocked).</p>
        </article>
        <article class="visitor-card">
            <p class="visitor-card__label">Blocked attacks ({{ payload.window_days | default(7) }} days)</p>
            <strong class="visitor-card__value">{{ payload.totals.attack | default(0) }}</strong>
            <p class="visitor-card__note">WP/PHP/.env/.git probes, etc.</p>
        </article>
        <article class="visitor-card">
            <p class="visitor-card__label">Sales &amp; conversion ({{ payload.window_days | default(7) }} days)</p>
            <strong class="visitor-card__value">{{ payload.totals.sales | default(0) }}</strong>
            <p class="visitor-card__note">
                {{ ((payload.totals.conversion_rate | default(0)) * 100) | round(2) }}% conversion ¬∑ ${{ (payload.totals.revenue | default(0)) | round(2) }} revenue
            </p>
        </article>
    </section>

    <section class="admin-panel" aria-labelledby="analytics-charts-heading">
        <div class="admin-panel__header">
            <div>
                <p class="admin-panel__eyebrow">Last {{ payload.window_days }} days</p>
                <h2 class="admin-panel__title" id="analytics-charts-heading">Trends</h2>
                <p class="admin-panel__hint">Daily counts combine aggregated stats + recent sampled logs. If you run multiple workers, in-memory counters are per-worker.</p>
            </div>
            <div class="visitors-tools">
                <a class="btn btn-soft" href="{{ url_for('admin.analytics', skip_cleanup=1) }}">Reload (skip cleanup)</a>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1fr; gap: 18px; align-items: start;">
            <div class="admin-panel__body">
                <canvas id="trendChart" height="120"></canvas>
            </div>
            <div class="admin-panel__body">
                <canvas id="shareChart" height="120"></canvas>
            </div>
        </div>
    </section>

    <section class="admin-panel" aria-labelledby="top-countries-heading">
        <div class="admin-panel__header">
            <div>
                <p class="admin-panel__eyebrow">Geo (humans)</p>
                <h2 class="admin-panel__title" id="top-countries-heading">Top countries</h2>
                <p class="admin-panel__hint">Country is best-effort from IP; unknown is expected for some networks.</p>
            </div>
        </div>

        <div class="admin-panel__body">
            {% if payload.top_countries and payload.top_countries|length %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th style="text-align:right;">Humans</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in payload.top_countries %}
                        <tr>
                            <td>
                                {{ row.name }}
                                {% if row.code %}<span style="opacity:.6; margin-left: 6px;">({{ row.code }})</span>{% endif %}
                            </td>
                            <td style="text-align:right;">{{ row.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p style="margin:0; opacity:.8;">No country data yet. Once traffic comes in, this will fill automatically.</p>
            {% endif %}
        </div>
    </section>

    <section class="admin-panel" aria-labelledby="visitor-explorer-heading">
        <div class="admin-panel__header">
            <div>
                <p class="admin-panel__eyebrow">Explorer</p>
                <h2 class="admin-panel__title" id="visitor-explorer-heading">Visitors (grouped by IP)</h2>
                <p class="admin-panel__hint">One IP = one card. System pages are muted. User-Agent is hidden by default.</p>
            </div>
            <div class="visitors-tools" style="display:flex; gap: 8px; flex-wrap: wrap; align-items:center;">
                <span class="badge badge--outline">{{ visits_stats.total }} events</span>
                <span class="badge badge--outline">{{ visits_stats.unique_ips }} IPs</span>
                <span class="badge badge--outline">{{ visits_stats.sessions }} sessions</span>
            </div>
        </div>

        <div class="admin-panel__body">
            <form method="get" action="{{ url_for('admin.analytics') }}" class="ip-filters">
                <div class="field" style="min-width: 140px;">
                    <label class="field__label" for="days">Days</label>
                    <select class="field__input" id="days" name="days">
                        {% for d in [1, 2, 3, 7, 14, 30] %}
                            <option value="{{ d }}" {% if visits_stats.days == d %}selected{% endif %}>Last {{ d }} day{% if d != 1 %}s{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="field" style="min-width: 150px;">
                    <label class="field__label" for="type">Type</label>
                    <select class="field__input" id="type" name="type">
                        <option value="human" {% if visits_stats.type == 'human' %}selected{% endif %}>Human</option>
                        <option value="crawler" {% if visits_stats.type == 'crawler' %}selected{% endif %}>Crawler</option>
                        <option value="bot" {% if visits_stats.type == 'bot' %}selected{% endif %}>Bot</option>
                        <option value="all" {% if visits_stats.type == 'all' %}selected{% endif %}>All</option>
                    </select>
                </div>
                <div class="field" style="min-width: 170px;">
                    <label class="field__label" for="country">Country</label>
                    <input class="field__input" id="country" name="country" type="text" placeholder="US or United States" value="{{ visits_stats.country }}">
                </div>
                <div class="field" style="flex: 1 1 320px; min-width: 220px;">
                    <label class="field__label" for="q">Search</label>
                    <input class="field__input" id="q" name="q" type="search" placeholder="IP, path, referrer, session‚Ä¶" value="{{ visits_stats.q }}">
                </div>
                <div class="field" style="min-width: 150px;">
                    <label class="field__label" for="cards">Cards</label>
                    <select class="field__input" id="cards" name="cards">
                        {% for n in [10, 15, 25, 50, 100] %}
                            <option value="{{ n }}" {% if request.args.get('cards', '25')|int == n %}selected{% endif %}>{{ n }} IPs</option>
                        {% endfor %}
                    </select>
                </div>

                {% if request.args.get('skip_cleanup') %}
                    <input type="hidden" name="skip_cleanup" value="1">
                {% endif %}

                <div class="ip-filters__actions">
                    <button class="btn btn-soft" type="submit">Apply</button>
                    <a class="btn btn-soft" href="{{ url_for('admin.analytics') }}">Reset</a>
                    <a class="btn btn-soft" href="{{ url_for('admin.analytics_export', **query_args) }}">Export CSV</a>
                </div>
            </form>

            {% if ip_cards and ip_cards|length %}
            <div class="ip-cards" style="margin-top: 14px;">
                {% for c in ip_cards %}
                <article class="ip-card">
                    <header class="ip-card__header">
                        <div class="ip-card__identity">
                            <div class="ip-card__ip">
                                <span class="ip-card__ip-text" data-mono>{{ c.ip_address }}</span>
                                <button class="btn btn-soft ip-card__copy" type="button" data-copy="{{ c.ip_address }}">Copy</button>
                            </div>
                            <div class="ip-card__country">
                                <span class="ip-card__flag" aria-hidden="true">{{ c.country_flag }}</span>
                                <span class="ip-card__country-name">{{ c.country_name }}</span>
                                {% if c.country_code %}<span class="ip-card__country-code">({{ c.country_code }})</span>{% endif %}
                            </div>
                        </div>
                        <div class="ip-card__badges">
                            <span class="badge {{ c.type_style }}">{{ c.type_label }}</span>
                            <span class="badge badge--outline">{{ c.device }}</span>
                        </div>
                    </header>

                    <div class="ip-card__stats">
                        <div class="ip-stat">
                            <span class="ip-stat__label">Visit duration</span>
                            <strong class="ip-stat__value">{{ c.duration_label }}</strong>
                        </div>
                        <div class="ip-stat">
                            <span class="ip-stat__label">Pages visited</span>
                            <strong class="ip-stat__value">{{ c.pages_visited }}</strong>
                        </div>
                        <div class="ip-stat">
                            <span class="ip-stat__label">Last seen (UTC)</span>
                            <strong class="ip-stat__value" data-mono>{{ c.last_seen.strftime('%H:%M:%S') if c.last_seen else '‚Äî' }}</strong>
                        </div>
                    </div>

                    <div class="ip-card__pages">
                        <p class="ip-card__pages-title">Visited pages</p>
                        <ul class="ip-pages">
                            {% for p in c.pages %}
                                <li class="ip-page {% if p.is_system %}ip-page--system{% endif %}">
                                    <span class="ip-page__path" data-mono>{{ p.path }}</span>
                                    <span class="ip-page__meta">
                                        {% if p.is_system %}<span class="badge badge--soft">system</span>{% endif %}
                                        <span class="badge badge--outline">{{ p.count }}</span>
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                        <p class="ip-card__hint">System pages are muted: {{ system_paths | join(', ') }}.</p>
                    </div>

                    <details class="ip-card__details">
                        <summary>Technical details (hidden by default)</summary>
                        <div class="ip-card__details-body">
                            {% if c.session_id %}<p><strong>Session:</strong> <span data-mono>{{ c.session_id }}</span></p>{% endif %}
                            {% if c.referrer %}<p><strong>Referrer:</strong> <span data-mono>{{ c.referrer }}</span></p>{% endif %}
                            {% if c.user_agent %}<p><strong>User-Agent:</strong> <span data-mono>{{ c.user_agent }}</span></p>{% endif %}
                        </div>
                    </details>
                </article>
                {% endfor %}
            </div>
            {% else %}
                <p style="margin:0; opacity:.8;">No visitors found for these filters yet.</p>
            {% endif %}
        </div>
    </section>
</div>

<script id="analyticsPayload" type="application/json">{{ payload | tojson }}</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    const payload = JSON.parse((document.getElementById('analyticsPayload') || {}).textContent || '{}');
    const labels = (payload.series || []).map(d => d.label);
    const humans = (payload.series || []).map(d => d.human);
    const bots = (payload.series || []).map(d => d.bot);
    const attacks = (payload.series || []).map(d => d.attack);

    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Humans', data: humans, backgroundColor: 'rgba(34, 197, 94, 0.7)' },
                    { label: 'Bots', data: bots, backgroundColor: 'rgba(148, 163, 184, 0.7)' },
                    { label: 'Attacks', data: attacks, backgroundColor: 'rgba(239, 68, 68, 0.7)' }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                },
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    const shareCtx = document.getElementById('shareChart');
    if (shareCtx) {
        const totals = payload.totals || {};
        new Chart(shareCtx, {
            type: 'doughnut',
            data: {
                labels: ['Humans', 'Bots', 'Attacks'],
                datasets: [{
                    data: [totals.human || 0, totals.bot || 0, totals.attack || 0],
                    backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(148, 163, 184, 0.8)', 'rgba(239, 68, 68, 0.8)']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Copy helpers (IP address)
    function copyText(text) {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(function () {
                window.prompt('Copy to clipboard:', text);
            });
            return;
        }
        window.prompt('Copy to clipboard:', text);
    }

    document.addEventListener('click', function (e) {
        var btn = e.target.closest('[data-copy]');
        if (!btn) return;
        e.preventDefault();
        copyText(btn.getAttribute('data-copy'));
    });
</script>
{% endblock %}
