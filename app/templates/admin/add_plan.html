{% extends "base.html" %}

{% block content %}
<div class="shell admin-shell">
    <header class="admin-header admin-header--form admin-header--hero">
        <div class="admin-header__content">
            <p class="admin-eyebrow"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> Create New Plan</p>
            <h1 class="admin-title">Add House Plan</h1>
            <p class="admin-subtitle">Fill in the details below to publish a premium listing with clear specs, pricing, and deliverables.</p>
            <div class="admin-header__badges" role="list">
                <span role="listitem"><i class="fa-solid fa-shield-check" aria-hidden="true"></i> Secure draft</span>
                <span role="listitem"><i class="fa-solid fa-layer-group" aria-hidden="true"></i> Structured layout</span>
                <span role="listitem"><i class="fa-solid fa-bolt" aria-hidden="true"></i> Auto previews</span>
            </div>
        </div>
    </header>

    <section class="admin-meta-bar" aria-label="Plan creation status">
        <div class="admin-meta-pill admin-meta-pill--draft"><i class="fa-regular fa-circle-dot" aria-hidden="true"></i> Draft in progress</div>
        <div class="admin-meta-pill admin-meta-pill--tip"><i class="fa-solid fa-mobile-screen" aria-hidden="true"></i> Optimized for mobile entry</div>
        <div class="admin-meta-pill admin-meta-pill--muted"><i class="fa-regular fa-floppy-disk" aria-hidden="true"></i> Use Save Draft frequently</div>
        <div class="admin-meta-actions">
            <a class="admin-meta-link" href="#section-media"><i class="fa-regular fa-image" aria-hidden="true"></i> Media</a>
            <a class="admin-meta-link" href="#section-pricing"><i class="fa-solid fa-tag" aria-hidden="true"></i> Pricing</a>
            <a class="admin-meta-link" href="#section-publish"><i class="fa-solid fa-rocket" aria-hidden="true"></i> Publish</a>
        </div>
    </section>

    <section class="admin-quick-grid" aria-label="Plan creation guidance">
        <article class="admin-quick-card">
            <i class="fa-solid fa-list-check" aria-hidden="true"></i>
            <div>
                <h3>Start with basics</h3>
                <p>Title, plan type, and categories drive discovery. Keep them crisp and searchable.</p>
            </div>
        </article>
        <article class="admin-quick-card">
            <i class="fa-solid fa-ruler-combined" aria-hidden="true"></i>
            <div>
                <h3>Confirm dimensions</h3>
                <p>Enter both metric and imperial values to keep conversion hints accurate.</p>
            </div>
        </article>
        <article class="admin-quick-card">
            <i class="fa-solid fa-camera" aria-hidden="true"></i>
            <div>
                <h3>Upload a hero image</h3>
                <p>Crop a clean cover preview before publishing to keep listings consistent.</p>
            </div>
        </article>
    </section>

    {% if form.errors %}
    <div class="form-alert form-alert--error" role="alert">
        <div class="form-alert__icon">‚ö†Ô∏è</div>
        <div class="form-alert__content">
            <p class="form-alert__title">Please fix the following errors:</p>
            <ul class="form-alert__list">
                {% for field_errors in form.errors.values() %}
                    {% for err in field_errors %}
                    <li>{{ err }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <form class="admin-form admin-form--add-plan" method="post" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="admin-form__layout">
            <div class="admin-form__main">
                <div class="admin-form__toolbar" aria-label="Jump to section">
                    <span class="admin-form__toolbar-label">Jump to:</span>
                    <div class="admin-form__toolbar-actions">
                        <a class="admin-form__chip" href="#section-basics">Basics</a>
                        <a class="admin-form__chip" href="#section-editorial">Editorial</a>
                        <a class="admin-form__chip" href="#section-architecture">Architecture</a>
                        <a class="admin-form__chip" href="#section-description">Description</a>
                        <a class="admin-form__chip" href="#section-media">Media</a>
                        <a class="admin-form__chip" href="#section-pricing">Pricing</a>
                        <a class="admin-form__chip" href="#section-gumroad">Gumroad</a>
                        <a class="admin-form__chip" href="#section-seo">SEO</a>
                        <a class="admin-form__chip" href="#section-optional">Optional</a>
                        <a class="admin-form__chip admin-form__chip--primary" href="#section-publish">Publish</a>
                    </div>
                </div>

        <!-- Basic Information -->
        <div class="form-card" id="section-basics">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üìù</div>
                    <div>
                        <h2 class="form-card__title">Basic Information</h2>
                        <p class="form-card__subtitle">Plan name, type, categories, and a short summary for listings.</p>
                    </div>
                </div>
                <span class="form-card__tag form-card__tag--required">Required</span>
            </div>
            <div class="form-grid form-grid--2">
                <div class="form-group">
                    {{ form.title.label(class="form-label") }}
                    {{ form.title(class="form-input", placeholder="e.g., Modern 3-Bedroom Family Home") }}
                    <p class="form-help">The public name of the house plan as customers will see it.</p>
                    {% for err in form.title.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div class="form-group">
                    {{ form.plan_type.label(class="form-label") }}
                    {{ form.plan_type(class="form-select") }}
                    <p class="form-help">Used for discovery filters and recommendation rails.</p>
                </div>
                <div class="form-group">
                    {{ form.category_ids.label(class="form-label") }}
                    <div class="category-picker" role="group" aria-label="Categories">
                        {% for choice in form.category_ids.iter_choices() %}
                        {% set value = choice[0] %}
                        {% set label = choice[1] %}
                        {% set checked = choice[2] %}
                        <label class="category-pill">
                            <input type="checkbox" name="category_ids" value="{{ value }}" {% if checked %}checked{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <p class="form-help">Choose one or more categories. Customers will use these to filter plans.</p>
                    {% for err in form.category_ids.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div class="form-group form-group--full">
                    {{ form.short_description.label(class="form-label") }}
                    {{ form.short_description(class="form-textarea", rows=3, placeholder="A beautiful modern family home featuring...") }}
                    <p class="form-help">A brief, attractive summary that highlights the main idea of the design.</p>
                </div>
            </div>
        </div>

        <!-- Editorial depth -->
        <div class="form-card" id="section-editorial">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üß≠</div>
                    <div>
                        <h2 class="form-card__title">Editorial depth</h2>
                        <p class="form-card__subtitle">Describe the design intent, lifestyle fit, and customization options.</p>
                    </div>
                </div>
                <span class="form-card__tag">Recommended</span>
            </div>
            <div class="form-grid form-grid--1">
                <div class="form-group">
                    {{ form.design_philosophy.label(class="form-label") }}
                    {{ form.design_philosophy(class="form-textarea", rows=5, placeholder="Explain the intent: light, proportion, circulation, structure...") }}
                </div>
                <div class="form-group">
                    {{ form.lifestyle_suitability.label(class="form-label") }}
                    {{ form.lifestyle_suitability(class="form-textarea", rows=5, placeholder="Who this plan fits best: families, rental operators, aging-in-place...") }}
                </div>
                <div class="form-group">
                    {{ form.customization_potential.label(class="form-label") }}
                    {{ form.customization_potential(class="form-textarea", rows=5, placeholder="What can be adapted: roofline, fa√ßade, room swaps, climate tuning...") }}
                </div>
            </div>
        </div>

        <!-- Architectural Details -->
        <div class="form-card" id="section-architecture">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üèóÔ∏è</div>
                    <div>
                        <h2 class="form-card__title">Architectural Details</h2>
                        <p class="form-card__subtitle">Key dimensions, floor count, and area metrics for filtering.</p>
                    </div>
                </div>
                <span class="form-card__tag form-card__tag--required">Required</span>
            </div>
            <div class="form-grid form-grid--3">
                <div class="form-group">
                    {{ form.bedrooms.label(class="form-label") }}
                    {{ form.bedrooms(class="form-input", type="number") }}
                    <p class="form-help">Total number of bedrooms included in the plan.</p>
                </div>
                <div class="form-group">
                    {{ form.bathrooms.label(class="form-label") }}
                    {{ form.bathrooms(class="form-input", type="number", step="0.5") }}
                    <p class="form-help">Total number of bathrooms (including guest bathrooms).</p>
                </div>
                <div class="form-group">
                    {{ form.garage.label(class="form-label") }}
                    {{ form.garage(class="form-input", type="number") }}
                    <p class="form-help">Number of garage spaces or parking spots.</p>
                </div>
                <div class="form-group">
                    {{ form.total_area_m2.label(class="form-label") }}
                    {{ form.total_area_m2(class="form-input", type="number", step="0.1", placeholder="150.5") }}
                    <p class="form-help">Total built area in square meters (m¬≤).</p>
                    <p class="form-help form-help--muted" data-imperial-output="total_area_m2"></p>
                </div>
                <div class="form-group">
                    {{ form.total_area_sqft.label(class="form-label") }}
                    {{ form.total_area_sqft(class="form-input", type="number", step="1", placeholder="1620") }}
                    <p class="form-help">Total built area in square feet (sq ft).</p>
                </div>
                <div class="form-group">
                    {{ form.stories.label(class="form-label") }}
                    {{ form.stories(class="form-input", type="number") }}
                    <p class="form-help">Number of floors or levels (1 = single-story).</p>
                </div>
            </div>
        </div>

        <!-- Full Description -->
        <div class="form-card" id="section-description">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üìÑ</div>
                    <div>
                        <h2 class="form-card__title">Full Description</h2>
                        <p class="form-card__subtitle">Write the full narrative shown on the plan detail page.</p>
                    </div>
                </div>
                <span class="form-card__tag">Recommended</span>
            </div>
            <div class="form-group">
                {{ form.description.label(class="form-label") }}
                {{ form.description(class="form-textarea", rows=8, placeholder="Describe the house plan in detail...") }}
                <p class="form-help">Write a complete description of the house plan, highlighting its features and benefits.</p>
                {% for err in form.description.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
            </div>
        </div>

        <!-- Files & Media -->
        <div class="form-card" id="section-media">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üì∑</div>
                    <div>
                        <h2 class="form-card__title">Files & Media</h2>
                        <p class="form-card__subtitle">Upload cover artwork and downloadable assets.</p>
                    </div>
                </div>
                <span class="form-card__tag form-card__tag--required">Required</span>
            </div>
            <div class="form-grid form-grid--2">
                <div class="form-group image-cropper" data-cropper data-input-id="cover_image" data-preview-id="cover_image_preview">
                    {{ form.cover_image.label(class="form-label") }}
                    {{ form.cover_image(class="form-input", id="cover_image", accept="image/*") }}
                    <p class="form-help">Main image shown on the website to represent the plan.</p>
                    <div class="image-cropper__controls">
                        <button type="button" class="btn btn-soft" data-crop-open>Crop image</button>
                        <button type="button" class="btn btn-ghost" data-crop-reset>Reset</button>
                    </div>
                    <div class="image-cropper__preview">
                        <img id="cover_image_preview" data-initial-src="" alt="Cover preview" loading="lazy" decoding="async">
                        <div class="image-cropper__preview-meta">Desktop and mobile previews update after cropping.</div>
                    </div>
                    {% for err in form.cover_image.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div class="form-group">
                    {{ form.free_pdf_file.label(class="form-label") }}
                    {{ form.free_pdf_file(class="form-input") }}
                    <p class="form-help">Free PDF file available for download without payment.</p>
                    {% for err in form.free_pdf_file.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
            </div>
        </div>

        <!-- Pack Pricing -->
        <div class="form-card" id="section-pricing">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üí∞</div>
                    <div>
                        <h2 class="form-card__title">Pack Pricing</h2>
                        <p class="form-card__subtitle">Keep pricing aligned with Gumroad listings.</p>
                    </div>
                </div>
                <span class="form-card__tag form-card__tag--required">Required</span>
            </div>
            <div class="form-grid form-grid--3">
                <div class="form-group">
                    {{ form.price_pack_1.label(class="form-label") }}
                    {{ form.price_pack_1(class="form-input", type="number", step="0.01", placeholder="0.00") }}
                    <p class="form-help">Default is free. Only change if you monetize the introductory download.</p>
                    {% for err in form.price_pack_1.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div class="form-group">
                    {{ form.price_pack_2.label(class="form-label") }}
                    {{ form.price_pack_2(class="form-input", type="number", step="0.01", placeholder="49.00") }}
                    <p class="form-help">Attach the price shown on Gumroad for the PDF Pro Pack.</p>
                    {% for err in form.price_pack_2.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div class="form-group">
                    {{ form.price_pack_3.label(class="form-label") }}
                    {{ form.price_pack_3(class="form-input", type="number", step="0.01", placeholder="79.00") }}
                    <p class="form-help">Ultimate CAD pricing keeps the admin table in sync with Gumroad.</p>
                    {% for err in form.price_pack_3.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
            </div>
        </div>

        <!-- Paid Packs (Gumroad) -->
        <div class="form-card" id="section-gumroad">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üíé</div>
                    <div>
                        <h2 class="form-card__title">Paid Packs (Gumroad)</h2>
                        <p class="form-card__subtitle">Link the paid packs so customers can purchase instantly.</p>
                    </div>
                </div>
                <span class="form-card__tag">Recommended</span>
            </div>
            <div class="form-grid form-grid--1">
                <div class="form-group">
                    {{ form.gumroad_pack_2_url.label(class="form-label") }}
                    {{ form.gumroad_pack_2_url(class="form-input", placeholder="https://gumroad.com/l/...") }}
                    <p class="form-help">Paste the Gumroad purchase link for the PDF Pro Pack.</p>
                    {% for err in form.gumroad_pack_2_url.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div class="form-group">
                    {{ form.gumroad_pack_3_url.label(class="form-label") }}
                    {{ form.gumroad_pack_3_url(class="form-input", placeholder="https://gumroad.com/l/...") }}
                    <p class="form-help">Paste the Gumroad purchase link for the Ultimate CAD Pack.</p>
                    {% for err in form.gumroad_pack_3_url.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
            </div>
        </div>

        <!-- SEO Optimization -->
        <div class="form-card" id="section-seo">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üîç</div>
                    <div>
                        <h2 class="form-card__title">SEO Optimization</h2>
                        <p class="form-card__subtitle">Improve ranking with a clear title and description.</p>
                    </div>
                </div>
                <span class="form-card__tag">Optional</span>
            </div>
            <div class="form-grid form-grid--1">
                <div class="form-group">
                    {{ form.seo_title.label(class="form-label") }}
                    {{ form.seo_title(class="form-input", placeholder="Modern 3-Bedroom House Plan | Free Download") }}
                    <p class="form-help">Title used by search engines (Google). Keep it short and relevant.</p>
                </div>
                <div class="form-group">
                    {{ form.seo_description.label(class="form-label") }}
                    {{ form.seo_description(class="form-textarea", rows=3, placeholder="Download free modern 3-bedroom house plans...") }}
                    <p class="form-help">Short description shown in search results.</p>
                </div>
                <div class="form-group">
                    {{ form.seo_keywords.label(class="form-label") }}
                    {{ form.seo_keywords(class="form-input", placeholder="house plans, modern home, 3 bedroom, free download") }}
                    <p class="form-help">Comma-separated keywords related to this plan.</p>
                </div>
            </div>
        </div>

        <!-- Additional Fields (Optional) -->
        <div class="form-card form-card--optional" id="section-optional">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">‚öôÔ∏è</div>
                    <div>
                        <h2 class="form-card__title">Additional Details (Optional)</h2>
                        <p class="form-card__subtitle">Extra technical notes and attributes for advanced buyers.</p>
                    </div>
                </div>
                <span class="form-card__tag form-card__tag--optional">Optional</span>
            </div>
            <div class="form-grid form-grid--3">
                <div class="form-group">
                    {{ form.building_width.label(class="form-label") }}
                    {{ form.building_width(class="form-input", type="number", step="0.1") }}
                    <p class="form-help">Building width in meters.</p>
                    <p class="form-help form-help--muted" data-imperial-output="building_width"></p>
                </div>
                <div class="form-group">
                    {{ form.building_length.label(class="form-label") }}
                    {{ form.building_length(class="form-input", type="number", step="0.1") }}
                    <p class="form-help">Building length in meters.</p>
                    <p class="form-help form-help--muted" data-imperial-output="building_length"></p>
                    <p class="form-help form-help--muted" data-imperial-footprint></p>
                </div>
                <div class="form-group">
                    {{ form.ceiling_height.label(class="form-label") }}
                    {{ form.ceiling_height(class="form-input", type="number", step="0.05") }}
                    <p class="form-help">Standard ceiling height in meters.</p>
                </div>
                <div class="form-group">
                    {{ form.roof_type.label(class="form-label") }}
                    {{ form.roof_type(class="form-input", placeholder="e.g., Gable / Hip / Flat") }}
                    <p class="form-help">Type of roof construction.</p>
                </div>
                <div class="form-group">
                    {{ form.structure_type.label(class="form-label") }}
                    {{ form.structure_type(class="form-input", placeholder="e.g., Reinforced concrete") }}
                    <p class="form-help">Main structural material.</p>
                </div>
                <div class="form-group">
                    {{ form.foundation_type.label(class="form-label") }}
                    {{ form.foundation_type(class="form-input", placeholder="e.g., Strip footing") }}
                    <p class="form-help">Type of foundation system.</p>
                </div>
                <div class="form-group">
                    {{ form.construction_complexity.label(class="form-label") }}
                    {{ form.construction_complexity(class="form-select") }}
                    <p class="form-help">Overall construction difficulty level.</p>
                </div>
                <div class="form-group">
                    {{ form.ideal_for.label(class="form-label") }}
                    {{ form.ideal_for(class="form-input", placeholder="Family home, Vacation") }}
                    <p class="form-help">Best use cases for this design.</p>
                </div>
                <div class="form-group">
                    {{ form.suitable_climate.label(class="form-label") }}
                    {{ form.suitable_climate(class="form-input", placeholder="Tropical, Hot & dry") }}
                    <p class="form-help">Climate zones where this plan works best.</p>
                </div>
                <div class="form-group form-group--full">
                    {{ form.room_details.label(class="form-label") }}
                    {{ form.room_details(class="form-textarea", rows=4) }}
                    <p class="form-help">Detailed room-by-room breakdown (optional).</p>
                </div>
                <div class="form-group form-group--full">
                    {{ form.main_features.label(class="form-label") }}
                    {{ form.main_features(class="form-textarea", rows=4) }}
                    <p class="form-help">List key features (one per line).</p>
                </div>
                <div class="form-group form-group--full">
                    {{ form.construction_notes.label(class="form-label") }}
                    {{ form.construction_notes(class="form-textarea", rows=4) }}
                    <p class="form-help">Technical notes for builders (optional).</p>
                </div>
                <div class="form-group">
                    {{ form.estimated_construction_cost_note.label(class="form-label") }}
                    {{ form.estimated_construction_cost_note(class="form-input") }}
                    <p class="form-help">Construction cost estimate (optional).</p>
                </div>
                <div class="form-group">
                    {{ form.price.label(class="form-label") }}
                    {{ form.price(class="form-input", type="number", step="0.01") }}
                    <p class="form-help">Regular price (optional).</p>
                </div>
                <div class="form-group">
                    {{ form.sale_price.label(class="form-label") }}
                    {{ form.sale_price(class="form-input", type="number", step="0.01") }}
                    <p class="form-help">Sale price (optional).</p>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions" id="section-publish">
            <div class="form-toggles">
                <label class="form-checkbox">
                    {{ form.is_published() }}
                    <span class="form-checkbox__label">{{ form.is_published.label.text }}</span>
                    <p class="form-checkbox__help">Make this plan visible on the website</p>
                </label>
                <label class="form-checkbox">
                    {{ form.is_featured() }}
                    <span class="form-checkbox__label">{{ form.is_featured.label.text }}</span>
                    <p class="form-checkbox__help">Show in featured section</p>
                </label>
            </div>
            <div class="form-submit">
                <div class="form-submit__row">
                    {{ form.save_draft(class="btn btn-outline") }}
                    {{ form.submit(class="btn btn-primary") }}
                </div>
                <div class="form-status">
                    <span class="status-indicator">Status: <strong>Draft</strong></span>
                </div>
            </div>
        </div>
            </div>
            <aside class="admin-form__aside" aria-label="Publishing tips">
                <div class="aside-card aside-card--preview">
                    <div class="aside-preview__eyebrow">Live preview</div>
                    <div class="aside-preview__title" data-preview-title>Untitled plan</div>
                    <div class="aside-preview__meta">
                        <span data-preview-type>Plan type</span>
                        <span class="aside-preview__dot" aria-hidden="true"></span>
                        <span data-preview-price>Pack 2: $0.00</span>
                    </div>
                    <div class="aside-preview__chips" data-preview-categories>
                        <span class="aside-preview__chip">Categories appear here</span>
                    </div>
                    <p class="aside-preview__hint">Values update as you type and select categories.</p>
                </div>
                <div class="aside-card">
                    <h3>Publish readiness</h3>
                    <ul class="aside-list">
                        <li>Confirm title, type, and at least one category.</li>
                        <li>Upload a cover image and the free PDF.</li>
                        <li>Align pricing with Gumroad packs.</li>
                    </ul>
                </div>
                <div class="aside-card">
                    <h3>Quality tips</h3>
                    <ul class="aside-list">
                        <li>Use a short description under 160 characters.</li>
                        <li>Include metric + imperial dimensions when possible.</li>
                        <li>Highlight unique features near the top.</li>
                    </ul>
                </div>
                <div class="aside-card aside-card--accent">
                    <h3>Shortcuts</h3>
                    <div class="aside-links">
                        <a href="#section-media">Jump to media</a>
                        <a href="#section-pricing">Jump to pricing</a>
                        <a href="#section-publish">Go to publish</a>
                    </div>
                </div>
            </aside>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" referrerpolicy="no-referrer">
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js" referrerpolicy="no-referrer"></script>
<script>
    (function () {
        function initCropperField(wrapper) {
            const inputId = wrapper.getAttribute('data-input-id');
            const previewId = wrapper.getAttribute('data-preview-id');
            const fileInput = document.getElementById(inputId);
            const previewImg = document.getElementById(previewId);
            const openBtn = wrapper.querySelector('[data-crop-open]');
            const resetBtn = wrapper.querySelector('[data-crop-reset]');

            if (!fileInput || !previewImg || !openBtn || !resetBtn) return;

            let originalFile = null;
            let originalSrc = previewImg.dataset.initialSrc || '';
            if (originalSrc) {
                setPreview(originalSrc);
            }
            let cropper = null;

            function setPreview(src) {
                if (!src) {
                    previewImg.removeAttribute('src');
                    return;
                }
                previewImg.src = src;
            }

            function openModal() {
                const modal = document.querySelector('[data-crop-modal]');
                if (!modal) return;
                const modalImage = modal.querySelector('[data-crop-image]');
                const previewDesktop = modal.querySelector('[data-crop-preview-desktop]');
                const previewMobile = modal.querySelector('[data-crop-preview-mobile]');
                const activeSrc = previewImg.getAttribute('src') || '';
                if (!activeSrc) return;

                modalImage.src = activeSrc;
                modalImage.crossOrigin = 'anonymous';
                modal.removeAttribute('hidden');
                document.body.classList.add('cropper-open');

                cropper = new Cropper(modalImage, {
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    background: false,
                    movable: true,
                    zoomable: true,
                    rotatable: false,
                    scalable: false,
                    preview: [previewDesktop, previewMobile],
                });
            }

            function closeModal() {
                const modal = document.querySelector('[data-crop-modal]');
                if (!modal) return;
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                modal.setAttribute('hidden', 'hidden');
                document.body.classList.remove('cropper-open');
            }

            function applyCrop() {
                if (!cropper) return;
                const canvas = cropper.getCroppedCanvas({
                    maxWidth: 1600,
                    maxHeight: 1200,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high'
                });
                if (!canvas) {
                    closeModal();
                    return;
                }
                canvas.toBlob(function (blob) {
                    if (!blob) {
                        closeModal();
                        return;
                    }
                    const fileName = (originalFile && originalFile.name) ? originalFile.name.replace(/\.(\w+)$/, '-crop.$1') : 'cover-crop.jpg';
                    const croppedFile = new File([blob], fileName, { type: blob.type });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(croppedFile);
                    fileInput.files = dataTransfer.files;
                    setPreview(URL.createObjectURL(croppedFile));
                    closeModal();
                }, 'image/jpeg', 0.9);
            }

            fileInput.addEventListener('change', function () {
                const file = fileInput.files && fileInput.files[0];
                if (!file) return;
                originalFile = file;
                originalSrc = URL.createObjectURL(file);
                setPreview(originalSrc);
            });

            openBtn.addEventListener('click', function () {
                openModal();
            });

            resetBtn.addEventListener('click', function () {
                if (originalSrc) {
                    setPreview(originalSrc);
                    if (originalFile) {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(originalFile);
                        fileInput.files = dataTransfer.files;
                    }
                } else {
                    fileInput.value = '';
                    setPreview('');
                }
            });

            document.addEventListener('click', function (e) {
                const target = e.target;
                if (!(target instanceof HTMLElement)) return;
                if (target.matches('[data-crop-cancel], [data-crop-close]')) {
                    e.preventDefault();
                    closeModal();
                }
                if (target.matches('[data-crop-apply]')) {
                    e.preventDefault();
                    applyCrop();
                }
                if (target.matches('[data-aspect]') && cropper) {
                    e.preventDefault();
                    const ratio = target.getAttribute('data-aspect');
                    const value = ratio === 'free' ? NaN : Number(ratio);
                    cropper.setAspectRatio(value);
                    target.closest('.cropper-modal__ratios')?.querySelectorAll('button').forEach(btn => btn.classList.remove('is-active'));
                    target.classList.add('is-active');
                }
            });
        }

        document.querySelectorAll('[data-cropper]').forEach(initCropperField);

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const id = entry.target.getAttribute('id');
                const chip = document.querySelector(`.admin-form__chip[href="#${id}"]`);
                if (!chip) return;
                if (entry.isIntersecting) {
                    chip.classList.add('is-active');
                } else {
                    chip.classList.remove('is-active');
                }
            });
        }, { rootMargin: '-30% 0px -50% 0px', threshold: [0, 0.25, 0.5, 0.75, 1] });

        document.querySelectorAll('.form-card').forEach(section => observer.observe(section));

        function initLivePreview() {
            const titleInput = document.getElementById('title');
            const typeSelect = document.getElementById('plan_type');
            const priceInput = document.getElementById('price_pack_2');
            const previewTitle = document.querySelector('[data-preview-title]');
            const previewType = document.querySelector('[data-preview-type]');
            const previewPrice = document.querySelector('[data-preview-price]');
            const previewCategories = document.querySelector('[data-preview-categories]');

            if (!previewTitle || !previewType || !previewPrice || !previewCategories) return;

            function updatePreview() {
                const titleValue = titleInput?.value?.trim();
                previewTitle.textContent = titleValue || 'Untitled plan';

                const typeOption = typeSelect?.selectedOptions?.[0]?.textContent || 'Plan type';
                previewType.textContent = typeOption;

                const priceValue = priceInput?.value;
                previewPrice.textContent = priceValue ? `Pack 2: $${Number(priceValue).toFixed(2)}` : 'Pack 2: $0.00';

                const checkedCategories = Array.from(document.querySelectorAll('input[name="category_ids"]:checked'))
                    .map(input => input.nextElementSibling?.textContent?.trim())
                    .filter(Boolean)
                    .slice(0, 4);

                previewCategories.innerHTML = '';
                if (checkedCategories.length === 0) {
                    previewCategories.innerHTML = '<span class="aside-preview__chip">Categories appear here</span>';
                } else {
                    checkedCategories.forEach(label => {
                        const chip = document.createElement('span');
                        chip.className = 'aside-preview__chip';
                        chip.textContent = label;
                        previewCategories.appendChild(chip);
                    });
                }
            }

            [titleInput, typeSelect, priceInput].forEach(el => {
                if (!el) return;
                el.addEventListener('input', updatePreview);
                el.addEventListener('change', updatePreview);
            });

            document.querySelectorAll('input[name="category_ids"]').forEach(el => {
                el.addEventListener('change', updatePreview);
            });

            updatePreview();
        }

        function parseNumber(value) {
            const num = Number.parseFloat(value);
            return Number.isFinite(num) ? num : null;
        }

        function formatFeetInches(meters) {
            if (meters === null || meters === undefined) return '';
            const totalInches = meters * 39.3700787;
            let feet = Math.floor(totalInches / 12);
            let inches = Math.round(totalInches - (feet * 12));
            if (inches === 12) {
                feet += 1;
                inches = 0;
            }
            return `${feet} ft ${inches} in`;
        }

        function formatSqFt(squareMeters) {
            const sqft = squareMeters * 10.7639;
            return Math.round(sqft).toLocaleString();
        }

        function initMetricImperialPreview() {
            const widthInput = document.getElementById('building_width');
            const lengthInput = document.getElementById('building_length');
            const areaInput = document.getElementById('total_area_m2');

            const widthOutput = document.querySelector('[data-imperial-output="building_width"]');
            const lengthOutput = document.querySelector('[data-imperial-output="building_length"]');
            const areaOutput = document.querySelector('[data-imperial-output="total_area_m2"]');
            const footprintOutput = document.querySelector('[data-imperial-footprint]');

            if (!widthInput && !lengthInput && !areaInput) return;

            function update() {
                const width = widthInput ? parseNumber(widthInput.value) : null;
                const length = lengthInput ? parseNumber(lengthInput.value) : null;
                const areaM2 = areaInput ? parseNumber(areaInput.value) : null;
                const computedAreaM2 = (width !== null && length !== null) ? width * length : null;
                const displayAreaM2 = areaM2 !== null ? areaM2 : computedAreaM2;

                if (widthOutput) {
                    widthOutput.textContent = width !== null ? `‚âà ${formatFeetInches(width)}` : '';
                }
                if (lengthOutput) {
                    lengthOutput.textContent = length !== null ? `‚âà ${formatFeetInches(length)}` : '';
                }
                if (footprintOutput) {
                    footprintOutput.textContent = (width !== null && length !== null)
                        ? `‚âà ${formatFeetInches(width)} √ó ${formatFeetInches(length)}`
                        : '';
                }
                if (areaOutput) {
                    if (displayAreaM2 !== null) {
                        const suffix = areaM2 !== null ? '' : ' (from width √ó length)';
                        areaOutput.textContent = `‚âà ${formatSqFt(displayAreaM2)} sq ft${suffix}`;
                    } else {
                        areaOutput.textContent = '';
                    }
                }
            }

            [widthInput, lengthInput, areaInput].forEach((input) => {
                if (!input) return;
                input.addEventListener('input', update);
                input.addEventListener('change', update);
            });

            update();
        }

        initMetricImperialPreview();
        initLivePreview();
    })();
</script>

<div class="cropper-modal" data-crop-modal hidden>
    <div class="cropper-modal__backdrop" data-crop-close></div>
    <div class="cropper-modal__panel" role="dialog" aria-modal="true" aria-label="Crop image">
        <header class="cropper-modal__header">
            <h3>Crop image</h3>
            <button type="button" class="btn btn-ghost" data-crop-close>Close</button>
        </header>
        <div class="cropper-modal__body">
            <div class="cropper-modal__image">
                <img data-crop-image alt="Cropper preview">
            </div>
            <aside class="cropper-modal__preview">
                <p class="muted">Desktop preview</p>
                <div class="cropper-preview cropper-preview--desktop" data-crop-preview-desktop></div>
                <p class="muted">Mobile preview</p>
                <div class="cropper-preview cropper-preview--mobile" data-crop-preview-mobile></div>
            </aside>
        </div>
        <div class="cropper-modal__controls">
            <div class="cropper-modal__ratios" role="group" aria-label="Aspect ratios">
                <button type="button" class="btn btn-ghost is-active" data-aspect="free">Free</button>
                <button type="button" class="btn btn-ghost" data-aspect="1">1:1</button>
                <button type="button" class="btn btn-ghost" data-aspect="1.3333">4:3</button>
                <button type="button" class="btn btn-ghost" data-aspect="1.7778">16:9</button>
            </div>
            <div class="cropper-modal__actions">
                <button type="button" class="btn btn-soft" data-crop-cancel>Cancel</button>
                <button type="button" class="btn btn-primary" data-crop-apply>Apply crop</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
