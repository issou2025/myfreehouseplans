{% extends "base.html" %}

{% block content %}
<div class="shell admin-shell">
    <header class="admin-header admin-header--form admin-header--hero">
        <div class="admin-header__content">
            <p class="admin-eyebrow"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> Create New Plan</p>
            <h1 class="admin-title">Add House Plan</h1>
            <p class="admin-subtitle">Fill in the details below to publish a premium listing with clear specs, pricing, and deliverables.</p>
            <div class="admin-header__badges" role="list">
                <span role="listitem"><i class="fa-solid fa-shield-check" aria-hidden="true"></i> Secure draft</span>
                <span role="listitem"><i class="fa-solid fa-layer-group" aria-hidden="true"></i> Structured layout</span>
                <span role="listitem"><i class="fa-solid fa-bolt" aria-hidden="true"></i> Auto previews</span>
            </div>
        </div>
    </header>


    {% if form.errors %}
    <div class="form-alert form-alert--error" role="alert">
        <div class="form-alert__icon">‚ö†Ô∏è</div>
        <div class="form-alert__content">
            <p class="form-alert__title">Please fix the following errors:</p>
            <ul class="form-alert__list">
                {% for field_errors in form.errors.values() %}
                    {% for err in field_errors %}
                    <li>{{ err }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <form class="admin-form admin-form--add-plan" method="post" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="admin-form__layout">
            <div class="admin-form__main">
                <div class="admin-form__toolbar" aria-label="Jump to section">
                    <span class="admin-form__toolbar-label">Jump to:</span>
                    <div class="admin-form__toolbar-actions">
                        <a class="admin-form__chip" href="#section-basics">Basics</a>
                        <a class="admin-form__chip" href="#section-marketing">Marketing</a>
                        <a class="admin-form__chip" href="#section-rooms">Rooms</a>
                        <a class="admin-form__chip" href="#section-editorial">Editorial</a>
                        <a class="admin-form__chip" href="#section-architecture">Architecture</a>
                        <a class="admin-form__chip" href="#section-land">Land</a>
                        <a class="admin-form__chip" href="#section-construction">Construction</a>
                        <a class="admin-form__chip" href="#section-cost">Cost</a>
                        <a class="admin-form__chip" href="#section-description">Description</a>
                        <a class="admin-form__chip" href="#section-media">Media</a>
                        <a class="admin-form__chip" href="#section-pricing">Pricing</a>
                        <a class="admin-form__chip" href="#section-pack-descriptions">Pack Details</a>
                        <a class="admin-form__chip" href="#section-gumroad">Gumroad</a>
                        <a class="admin-form__chip" href="#section-seo">SEO</a>
                        <a class="admin-form__chip" href="#section-optional">Optional</a>
                        <a class="admin-form__chip admin-form__chip--primary" href="#section-publish">Publish</a>
                    </div>
                </div>

                <div class="admin-progress" aria-label="Plan creation progress">
                    <div class="admin-progress__meta">
                        <span class="admin-progress__label">Section:</span>
                        <strong class="admin-progress__current" data-progress-current>Basic Information</strong>
                    </div>
                    <div class="admin-progress__track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                        <span class="admin-progress__bar" data-progress-bar></span>
                    </div>
                    <span class="admin-progress__percent" data-progress-percent>0%</span>
                </div>

        <!-- Plan Identity -->
        <div class="form-card" id="section-identity" data-section-label="Plan Identity">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üßæ</div>
                    <div>
                        <h2 class="form-card__title">Plan Identity</h2>
                        <p class="form-card__subtitle">Core plan details and the professional reference code.</p>
                    </div>
                </div>
                <span class="form-card__tag form-card__tag--required">Required</span>
            </div>
            <div class="form-grid form-grid--2">
                <div class="form-group">
                    {{ form.title.label(class="form-label") }}
                    {{ form.title(class="form-input", placeholder="e.g., Modern 3-Bedroom Family Home") }}
                    <p class="form-help">The public name of the house plan as customers will see it.</p>
                    {% for err in form.title.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div class="form-group">
                    {{ form.plan_type.label(class="form-label") }}
                    {{ form.plan_type(class="form-select") }}
                    <p class="form-help">Used for discovery filters and recommendation rails.</p>
                </div>
                <div class="form-group">
                    {{ form.architectural_style.label(class="form-label") }}
                    {{ form.architectural_style(class="form-input", placeholder="e.g., Modern, Contemporary, Traditional") }}
                    <p class="form-help">{{ form.architectural_style.description }}</p>
                </div>
                <div class="form-group">
                    {{ form.target_buyer.label(class="form-label") }}
                    {{ form.target_buyer(class="form-input", placeholder="e.g., First-time homebuyers, Growing families") }}
                    <p class="form-help">{{ form.target_buyer.description }}</p>
                </div>
                <div class="form-group">
                    {{ form.budget_category.label(class="form-label") }}
                    {{ form.budget_category(class="form-select") }}
                    <p class="form-help">{{ form.budget_category.description }}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Public plan code</label>
                    <input class="form-input" type="text" value="Auto-generated after save" readonly>
                    <p class="form-help">Professional reference format (MFP-XXX). Generated automatically.</p>
                </div>
                <div class="form-group form-group--full">
                    {{ form.category_ids.label(class="form-label") }}
                    <div class="category-picker" role="group" aria-label="Categories">
                        {% for choice in form.category_ids.iter_choices() %}
                        {% set value = choice[0] %}
                        {% set label = choice[1] %}
                        {% set checked = choice[2] %}
                        <label class="category-pill">
                            <input type="checkbox" name="category_ids" value="{{ value }}" {% if checked %}checked{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <p class="form-help">Choose one or more categories. Customers will use these to filter plans.</p>
                    {% for err in form.category_ids.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
            </div>
        </div>

        <!-- Quick Marketing Summary -->
        <div class="form-card" id="section-marketing" data-section-label="Quick Marketing Summary">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">‚ú®</div>
                    <div>
                        <h2 class="form-card__title">Quick Marketing Summary</h2>
                        <p class="form-card__subtitle">Short highlights that appear on the public listing.</p>
                    </div>
                </div>
                <span class="form-card__tag">Professional</span>
            </div>
            <div class="form-grid form-grid--1">
                <div class="form-group">
                    {{ form.short_description.label(class="form-label") }}
                    {{ form.short_description(class="form-textarea", rows=3, placeholder="A beautiful modern family home featuring...") }}
                    <p class="form-help">A brief, attractive summary that highlights the main idea of the design.</p>
                </div>
                <div class="form-group">
                    {{ form.key_selling_point.label(class="form-label") }}
                    {{ form.key_selling_point(class="form-textarea", rows=2, placeholder="e.g., Maximizes natural light with floor-to-ceiling windows") }}
                    <p class="form-help">{{ form.key_selling_point.description }}</p>
                </div>
                <div class="form-group">
                    {{ form.problems_this_plan_solves.label(class="form-label") }}
                    {{ form.problems_this_plan_solves(class="form-textarea", rows=3, placeholder="e.g., Efficient layout for narrow urban lots, Open plan for family living") }}
                    <p class="form-help">{{ form.problems_this_plan_solves.description }}</p>
                </div>
            </div>
        </div>

        <!-- Structured Specifications -->
        <div class="form-card" id="section-specs" data-section-label="Structured Specifications">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üè†</div>
                    <div>
                        <h2 class="form-card__title">Structured Specifications</h2>
                        <p class="form-card__subtitle">Room counts and core layout data for search filters.</p>
                    </div>
                </div>
                <span class="form-card__tag">Required</span>
            </div>
            <div class="form-grid form-grid--3">
                <div class="form-group">
                    {{ form.bedrooms.label(class="form-label") }}
                    {{ form.bedrooms(class="form-input", type="number") }}
                </div>
                <div class="form-group">
                    {{ form.bathrooms.label(class="form-label") }}
                    {{ form.bathrooms(class="form-input", type="number", step="0.5") }}
                </div>
                <div class="form-group">
                    {{ form.living_rooms.label(class="form-label") }}
                    {{ form.living_rooms(class="form-input", type="number", min="0") }}
                </div>
                <div class="form-group">
                    {{ form.kitchens.label(class="form-label") }}
                    {{ form.kitchens(class="form-input", type="number", min="0") }}
                </div>
                <div class="form-group">
                    {{ form.offices.label(class="form-label") }}
                    {{ form.offices(class="form-input", type="number", min="0") }}
                </div>
                <div class="form-group">
                    {{ form.terraces.label(class="form-label") }}
                    {{ form.terraces(class="form-input", type="number", min="0") }}
                </div>
                <div class="form-group">
                    {{ form.storage_rooms.label(class="form-label") }}
                    {{ form.storage_rooms(class="form-input", type="number", min="0") }}
                </div>
                <div class="form-group">
                    {{ form.garage.label(class="form-label") }}
                    {{ form.garage(class="form-input", type="number", min="0") }}
                </div>
                <div class="form-group">
                    {{ form.stories.label(class="form-label") }}
                    {{ form.stories(class="form-input", type="number", min="1") }}
                </div>
            </div>
        </div>

        <!-- Size & Land -->
        <div class="form-card" id="section-size-land" data-section-label="Size & Land">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üìê</div>
                    <div>
                        <h2 class="form-card__title">Size &amp; Land</h2>
                        <p class="form-card__subtitle">Primary dimensions in metric with imperial previews.</p>
                    </div>
                </div>
                <span class="form-card__tag">Required</span>
            </div>
            <div class="form-grid form-grid--2">
                <div class="form-group">
                    {{ form.total_area_m2.label(class="form-label") }}
                    {{ form.total_area_m2(class="form-input", type="number", step="0.1", placeholder="150.5") }}
                    <p class="form-help">Total built area in square meters (m¬≤).</p>
                    <p class="form-help form-help--muted" data-imperial-output="total_area_m2"></p>
                </div>
                <div class="form-group">
                    {{ form.total_area_sqft.label(class="form-label") }}
                    {{ form.total_area_sqft(class="form-input", type="number", step="1", placeholder="1620") }}
                    <p class="form-help">Total built area in square feet (sq ft).</p>
                </div>
                <div class="form-group">
                    {{ form.building_width.label(class="form-label") }}
                    {{ form.building_width(class="form-input", type="number", step="0.1", placeholder="10.5") }}
                    <p class="form-help">Building footprint width in meters.</p>
                    <p class="form-help form-help--muted" data-imperial-output="building_width"></p>
                </div>
                <div class="form-group">
                    {{ form.building_length.label(class="form-label") }}
                    {{ form.building_length(class="form-input", type="number", step="0.1", placeholder="15.0") }}
                    <p class="form-help">Building footprint length in meters.</p>
                    <p class="form-help form-help--muted" data-imperial-output="building_length"></p>
                </div>
                <div class="form-group">
                    {{ form.min_plot_width.label(class="form-label") }}
                    {{ form.min_plot_width(class="form-input", type="number", step="0.1", placeholder="12.0") }}
                    <p class="form-help">{{ form.min_plot_width.description }}</p>
                    <p class="form-help form-help--muted" data-imperial-output="min_plot_width"></p>
                </div>
                <div class="form-group">
                    {{ form.min_plot_length.label(class="form-label") }}
                    {{ form.min_plot_length(class="form-input", type="number", step="0.1", placeholder="20.0") }}
                    <p class="form-help">{{ form.min_plot_length.description }}</p>
                    <p class="form-help form-help--muted" data-imperial-output="min_plot_length"></p>
                </div>
            </div>
        </div>

        <!-- Climate & Construction -->
        <div class="form-card" id="section-climate" data-section-label="Climate & Construction">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üõ†Ô∏è</div>
                    <div>
                        <h2 class="form-card__title">Climate &amp; Construction</h2>
                        <p class="form-card__subtitle">Compatibility notes and structural direction.</p>
                    </div>
                </div>
                <span class="form-card__tag">Professional</span>
            </div>
            <div class="form-grid form-grid--2">
                <div class="form-group">
                    {{ form.climate_compatibility.label(class="form-label") }}
                    {{ form.climate_compatibility(class="form-input", placeholder="e.g., Tropical, Temperate, Hot & Arid") }}
                    <p class="form-help">{{ form.climate_compatibility.description }}</p>
                </div>
                <div class="form-group">
                    {{ form.estimated_build_time.label(class="form-label") }}
                    {{ form.estimated_build_time(class="form-input", placeholder="e.g., 6-9 months") }}
                    <p class="form-help">{{ form.estimated_build_time.description }}</p>
                </div>
                <div class="form-group">
                    {{ form.structure_type.label(class="form-label") }}
                    {{ form.structure_type(class="form-input", placeholder="e.g., Timber frame, Concrete") }}
                </div>
                <div class="form-group">
                    {{ form.foundation_type.label(class="form-label") }}
                    {{ form.foundation_type(class="form-input", placeholder="e.g., Slab on grade, Strip footing") }}
                </div>
                <div class="form-group">
                    {{ form.roof_type.label(class="form-label") }}
                    {{ form.roof_type(class="form-input", placeholder="e.g., Gable, Hip, Flat") }}
                </div>
                <div class="form-group">
                    {{ form.construction_complexity.label(class="form-label") }}
                    {{ form.construction_complexity(class="form-select") }}
                </div>
            </div>
        </div>

        <!-- Cost Estimate -->
        <div class="form-card" id="section-cost" data-section-label="Cost Estimate">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üí∞</div>
                    <div>
                        <h2 class="form-card__title">Cost Estimate</h2>
                        <p class="form-card__subtitle">Provide a build cost range in USD (optional).</p>
                    </div>
                </div>
                <span class="form-card__tag">Optional</span>
            </div>
            <div class="form-grid form-grid--2">
                <div class="form-group">
                    {{ form.estimated_cost_low.label(class="form-label") }}
                    {{ form.estimated_cost_low(class="form-input", type="number", step="1000", placeholder="50000") }}
                    <p class="form-help">{{ form.estimated_cost_low.description }}</p>
                </div>
                <div class="form-group">
                    {{ form.estimated_cost_high.label(class="form-label") }}
                    {{ form.estimated_cost_high(class="form-input", type="number", step="1000", placeholder="75000") }}
                    <p class="form-help">{{ form.estimated_cost_high.description }}</p>
                </div>
                <div class="form-group form-group--full">
                    {{ form.estimated_construction_cost_note.label(class="form-label") }}
                    {{ form.estimated_construction_cost_note(class="form-input", placeholder="e.g., Costs vary by location and finishes") }}
                    <p class="form-help">Additional cost notes or disclaimers.</p>
                </div>
            </div>
        </div>

        <!-- Full Description -->
        <div class="form-card" id="section-description" data-section-label="Full Description">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üìù</div>
                    <div>
                        <h2 class="form-card__title">Full Description</h2>
                        <p class="form-card__subtitle">Narrative details for the public plan page.</p>
                    </div>
                </div>
                <span class="form-card__tag">Recommended</span>
            </div>
            <div class="form-grid form-grid--1">
                <div class="form-group">
                    {{ form.description.label(class="form-label") }}
                    {{ form.description(class="form-textarea", rows=8, placeholder="Describe the house plan in detail...") }}
                    <p class="form-help">Write a complete description of the house plan, highlighting its features and benefits.</p>
                    {% for err in form.description.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div class="form-group">
                    {{ form.lifestyle_suitability.label(class="form-label") }}
                    {{ form.lifestyle_suitability(class="form-textarea", rows=4, placeholder="Who this plan fits best...") }}
                </div>
                <div class="form-group">
                    {{ form.room_details.label(class="form-label") }}
                    {{ form.room_details(class="form-textarea", rows=4, placeholder="Room-by-room details...") }}
                </div>
                <div class="form-group">
                    {{ form.customization_potential.label(class="form-label") }}
                    {{ form.customization_potential(class="form-textarea", rows=4, placeholder="What can be adapted...") }}
                </div>
                <div class="form-group">
                    {{ form.design_philosophy.label(class="form-label") }}
                    {{ form.design_philosophy(class="form-textarea", rows=4, placeholder="Design intent and philosophy...") }}
                </div>
                <div class="form-group">
                    {{ form.main_features.label(class="form-label") }}
                    {{ form.main_features(class="form-textarea", rows=4, placeholder="List key features...") }}
                </div>
                <div class="form-group">
                    {{ form.construction_notes.label(class="form-label") }}
                    {{ form.construction_notes(class="form-textarea", rows=4, placeholder="Technical notes for builders...") }}
                </div>
            </div>
        </div>

        <!-- Packs & Downloads -->
        <div class="form-card" id="section-packs" data-section-label="Packs & Downloads">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üì¶</div>
                    <div>
                        <h2 class="form-card__title">Packs &amp; Downloads</h2>
                        <p class="form-card__subtitle">Configure each pack and the Gumroad links.</p>
                    </div>
                </div>
                <span class="form-card__tag">Required</span>
            </div>
            <div class="form-pack-grid">
                <div class="form-pack-card">
                    <h3>Pack 01 ¬∑ Free PDF</h3>
                    <div class="form-group">
                        {{ form.free_pdf_file.label(class="form-label") }}
                        {{ form.free_pdf_file(class="form-input") }}
                        <p class="form-help">Free PDF file available for download without payment.</p>
                        {% for err in form.free_pdf_file.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                    </div>
                    <div class="form-group">
                        {{ form.pack1_description.label(class="form-label") }}
                        {{ form.pack1_description(class="form-textarea", rows=3, placeholder="e.g., Includes preview PDF with floor plans and elevations...") }}
                    </div>
                    <div class="form-group">
                        {{ form.price_pack_1.label(class="form-label") }}
                        {{ form.price_pack_1(class="form-input", type="number", step="0.01", placeholder="0.00") }}
                    </div>
                </div>
                <div class="form-pack-card">
                    <h3>Pack 02 ¬∑ PDF Pro</h3>
                    <div class="form-group">
                        {{ form.price_pack_2.label(class="form-label") }}
                        {{ form.price_pack_2(class="form-input", type="number", step="0.01", placeholder="49.00") }}
                    </div>
                    <div class="form-group">
                        {{ form.pack2_description.label(class="form-label") }}
                        {{ form.pack2_description(class="form-textarea", rows=3, placeholder="e.g., Complete PDF set with detailed floor plans, elevations, sections...") }}
                    </div>
                    <div class="form-group">
                        {{ form.gumroad_pack_2_url.label(class="form-label") }}
                        {{ form.gumroad_pack_2_url(class="form-input", placeholder="https://gumroad.com/l/...") }}
                        {% for err in form.gumroad_pack_2_url.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                    </div>
                </div>
                <div class="form-pack-card">
                    <h3>Pack 03 ¬∑ Ultimate CAD</h3>
                    <div class="form-group">
                        {{ form.price_pack_3.label(class="form-label") }}
                        {{ form.price_pack_3(class="form-input", type="number", step="0.01", placeholder="79.00") }}
                    </div>
                    <div class="form-group">
                        {{ form.pack3_description.label(class="form-label") }}
                        {{ form.pack3_description(class="form-textarea", rows=3, placeholder="e.g., Editable CAD files (DWG/DXF) with all layers and details...") }}
                    </div>
                    <div class="form-group">
                        {{ form.gumroad_pack_3_url.label(class="form-label") }}
                        {{ form.gumroad_pack_3_url(class="form-input", placeholder="https://gumroad.com/l/...") }}
                        {% for err in form.gumroad_pack_3_url.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                    </div>
                </div>
            </div>
            <div class="form-grid form-grid--2" style="margin-top: 20px;">
                <div class="form-group">
                    {{ form.price.label(class="form-label") }}
                    {{ form.price(class="form-input", type="number", step="0.01") }}
                    <p class="form-help">Primary display price (required for publishing).</p>
                </div>
                <div class="form-group">
                    {{ form.sale_price.label(class="form-label") }}
                    {{ form.sale_price(class="form-input", type="number", step="0.01") }}
                </div>
            </div>
        </div>

        <!-- Media & SEO -->
        <div class="form-card" id="section-media" data-section-label="Media & SEO">
            <div class="form-card__header">
                <div class="form-card__heading">
                    <div class="form-card__icon">üñºÔ∏è</div>
                    <div>
                        <h2 class="form-card__title">Media &amp; SEO</h2>
                        <p class="form-card__subtitle">Upload imagery and optimize search visibility.</p>
                    </div>
                </div>
                <span class="form-card__tag">Optional</span>
            </div>
            <div class="form-grid form-grid--2">
                <div class="form-group image-cropper" data-cropper data-input-id="cover_image" data-preview-id="cover_image_preview">
                    {{ form.cover_image.label(class="form-label") }}
                    {{ form.cover_image(class="form-input", id="cover_image", accept="image/*") }}
                    <p class="form-help">Main image shown on the website to represent the plan.</p>
                    <div class="image-cropper__controls">
                        <button type="button" class="btn btn-soft" data-crop-open>Crop image</button>
                        <button type="button" class="btn btn-ghost" data-crop-reset>Reset</button>
                    </div>
                    <div class="image-cropper__preview">
                        <img id="cover_image_preview" data-initial-src="" alt="Cover preview" loading="lazy" decoding="async">
                        <div class="image-cropper__preview-meta">Desktop and mobile previews update after cropping.</div>
                    </div>
                    {% for err in form.cover_image.errors %}<span class="form-error">{{ err }}</span>{% endfor %}
                </div>
                <div>
                    <div class="form-group">
                        {{ form.seo_title.label(class="form-label") }}
                        {{ form.seo_title(class="form-input", placeholder="Modern 3-Bedroom House Plan | Free Download") }}
                    </div>
                    <div class="form-group">
                        {{ form.seo_description.label(class="form-label") }}
                        {{ form.seo_description(class="form-textarea", rows=3, placeholder="Download free modern 3-bedroom house plans...") }}
                    </div>
                    <div class="form-group">
                        {{ form.seo_keywords.label(class="form-label") }}
                        {{ form.seo_keywords(class="form-input", placeholder="house plans, modern home, 3 bedroom, free download") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions form-actions--sticky" id="section-publish" data-section-label="Publishing Settings">
            <div class="form-toggles">
                <label class="form-checkbox">
                    {{ form.is_published() }}
                    <span class="form-checkbox__label">{{ form.is_published.label.text }}</span>
                    <p class="form-checkbox__help">Make this plan visible on the website</p>
                </label>
                <label class="form-checkbox">
                    {{ form.is_featured() }}
                    <span class="form-checkbox__label">{{ form.is_featured.label.text }}</span>
                    <p class="form-checkbox__help">Show in featured section</p>
                </label>
            </div>
            <div class="form-submit">
                <div class="form-submit__row">
                    {{ form.save_draft(class="btn btn-outline") }}
                    {{ form.submit(class="btn btn-primary") }}
                </div>
                <div class="form-status">
                    <span class="status-indicator">Status: <strong>Draft</strong></span>
                </div>
            </div>
        </div>

        <style>
            /* Pack grid (admin add plan) */
            .form-pack-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 16px;
            }

            .form-pack-card {
                border: 1px solid rgba(0, 0, 0, 0.10);
                border-radius: 16px;
                padding: 16px;
                background: rgba(255, 255, 255, 0.85);
            }

            .form-pack-card h3 {
                margin: 0 0 12px 0;
                font-size: 14px;
                letter-spacing: 0.3px;
                text-transform: uppercase;
                opacity: 0.85;
            }
        </style>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" referrerpolicy="no-referrer">
<style>
    /* Collapsible section UX (admin add plan) */
    .form-card.is-collapsible > .form-card__header {
        cursor: pointer;
        user-select: none;
    }

    .form-card.is-collapsible.is-collapsed > :not(.form-card__header) {
        display: none !important;
    }

    .form-card__toggle {
        margin-left: auto;
        border: 1px solid rgba(0, 0, 0, 0.12);
        background: rgba(255, 255, 255, 0.9);
        color: inherit;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .form-card__toggle:focus {
        outline: 2px solid rgba(0, 90, 255, 0.35);
        outline-offset: 2px;
    }

    .form-card__chevron {
        display: inline-block;
        transform: rotate(0deg);
        transition: transform 140ms ease;
    }

    .form-card.is-collapsible.is-collapsed .form-card__chevron {
        transform: rotate(-90deg);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js" referrerpolicy="no-referrer"></script>
<script>
    (function () {
        // Collapsible sections
        const cards = Array.from(document.querySelectorAll('.form-card'));
        if (!cards.length) return;

        function storageKey(card) {
            const id = card.getAttribute('id') || '';
            return `adminAddPlan:collapsed:${id}`;
        }

        function setCollapsed(card, collapsed) {
            card.classList.toggle('is-collapsible', true);
            card.classList.toggle('is-collapsed', !!collapsed);
            const btn = card.querySelector('.form-card__toggle');
            if (btn) {
                btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
                btn.setAttribute('aria-label', collapsed ? 'Expand section' : 'Collapse section');
            }
        }

        // Initialize toggles
        cards.forEach((card, idx) => {
            const header = card.querySelector(':scope > .form-card__header');
            if (!header) return;

            card.classList.add('is-collapsible');

            // Add toggle button once
            if (!header.querySelector('.form-card__toggle')) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'form-card__toggle';
                btn.innerHTML = '<span class="form-card__chevron">‚ñæ</span><span>Toggle</span>';
                header.appendChild(btn);
            }

            const btn = header.querySelector('.form-card__toggle');
            const saved = (() => {
                try {
                    return localStorage.getItem(storageKey(card));
                } catch (e) {
                    return null;
                }
            })();

            // Default: keep first section open, collapse others.
            const defaultCollapsed = idx !== 0;
            const initialCollapsed = saved === null ? defaultCollapsed : (saved === '1');
            setCollapsed(card, initialCollapsed);

            function toggle() {
                const next = !card.classList.contains('is-collapsed');
                setCollapsed(card, next);
                try {
                    localStorage.setItem(storageKey(card), next ? '1' : '0');
                } catch (e) {
                    // ignore
                }
            }

            // Toggle on button click
            btn.addEventListener('click', function (ev) {
                ev.preventDefault();
                ev.stopPropagation();
                toggle();
            });

            // Optional: toggle when clicking header (but ignore when selecting text)
            header.addEventListener('click', function (ev) {
                if (ev.target && ev.target.closest && ev.target.closest('a, button, input, textarea, select, label')) {
                    return;
                }
                toggle();
            });
        });

        // If a deep link jumps to a collapsed card, expand it.
        function expandHashTarget() {
            const hash = (window.location.hash || '').trim();
            if (!hash || hash.length < 2) return;
            const target = document.getElementById(hash.slice(1));
            if (target && target.classList.contains('form-card') && target.classList.contains('is-collapsed')) {
                setCollapsed(target, false);
                try {
                    localStorage.setItem(storageKey(target), '0');
                } catch (e) {
                    // ignore
                }
            }
        }

        window.addEventListener('hashchange', expandHashTarget);
        expandHashTarget();
    })();

    (function () {
        function initCropperField(wrapper) {
            const inputId = wrapper.getAttribute('data-input-id');
            const previewId = wrapper.getAttribute('data-preview-id');
            const fileInput = document.getElementById(inputId);
            const previewImg = document.getElementById(previewId);
            const openBtn = wrapper.querySelector('[data-crop-open]');
            const resetBtn = wrapper.querySelector('[data-crop-reset]');

            if (!fileInput || !previewImg || !openBtn || !resetBtn) return;

            let originalFile = null;
            let originalSrc = previewImg.dataset.initialSrc || '';
            if (originalSrc) {
                setPreview(originalSrc);
            }
            let cropper = null;

            function setPreview(src) {
                if (!src) {
                    previewImg.removeAttribute('src');
                    return;
                }
                previewImg.src = src;
            }

            function openModal() {
                const modal = document.querySelector('[data-crop-modal]');
                if (!modal) return;
                const modalImage = modal.querySelector('[data-crop-image]');
                const previewDesktop = modal.querySelector('[data-crop-preview-desktop]');
                const previewMobile = modal.querySelector('[data-crop-preview-mobile]');
                const activeSrc = previewImg.getAttribute('src') || '';
                if (!activeSrc) return;

                modalImage.src = activeSrc;
                modalImage.crossOrigin = 'anonymous';
                modal.removeAttribute('hidden');
                document.body.classList.add('cropper-open');

                cropper = new Cropper(modalImage, {
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    background: false,
                    movable: true,
                    zoomable: true,
                    rotatable: false,
                    scalable: false,
                    preview: [previewDesktop, previewMobile],
                });
            }

            function closeModal() {
                const modal = document.querySelector('[data-crop-modal]');
                if (!modal) return;
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                modal.setAttribute('hidden', 'hidden');
                document.body.classList.remove('cropper-open');
            }

            function applyCrop() {
                if (!cropper) return;
                const canvas = cropper.getCroppedCanvas({
                    maxWidth: 1600,
                    maxHeight: 1200,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high'
                });
                if (!canvas) {
                    closeModal();
                    return;
                }
                canvas.toBlob(function (blob) {
                    if (!blob) {
                        closeModal();
                        return;
                    }
                    const fileName = (originalFile && originalFile.name) ? originalFile.name.replace(/\.(\w+)$/, '-crop.$1') : 'cover-crop.jpg';
                    const croppedFile = new File([blob], fileName, { type: blob.type });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(croppedFile);
                    fileInput.files = dataTransfer.files;
                    setPreview(URL.createObjectURL(croppedFile));
                    closeModal();
                }, 'image/jpeg', 0.9);
            }

            fileInput.addEventListener('change', function () {
                const file = fileInput.files && fileInput.files[0];
                if (!file) return;
                originalFile = file;
                originalSrc = URL.createObjectURL(file);
                setPreview(originalSrc);
            });

            openBtn.addEventListener('click', function () {
                openModal();
            });

            resetBtn.addEventListener('click', function () {
                if (originalSrc) {
                    setPreview(originalSrc);
                    if (originalFile) {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(originalFile);
                        fileInput.files = dataTransfer.files;
                    }
                } else {
                    fileInput.value = '';
                    setPreview('');
                }
            });

            document.addEventListener('click', function (e) {
                const target = e.target;
                if (!(target instanceof HTMLElement)) return;
                if (target.matches('[data-crop-cancel], [data-crop-close]')) {
                    e.preventDefault();
                    closeModal();
                }
                if (target.matches('[data-crop-apply]')) {
                    e.preventDefault();
                    applyCrop();
                }
                if (target.matches('[data-aspect]') && cropper) {
                    e.preventDefault();
                    const ratio = target.getAttribute('data-aspect');
                    const value = ratio === 'free' ? NaN : Number(ratio);
                    cropper.setAspectRatio(value);
                    target.closest('.cropper-modal__ratios')?.querySelectorAll('button').forEach(btn => btn.classList.remove('is-active'));
                    target.classList.add('is-active');
                }
            });
        }

        document.querySelectorAll('[data-cropper]').forEach(initCropperField);

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const id = entry.target.getAttribute('id');
                const chip = document.querySelector(`.admin-form__chip[href="#${id}"]`);
                if (!chip) return;
                if (entry.isIntersecting) {
                    chip.classList.add('is-active');
                } else {
                    chip.classList.remove('is-active');
                }
            });
        }, { rootMargin: '-30% 0px -50% 0px', threshold: [0, 0.25, 0.5, 0.75, 1] });

        document.querySelectorAll('.form-card').forEach(section => observer.observe(section));

        const progressBar = document.querySelector('[data-progress-bar]');
        const progressPercent = document.querySelector('[data-progress-percent]');
        const progressCurrent = document.querySelector('[data-progress-current]');
        const progressTrack = document.querySelector('.admin-progress__track');
        const progressSections = Array.from(document.querySelectorAll('.form-card'));

        function updateProgress(index) {
            if (!progressBar || !progressPercent || !progressCurrent || !progressTrack) return;
            const total = progressSections.length;
            const safeIndex = Math.min(Math.max(index, 0), total - 1);
            const percent = total ? Math.round(((safeIndex + 1) / total) * 100) : 0;
            const label = progressSections[safeIndex]?.getAttribute('data-section-label') || 'Section';
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            progressCurrent.textContent = label;
            progressTrack.setAttribute('aria-valuenow', String(percent));
        }

        const progressObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting) return;
                const index = progressSections.indexOf(entry.target);
                if (index >= 0) updateProgress(index);
            });
        }, { rootMargin: '-40% 0px -40% 0px', threshold: [0.1, 0.4, 0.7] });

        progressSections.forEach(section => progressObserver.observe(section));


        function parseNumber(value) {
            const num = Number.parseFloat(value);
            return Number.isFinite(num) ? num : null;
        }

        function formatFeetInches(meters) {
            if (meters === null || meters === undefined) return '';
            const totalInches = meters * 39.3700787;
            let feet = Math.floor(totalInches / 12);
            let inches = Math.round(totalInches - (feet * 12));
            if (inches === 12) {
                feet += 1;
                inches = 0;
            }
            return `${feet} ft ${inches} in`;
        }

        function formatSqFt(squareMeters) {
            const sqft = squareMeters * 10.7639;
            return Math.round(sqft).toLocaleString();
        }

        function initMetricImperialPreview() {
            const widthInput = document.getElementById('building_width');
            const lengthInput = document.getElementById('building_length');
            const areaInput = document.getElementById('total_area_m2');

            const widthOutput = document.querySelector('[data-imperial-output="building_width"]');
            const lengthOutput = document.querySelector('[data-imperial-output="building_length"]');
            const areaOutput = document.querySelector('[data-imperial-output="total_area_m2"]');
            const footprintOutput = document.querySelector('[data-imperial-footprint]');

            if (!widthInput && !lengthInput && !areaInput) return;

            function update() {
                const width = widthInput ? parseNumber(widthInput.value) : null;
                const length = lengthInput ? parseNumber(lengthInput.value) : null;
                const areaM2 = areaInput ? parseNumber(areaInput.value) : null;
                const computedAreaM2 = (width !== null && length !== null) ? width * length : null;
                const displayAreaM2 = areaM2 !== null ? areaM2 : computedAreaM2;

                if (widthOutput) {
                    widthOutput.textContent = width !== null ? `‚âà ${formatFeetInches(width)}` : '';
                }
                if (lengthOutput) {
                    lengthOutput.textContent = length !== null ? `‚âà ${formatFeetInches(length)}` : '';
                }
                if (footprintOutput) {
                    footprintOutput.textContent = (width !== null && length !== null)
                        ? `‚âà ${formatFeetInches(width)} √ó ${formatFeetInches(length)}`
                        : '';
                }
                if (areaOutput) {
                    if (displayAreaM2 !== null) {
                        const suffix = areaM2 !== null ? '' : ' (from width √ó length)';
                        areaOutput.textContent = `‚âà ${formatSqFt(displayAreaM2)} sq ft${suffix}`;
                    } else {
                        areaOutput.textContent = '';
                    }
                }
            }

            [widthInput, lengthInput, areaInput].forEach((input) => {
                if (!input) return;
                input.addEventListener('input', update);
                input.addEventListener('change', update);
            });

            update();
        }

        initMetricImperialPreview();
    })();
</script>

<div class="cropper-modal" data-crop-modal hidden>
    <div class="cropper-modal__backdrop" data-crop-close></div>
    <div class="cropper-modal__panel" role="dialog" aria-modal="true" aria-label="Crop image">
        <header class="cropper-modal__header">
            <h3>Crop image</h3>
            <button type="button" class="btn btn-ghost" data-crop-close>Close</button>
        </header>
        <div class="cropper-modal__body">
            <div class="cropper-modal__image">
                <img data-crop-image alt="Cropper preview">
            </div>
            <aside class="cropper-modal__preview">
                <p class="muted">Desktop preview</p>
                <div class="cropper-preview cropper-preview--desktop" data-crop-preview-desktop></div>
                <p class="muted">Mobile preview</p>
                <div class="cropper-preview cropper-preview--mobile" data-crop-preview-mobile></div>
            </aside>
        </div>
        <div class="cropper-modal__controls">
            <div class="cropper-modal__ratios" role="group" aria-label="Aspect ratios">
                <button type="button" class="btn btn-ghost is-active" data-aspect="free">Free</button>
                <button type="button" class="btn btn-ghost" data-aspect="1">1:1</button>
                <button type="button" class="btn btn-ghost" data-aspect="1.3333">4:3</button>
                <button type="button" class="btn btn-ghost" data-aspect="1.7778">16:9</button>
            </div>
            <div class="cropper-modal__actions">
                <button type="button" class="btn btn-soft" data-crop-cancel>Cancel</button>
                <button type="button" class="btn btn-primary" data-crop-apply>Apply crop</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
