{% extends "base.html" %}

{% block content %}
<div class="shell admin-shell">
    <header class="admin-header admin-header--form">
        <div class="admin-header__content">
            <p class="admin-eyebrow"><i class="fa-solid fa-pen-nib" aria-hidden="true"></i> Blog CMS</p>
            <h1 class="admin-title">{{ 'Edit Article' if post else 'Create Article' }}</h1>
            <p class="admin-subtitle">Write high-converting content and link it to a plan.</p>
        </div>
    </header>

    {% if form.errors %}
    <div class="form-alert form-alert--error" role="alert">
        <div class="form-alert__icon">‚ö†Ô∏è</div>
        <div class="form-alert__content">
            <p class="form-alert__title">Please fix the following errors:</p>
            <ul class="form-alert__list">
                {% for field_errors in form.errors.values() %}
                    {% for err in field_errors %}
                    <li>{{ err }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <form class="admin-form admin-form--add-plan" method="post" enctype="multipart/form-data" data-admin-article-form>
        {{ form.hidden_tag() }}

        <div class="admin-form__layout">
            <div class="admin-form__main">
                <div class="form-card">
                    <div class="form-card__header">
                        <div class="form-card__heading">
                            <div class="form-card__icon">üì∞</div>
                            <div>
                                <h2 class="form-card__title">Article details</h2>
                                <p class="form-card__subtitle">Title, slug, and plan linking.</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-grid form-grid--2">
                        <div class="form-group">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-input", placeholder="A modern layout for compact family homes") }}
                        </div>
                        <div class="form-group">
                            {{ form.slug.label(class="form-label") }}
                            {{ form.slug(class="form-input", placeholder="auto-generated if empty") }}
                        </div>
                        <div class="form-group form-group--full">
                            {{ form.plan_id.label(class="form-label") }}
                            {{ form.plan_id(class="form-select") }}
                        </div>
                        <div class="form-group">
                            {{ form.status.label(class="form-label") }}
                            {{ form.status(class="form-select") }}
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <div class="form-card__header">
                        <div class="form-card__heading">
                            <div class="form-card__icon">üñºÔ∏è</div>
                            <div>
                                <h2 class="form-card__title">Cover image</h2>
                                <p class="form-card__subtitle">Upload a hero image for the article.</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group dropzone" data-dropzone>
                        {{ form.cover_image.label(class="form-label") }}
                        {{ form.cover_image(class="form-input", data_drop_input="true") }}
                        <p class="form-help">Drag and drop an image or click to browse.</p>
                        <span class="dropzone__file" data-dropzone-filename>No file selected</span>
                    </div>
                </div>

                <div class="form-card">
                    <div class="form-card__header">
                        <div class="form-card__heading">
                            <div class="form-card__icon">‚úçÔ∏è</div>
                            <div>
                                <h2 class="form-card__title">Content</h2>
                                <p class="form-card__subtitle">Use rich text to build a readable article.</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="form-textarea js-ckeditor", rows=18) }}
                        <p class="form-help">Autosave is local-only (your browser). Publishing is manual.</p>
                    </div>
                </div>

                <details class="form-card" open>
                    <summary class="form-card__summary">SEO settings</summary>
                    <div class="form-grid form-grid--2">
                        <div class="form-group">
                            {{ form.meta_title.label(class="form-label") }}
                            {{ form.meta_title(class="form-input", placeholder="SEO title for Google") }}
                            <p class="form-help" data-soft-warning="meta-title"></p>
                        </div>
                        <div class="form-group">
                            {{ form.meta_description.label(class="form-label") }}
                            {{ form.meta_description(class="form-textarea", rows=3, placeholder="Short description for search results") }}
                            <p class="form-help" data-soft-warning="meta-description"></p>
                        </div>
                    </div>

                    <details style="margin-top: 1rem;">
                        <summary class="form-card__summary">Advanced SEO overrides (optional, non-DB)</summary>
                        {% set _seo = (extras or {}).get('seo', {}) if extras is defined else {} %}
                        <div class="form-grid form-grid--2" style="margin-top: .75rem;">
                            <div class="form-group">
                                <label class="form-label" for="extras__seo_meta_title">Meta title override</label>
                                <input class="form-input" id="extras__seo_meta_title" name="extras__seo_meta_title" value="{{ _seo.get('meta_title','') }}" placeholder="If empty, uses article title" maxlength="200">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="extras__seo_meta_description">Meta description override</label>
                                <textarea class="form-textarea" id="extras__seo_meta_description" name="extras__seo_meta_description" rows="3" placeholder="If empty, uses the DB meta description">{{ _seo.get('meta_description','') }}</textarea>
                            </div>
                            <div class="form-group form-group--full">
                                <label class="form-label" for="extras__seo_canonical_url">Canonical URL override</label>
                                <input class="form-input" id="extras__seo_canonical_url" name="extras__seo_canonical_url" value="{{ _seo.get('canonical_url','') }}" placeholder="https://... (leave empty to auto-generate)" maxlength="2000">
                                <p class="form-help">Use only when you intentionally canonicalize to another URL.</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="extras__seo_robots">Robots meta (optional)</label>
                                <input class="form-input" id="extras__seo_robots" name="extras__seo_robots" value="{{ _seo.get('robots','') }}" placeholder="index,follow | noindex,nofollow" maxlength="80">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="extras__seo_og_image">Open Graph image URL (optional)</label>
                                <input class="form-input" id="extras__seo_og_image" name="extras__seo_og_image" value="{{ _seo.get('og_image','') }}" placeholder="https://..." maxlength="2000">
                            </div>
                        </div>
                    </details>
                </details>

                <details class="form-card">
                    <summary class="form-card__summary">Affiliate links (optional)</summary>
                    {% set _aff = (extras or {}).get('affiliate', {}) if extras is defined else {} %}
                    <div class="form-grid form-grid--2" style="margin-top: .75rem;">
                        <div class="form-group">
                            <label class="form-label" for="extras__affiliate_product_title">Product title</label>
                            <input class="form-input" id="extras__affiliate_product_title" name="extras__affiliate_product_title" value="{{ _aff.get('product_title','') }}" placeholder="e.g. Favorite construction toolkit" maxlength="200">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="extras__affiliate_url">Affiliate URL</label>
                            <input class="form-input" id="extras__affiliate_url" name="extras__affiliate_url" value="{{ _aff.get('affiliate_url','') }}" placeholder="https://..." maxlength="2000">
                        </div>
                        <div class="form-group form-group--full">
                            <label class="form-label" for="extras__affiliate_short_description">Short description</label>
                            <textarea class="form-textarea" id="extras__affiliate_short_description" name="extras__affiliate_short_description" rows="3" placeholder="1‚Äì2 lines to explain the value">{{ _aff.get('short_description','') }}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="extras__affiliate_button_text">Button text</label>
                            <input class="form-input" id="extras__affiliate_button_text" name="extras__affiliate_button_text" value="{{ _aff.get('button_text','') }}" placeholder="Shop now" maxlength="60">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="extras__affiliate_position">Display position</label>
                            <select class="form-select" id="extras__affiliate_position" name="extras__affiliate_position">
                                {% set _pos = _aff.get('display_position','after') %}
                                <option value="before" {% if _pos == 'before' %}selected{% endif %}>Before content</option>
                                <option value="after" {% if _pos == 'after' %}selected{% endif %}>After content</option>
                            </select>
                        </div>
                    </div>
                </details>

                <details class="form-card">
                    <summary class="form-card__summary">FAQ section (optional)</summary>
                    {% set _faq = (extras or {}).get('faq', []) if extras is defined else [] %}
                    <p class="form-help" style="margin-top:.75rem;">If you leave questions/answers empty, nothing is rendered on the frontend. FAQ schema is generated only when at least one Q/A exists.</p>
                    <input type="hidden" name="extras__faq_json" value="" data-faq-json>
                    <div class="faq-editor" data-faq-editor>
                        <div class="faq-editor__rows" data-faq-rows>
                            {% for item in (_faq if _faq else []) %}
                                <div class="faq-row" data-faq-row>
                                    <div class="form-grid form-grid--2">
                                        <div class="form-group">
                                            <label class="form-label">Question</label>
                                            <input class="form-input" value="{{ item.get('question','') }}" data-faq-q>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Answer</label>
                                            <textarea class="form-textarea" rows="2" data-faq-a>{{ item.get('answer','') }}</textarea>
                                        </div>
                                    </div>
                                    <div style="display:flex; justify-content:flex-end; gap:.5rem;">
                                        <button class="btn btn-ghost" type="button" data-faq-remove>Remove</button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <div style="display:flex; gap:.75rem; flex-wrap:wrap; margin-top: .75rem;">
                            <button class="btn btn-secondary" type="button" data-faq-add>Add FAQ</button>
                            <span class="form-help">No-JS fallback: you can still save the article; FAQ editing just won‚Äôt be enhanced.</span>
                        </div>
                    </div>
                </details>

                <details class="form-card">
                    <summary class="form-card__summary">Image management (optional)</summary>
                    {% set _img = (extras or {}).get('images', {}) if extras is defined else {} %}
                    <div class="form-grid form-grid--2" style="margin-top:.75rem;">
                        <div class="form-group form-group--full">
                            <label class="form-label" for="extras__featured_image">Featured image URL (optional)</label>
                            <input class="form-input" id="extras__featured_image" name="extras__featured_image" value="{{ _img.get('featured','') }}" placeholder="https://..." maxlength="2000">
                            <p class="form-help">Used as Open Graph image fallback and optional in-page media (does not replace existing inline images).</p>
                        </div>
                        <div class="form-group form-group--full">
                            <label class="form-label" for="extras__gallery_images">Gallery images (one URL per line)</label>
                            <textarea class="form-textarea" id="extras__gallery_images" name="extras__gallery_images" rows="5" placeholder="https://...\nhttps://...">{% if _img.get('gallery') %}{{ _img.get('gallery')|join('\n') }}{% endif %}</textarea>
                            <p class="form-help">Reordering is enhanced with JS; without JS, the line order is used.</p>
                        </div>
                    </div>
                </details>

                <div class="form-actions form-actions--sticky" data-sticky-save>
                    <div class="form-submit__row">
                        {{ form.submit(class="btn btn-primary") }}
                        <a class="btn btn-ghost" href="{{ url_for('blog.index') }}">Back to blog</a>
                        <span class="form-help" style="margin-left:auto" data-autosave-status></span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script>
    (function () {
        const textarea = document.querySelector('textarea.js-ckeditor[name="content"]');
        if (!textarea) {
            console.error('CKEditor: textarea not found');
            return;
        }
        console.log('CKEditor: textarea found', textarea);

        // Progressive enhancement: if the CDN fails or is blocked by CSP,
        // the textarea remains fully functional.
        if (typeof ClassicEditor === 'undefined') {
            console.error('CKEditor: ClassicEditor not loaded from CDN');
            return;
        }
        console.log('CKEditor: ClassicEditor is available, initializing...');

        const originalValue = textarea.value;
        let dirty = false;
        let ignoreChanges = true;

        ClassicEditor
            .create(textarea, {
                toolbar: {
                    items: [
                        'heading',
                        '|',
                        'bold', 'italic', 'underline', 'strikethrough',
                        '|',
                        'bulletedList', 'numberedList',
                        '|',
                        'link', 'blockQuote', 'insertTable',
                        '|',
                        'undo', 'redo'
                    ]
                },
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                        { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' }
                    ]
                },
                link: {
                    addTargetToExternalLinks: true,
                    defaultProtocol: 'https://'
                },
                table: {
                    contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                }
            })
            .then((editor) => {
                // Avoid marking the form dirty due to initialization-time changes.
                requestAnimationFrame(() => { ignoreChanges = false; });

                editor.model.document.on('change:data', () => {
                    if (ignoreChanges) return;
                    dirty = true;
                    textarea.value = editor.getData();
                });

                const form = textarea.closest('form');
                if (form) {
                    form.addEventListener('submit', () => {
                        // Backward-compat guarantee: if admin didn't edit content,
                        // submit the original HTML unchanged.
                        textarea.value = dirty ? editor.getData() : originalValue;
                    });
                }
            })
            .catch(() => {
                // Fail closed: leave textarea as-is.
            });
    })();

    (function () {
        const dropzone = document.querySelector('[data-dropzone]');
        if (!dropzone) return;
        const input = dropzone.querySelector('input[type="file"]');
        const fileLabel = dropzone.querySelector('[data-dropzone-filename]');
        if (!input || !fileLabel) return;

        function updateLabel() {
            const file = input.files && input.files[0];
            fileLabel.textContent = file ? file.name : 'No file selected';
        }

        dropzone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropzone.classList.add('is-dragging');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('is-dragging');
        });

        dropzone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropzone.classList.remove('is-dragging');
            if (event.dataTransfer.files.length) {
                input.files = event.dataTransfer.files;
                updateLabel();
            }
        });

        input.addEventListener('change', updateLabel);
        updateLabel();
    })();

    (function () {
        // Soft SEO warnings (non-blocking)
        const titleInput = document.querySelector('input[name="meta_title"]');
        const descInput = document.querySelector('textarea[name="meta_description"]');
        const titleWarn = document.querySelector('[data-soft-warning="meta-title"]');
        const descWarn = document.querySelector('[data-soft-warning="meta-description"]');

        function warn(el, target, min, max) {
            if (!el || !target) return;
            const len = (el.value || '').trim().length;
            if (!len) {
                target.textContent = '';
                return;
            }
            if (len < min) target.textContent = `Tip: ${len} chars (try ${min}-${max}).`;
            else if (len > max) target.textContent = `Warning: ${len} chars (try ${min}-${max}).`;
            else target.textContent = `OK: ${len} chars.`;
        }

        function update() {
            warn(titleInput, titleWarn, 30, 60);
            warn(descInput, descWarn, 90, 160);
        }

        if (titleInput) titleInput.addEventListener('input', update);
        if (descInput) descInput.addEventListener('input', update);
        update();
    })();

    (function () {
        // Admin autosave (localStorage only). Never blocks submit.
        const form = document.querySelector('[data-admin-article-form]');
        if (!form) return;

        const status = document.querySelector('[data-autosave-status]');
        const key = (() => {
            // Prefer stable key for edits; fall back to URL for create.
            const postId = (document.querySelector('input[name="post_id"]') || {}).value;
            return postId ? `admin_blog_draft_${postId}` : `admin_blog_draft_${location.pathname}`;
        })();

        function setStatus(text) {
            if (status) status.textContent = text;
        }

        function snapshot() {
            const data = {};
            const fields = form.querySelectorAll('input, textarea, select');
            fields.forEach((el) => {
                if (!el.name) return;
                if (el.type === 'password' || el.type === 'file') return;
                data[el.name] = el.value;
            });
            return data;
        }

        let saveTimer = null;
        function scheduleSave() {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                try {
                    localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data: snapshot() }));
                    setStatus('Draft saved locally');
                } catch (e) {
                    // ignore
                }
            }, 450);
        }

        form.addEventListener('input', scheduleSave);

        // Optional restore UI (non-intrusive)
        try {
            const raw = localStorage.getItem(key);
            if (raw) {
                const parsed = JSON.parse(raw);
                if (parsed && parsed.data) {
                    const restoreBtn = document.createElement('button');
                    restoreBtn.type = 'button';
                    restoreBtn.className = 'btn btn-ghost';
                    restoreBtn.textContent = 'Restore autosave';
                    restoreBtn.addEventListener('click', () => {
                        try {
                            const data = parsed.data || {};
                            Object.keys(data).forEach((name) => {
                                const el = form.querySelector(`[name="${CSS.escape(name)}"]`);
                                if (el && el.type !== 'file') el.value = data[name];
                            });
                            setStatus('Autosave restored');
                        } catch (e) {
                            // ignore
                        }
                    });
                    const row = form.querySelector('.form-submit__row');
                    if (row) row.insertBefore(restoreBtn, row.children[1] || null);
                    setStatus('Autosave available');
                }
            }
        } catch (e) {
            // ignore
        }

        form.addEventListener('submit', () => {
            // Keep the autosave copy (in case submit fails).
            setStatus('Saving‚Ä¶');
        });
    })();

    (function () {
        // FAQ repeatable fields (progressive enhancement)
        const root = document.querySelector('[data-faq-editor]');
        if (!root) return;
        const rows = root.querySelector('[data-faq-rows]');
        const addBtn = root.querySelector('[data-faq-add]');
        const hidden = document.querySelector('[data-faq-json]');
        if (!rows || !addBtn || !hidden) return;

        function serialize() {
            const items = [];
            rows.querySelectorAll('[data-faq-row]').forEach((row) => {
                const q = (row.querySelector('[data-faq-q]') || {}).value || '';
                const a = (row.querySelector('[data-faq-a]') || {}).value || '';
                const qq = q.trim();
                const aa = a.trim();
                if (qq && aa) items.push({ question: qq, answer: aa });
            });
            hidden.value = JSON.stringify(items);
        }

        function bindRow(row) {
            const remove = row.querySelector('[data-faq-remove]');
            if (remove) {
                remove.addEventListener('click', () => {
                    row.remove();
                    serialize();
                });
            }
            row.addEventListener('input', serialize);
        }

        rows.querySelectorAll('[data-faq-row]').forEach(bindRow);

        addBtn.addEventListener('click', () => {
            const row = document.createElement('div');
            row.className = 'faq-row';
            row.setAttribute('data-faq-row', '');
            row.innerHTML = `
                <div class="form-grid form-grid--2">
                    <div class="form-group">
                        <label class="form-label">Question</label>
                        <input class="form-input" value="" data-faq-q>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Answer</label>
                        <textarea class="form-textarea" rows="2" data-faq-a></textarea>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:.5rem;">
                    <button class="btn btn-ghost" type="button" data-faq-remove>Remove</button>
                </div>
            `;
            rows.appendChild(row);
            bindRow(row);
            serialize();
        });

        // Initial sync so server receives structured FAQ even if fields prefilled.
        serialize();
    })();
</script>
{% endblock %}
