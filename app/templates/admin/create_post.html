{% extends "base.html" %}

{% block content %}
<div class="shell admin-shell">
    <header class="admin-header admin-header--form">
        <div class="admin-header__content">
            <p class="admin-eyebrow"><i class="fa-solid fa-pen-nib" aria-hidden="true"></i> Blog CMS</p>
            <h1 class="admin-title">{{ 'Edit Article' if post else 'Create Article' }}</h1>
            <p class="admin-subtitle">Write high-converting content and link it to a plan.</p>
        </div>
    </header>

    {% if form.errors %}
    <div class="form-alert form-alert--error" role="alert">
        <div class="form-alert__icon">‚ö†Ô∏è</div>
        <div class="form-alert__content">
            <p class="form-alert__title">Please fix the following errors:</p>
            <ul class="form-alert__list">
                {% for field_errors in form.errors.values() %}
                    {% for err in field_errors %}
                    <li>{{ err }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <form class="admin-form admin-form--add-plan" method="post" enctype="multipart/form-data" data-admin-article-form>
        {{ form.hidden_tag() }}
        <input type="hidden" name="extras__present" value="1">

        <div class="admin-form__layout">
            <div class="admin-form__main">
                <div class="form-card">
                    <div class="form-card__header">
                        <div class="form-card__heading">
                            <div class="form-card__icon">üì∞</div>
                            <div>
                                <h2 class="form-card__title">Article information</h2>
                                <p class="form-card__subtitle">Editorial intent, status, and linking.</p>
                            </div>
                        </div>
                    </div>
                    {% set _intent = (extras or {}).get('intent', 'other') if extras is defined else 'other' %}
                    <div class="form-grid form-grid--2">
                        <div class="form-group">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-input", placeholder="A modern layout for compact family homes") }}
                            <p class="form-help">Titre visible sur le site et dans Google. Clair, sp√©cifique, sans promesse excessive.</p>
                        </div>
                        <div class="form-group">
                            {{ form.slug.label(class="form-label") }}
                            {{ form.slug(class="form-input", placeholder="auto-generated if empty") }}
                            <p class="form-help">Texte dans l‚ÄôURL (ex: "maison-compacte-3-chambres"). Laisse vide pour auto-g√©n√©ration.</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="extras__intent">Article intent</label>
                            <select class="form-select" id="extras__intent" name="extras__intent">
                                <option value="guide" {% if _intent == 'guide' %}selected{% endif %}>Guide (educate)</option>
                                <option value="howto" {% if _intent == 'howto' %}selected{% endif %}>How-to (steps)</option>
                                <option value="inspiration" {% if _intent == 'inspiration' %}selected{% endif %}>Inspiration (ideas)</option>
                                <option value="review" {% if _intent == 'review' %}selected{% endif %}>Review (balanced)</option>
                                <option value="news" {% if _intent == 'news' %}selected{% endif %}>News / update</option>
                                <option value="other" {% if _intent == 'other' %}selected{% endif %}>Other</option>
                            </select>
                            <p class="form-help">But de l‚Äôarticle (guide, how-to‚Ä¶). Aide √† garder un ton √©ditorial coh√©rent.</p>
                        </div>
                        <div class="form-group form-group--full">
                            {{ form.plan_id.label(class="form-label") }}
                            {{ form.plan_id(class="form-select") }}
                            <p class="form-help">Plan mis en avant dans le bloc "Featured Plan" (optionnel). Choisir un plan pertinent.</p>
                        </div>
                        <div class="form-group">
                            {{ form.status.label(class="form-label") }}
                            {{ form.status(class="form-select") }}
                            <p class="form-help">Brouillon = non public. Publi√© = visible sur le site.</p>
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <div class="form-card__header">
                        <div class="form-card__heading">
                            <div class="form-card__icon">üñºÔ∏è</div>
                            <div>
                                <h2 class="form-card__title">Cover image</h2>
                                <p class="form-card__subtitle">Upload a hero image for the article.</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group dropzone" data-dropzone>
                        {{ form.cover_image.label(class="form-label") }}
                        {{ form.cover_image(class="form-input", data_drop_input="true") }}
                        <p class="form-help">Image principale de l‚Äôarticle (id√©alement 1200√ó630). Glisser-d√©poser ou cliquer pour choisir.</p>
                        <span class="dropzone__file" data-dropzone-filename>No file selected</span>
                    </div>
                </div>

                <div class="form-card">
                    <div class="form-card__header">
                        <div class="form-card__heading">
                            <div class="form-card__icon">‚úçÔ∏è</div>
                            <div>
                                <h2 class="form-card__title">Main editorial content</h2>
                                <p class="form-card__subtitle">Editorial text only ‚Äî keep affiliate links in the Recommendations section.</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="form-textarea js-ckeditor", rows=18) }}
                        <p class="form-help">Contenu √©ditorial uniquement (pas de liens affili√©s ici). Autosave = uniquement dans ton navigateur.</p>
                        <p class="form-help" data-soft-warning="editorial-affiliate"></p>
                    </div>
                </div>

                <details class="form-card">
                    <summary class="form-card__summary">Recommendations & affiliate links (optional)</summary>
                    <p class="form-help" style="margin-top:.75rem;">Separate ‚Äúeducate‚Äù from ‚Äúrecommend‚Äù. Keep wording calm and factual. Recommendations are never inserted into the editorial text automatically.</p>

                    {% set _recs = (extras or {}).get('recommendations', []) if extras is defined else [] %}
                    <textarea class="form-textarea" name="extras__recs_json" rows="4" style="display:none" data-recs-json>{{ (_recs|default([]))|tojson }}</textarea>

                    <div class="recs-editor" data-recs-editor>
                        <div class="form-help" data-recs-warning></div>
                        <div class="recs-editor__rows" data-recs-rows>
                            {% for rec in (_recs if _recs else []) %}
                                <div class="recs-row" data-recs-row>
                                    <div class="form-grid form-grid--2">
                                        <div class="form-group">
                                            <label class="form-label">Type</label>
                                            {% set _t = rec.get('type','resource') %}
                                            <select class="form-select" data-rec-type>
                                                <option value="product" {% if _t == 'product' %}selected{% endif %}>Product</option>
                                                <option value="tool" {% if _t == 'tool' %}selected{% endif %}>Tool</option>
                                                <option value="service" {% if _t == 'service' %}selected{% endif %}>Service</option>
                                                <option value="resource" {% if _t == 'resource' %}selected{% endif %}>Resource</option>
                                            </select>
                                            <p class="form-help">Cat√©gorie de recommandation (produit, outil, service, ressource).</p>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Display title (neutral)</label>
                                            <input class="form-input" value="{{ rec.get('title','') }}" placeholder="e.g. Building cost calculator" data-rec-title>
                                            <p class="form-help">Titre neutre (sans marketing). Ex: "Calculateur de co√ªt".</p>
                                        </div>
                                        <div class="form-group form-group--full">
                                            <label class="form-label">Affiliate URL</label>
                                            <input class="form-input" value="{{ rec.get('url','') }}" placeholder="https://..." data-rec-url>
                                            <p class="form-help">Lien √† ouvrir dans un nouvel onglet. Utiliser une URL compl√®te https://‚Ä¶</p>
                                        </div>
                                        <div class="form-group form-group--full">
                                            <label class="form-label">Short justification (why it helps)</label>
                                            <textarea class="form-textarea" rows="2" placeholder="1‚Äì2 sentences. Keep it factual." data-rec-justification>{{ rec.get('justification','') }}</textarea>
                                            <p class="form-help">1‚Äì2 phrases factuelles: pourquoi c‚Äôest utile, pour qui, dans quel cas.</p>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Display position</label>
                                            {% set _p = rec.get('position','end') %}
                                            <select class="form-select" data-rec-position>
                                                <option value="end" {% if _p == 'end' %}selected{% endif %}>End of article</option>
                                                <option value="dedicated" {% if _p == 'dedicated' %}selected{% endif %}>Dedicated block</option>
                                            </select>
                                            <p class="form-help">O√π afficher: fin d‚Äôarticle ou bloc d√©di√©.</p>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Active</label>
                                            <select class="form-select" data-rec-active>
                                                <option value="1" {% if rec.get('active', True) %}selected{% endif %}>Active</option>
                                                <option value="0" {% if not rec.get('active', True) %}selected{% endif %}>Inactive</option>
                                            </select>
                                            <p class="form-help">Actif = affich√© publiquement (dans la limite des 3 premiers actifs).</p>
                                        </div>
                                    </div>
                                    <div style="display:flex; justify-content:flex-end; gap:.5rem;">
                                        <button class="btn btn-ghost" type="button" data-rec-remove>Remove</button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <div style="display:flex; gap:.75rem; flex-wrap:wrap; margin-top: .75rem;">
                            <button class="btn btn-secondary" type="button" data-rec-add>Add recommendation</button>
                            <span class="form-help">Limit is 3 (soft warning). Only the first 3 active are shown publicly.</span>
                        </div>
                    </div>
                </details>

                <details class="form-card">
                    <summary class="form-card__summary">FAQ section (optional)</summary>
                    {% set _faq = (extras or {}).get('faq', []) if extras is defined else [] %}
                    <p class="form-help" style="margin-top:.75rem;">If you leave questions/answers empty, nothing is rendered on the frontend. FAQ schema is generated only when at least one Q/A exists.</p>
                    <input type="hidden" name="extras__faq_json" value="" data-faq-json>
                    <div class="faq-editor" data-faq-editor>
                        <div class="faq-editor__rows" data-faq-rows>
                            {% for item in (_faq if _faq else []) %}
                                <div class="faq-row" data-faq-row>
                                    <div class="form-grid form-grid--2">
                                        <div class="form-group">
                                            <label class="form-label">Question</label>
                                            <input class="form-input" value="{{ item.get('question','') }}" data-faq-q>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Answer</label>
                                            <textarea class="form-textarea" rows="2" data-faq-a>{{ item.get('answer','') }}</textarea>
                                        </div>
                                    </div>
                                    <div style="display:flex; justify-content:flex-end; gap:.5rem;">
                                        <button class="btn btn-ghost" type="button" data-faq-remove>Remove</button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <div style="display:flex; gap:.75rem; flex-wrap:wrap; margin-top: .75rem;">
                            <button class="btn btn-secondary" type="button" data-faq-add>Add FAQ</button>
                            <span class="form-help">No-JS fallback: you can still save the article; FAQ editing just won‚Äôt be enhanced.</span>
                        </div>
                    </div>
                </details>

                <details class="form-card">
                    <summary class="form-card__summary">Images & media (optional)</summary>
                    {% set _media = (extras or {}).get('media', {}) if extras is defined else {} %}
                    {% set _featured = _media.get('featured', {}) if _media else {} %}
                    {% set _gallery = _media.get('gallery', []) if _media else [] %}
                    <textarea class="form-textarea" name="extras__media_json" rows="4" style="display:none" data-media-json>{{ (_media|default({}))|tojson }}</textarea>

                    <div class="media-editor" data-media-editor style="margin-top:.75rem;">
                        <div class="form-grid form-grid--2">
                            <div class="form-group form-group--full">
                                <label class="form-label">Featured image URL</label>
                                <input class="form-input" value="{{ _featured.get('url','') }}" placeholder="https://..." data-featured-url>
                                <p class="form-help">Optionnel. Utilis√© comme image Open Graph si aucune cover n‚Äôest upload√©e.</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Featured alt text</label>
                                <input class="form-input" value="{{ _featured.get('alt','') }}" placeholder="Describe the image" data-featured-alt>
                                <p class="form-help">Texte pour l‚Äôaccessibilit√© (d√©crire l‚Äôimage en 1 phrase).</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Featured caption (optional)</label>
                                <input class="form-input" value="{{ _featured.get('caption','') }}" placeholder="Short caption" data-featured-caption>
                                <p class="form-help">L√©gende courte (optionnelle) affich√©e sous l‚Äôimage.</p>
                            </div>
                        </div>

                        <div style="margin-top:1rem;">
                            <p class="form-help">Gallery is optional. Provide alt/caption for accessibility and long-term SEO.</p>
                            <div class="media-editor__rows" data-gallery-rows>
                                {% for img in (_gallery if _gallery else []) %}
                                    <div class="media-row" data-gallery-row>
                                        <div class="form-grid form-grid--2">
                                            <div class="form-group form-group--full">
                                                <label class="form-label">Image URL</label>
                                                <input class="form-input" value="{{ img.get('url','') }}" placeholder="https://..." data-gallery-url>
                                                <p class="form-help">Lien direct vers l‚Äôimage (https://‚Ä¶).</p>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Alt text</label>
                                                <input class="form-input" value="{{ img.get('alt','') }}" placeholder="Describe the image" data-gallery-alt>
                                                <p class="form-help">D√©crire ce qu‚Äôon voit. Important pour SEO + accessibilit√©.</p>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Caption</label>
                                                <input class="form-input" value="{{ img.get('caption','') }}" placeholder="Optional" data-gallery-caption>
                                                <p class="form-help">L√©gende (optionnelle).</p>
                                            </div>
                                        </div>
                                        <div style="display:flex; justify-content:flex-end; gap:.5rem;">
                                            <button class="btn btn-ghost" type="button" data-gallery-remove>Remove</button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div style="display:flex; gap:.75rem; flex-wrap:wrap; margin-top:.75rem;">
                                <button class="btn btn-secondary" type="button" data-gallery-add>Add gallery image</button>
                                <span class="form-help">No-JS fallback: media still saves, but reordering isn‚Äôt enhanced.</span>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="form-card" open>
                    <summary class="form-card__summary">SEO & visibility</summary>
                    <div class="form-grid form-grid--2">
                        <div class="form-group">
                            {{ form.meta_title.label(class="form-label") }}
                            {{ form.meta_title(class="form-input", placeholder="SEO title for Google") }}
                            <p class="form-help" data-soft-warning="meta-title"></p>
                            <p class="form-help">Recommand√©: 30‚Äì60 caract√®res. Si vide, le titre de l‚Äôarticle peut √™tre utilis√©.</p>
                        </div>
                        <div class="form-group">
                            {{ form.meta_description.label(class="form-label") }}
                            {{ form.meta_description(class="form-textarea", rows=3, placeholder="Short description for search results") }}
                            <p class="form-help" data-soft-warning="meta-description"></p>
                            <p class="form-help">Recommand√©: 90‚Äì160 caract√®res. R√©sumer l‚Äôarticle en 1‚Äì2 phrases.</p>
                        </div>
                    </div>

                    <div class="form-card" style="margin-top: 1rem; padding: 1rem;">
                        <h3 style="margin:0 0 .25rem 0;">Search preview</h3>
                        <p class="form-help" style="margin:0 0 .75rem 0;">A preview to help editors write clearly (non-blocking).</p>
                        <div class="seo-preview" data-seo-preview>
                            <div class="seo-preview__title" data-preview-title></div>
                            <div class="seo-preview__url" style="opacity:.8; font-size:.9rem;">{{ request.host_url.rstrip('/') }}/blog/<span style="opacity:.9">{{ (post.slug if post else 'your-slug') }}</span></div>
                            <div class="seo-preview__desc" style="opacity:.92" data-preview-desc></div>
                        </div>
                    </div>

                    <details style="margin-top: 1rem;">
                        <summary class="form-card__summary">Advanced SEO overrides (optional, non-DB)</summary>
                        {% set _seo = (extras or {}).get('seo', {}) if extras is defined else {} %}
                        <div class="form-grid form-grid--2" style="margin-top: .75rem;">
                            <div class="form-group">
                                <label class="form-label" for="extras__seo_meta_title">Meta title override</label>
                                <input class="form-input" id="extras__seo_meta_title" name="extras__seo_meta_title" value="{{ _seo.get('meta_title','') }}" placeholder="If empty, uses article title" maxlength="200">
                                <p class="form-help">Optionnel. Remplace le meta title calcul√©.</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="extras__seo_meta_description">Meta description override</label>
                                <textarea class="form-textarea" id="extras__seo_meta_description" name="extras__seo_meta_description" rows="3" placeholder="If empty, uses the DB meta description">{{ _seo.get('meta_description','') }}</textarea>
                                <p class="form-help">Optionnel. Remplace la meta description DB.</p>
                            </div>
                            <div class="form-group form-group--full">
                                <label class="form-label" for="extras__seo_canonical_url">Canonical URL override</label>
                                <input class="form-input" id="extras__seo_canonical_url" name="extras__seo_canonical_url" value="{{ _seo.get('canonical_url','') }}" placeholder="https://... (leave empty to auto-generate)" maxlength="2000">
                                <p class="form-help">Use only when you intentionally canonicalize to another URL.</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="extras__seo_robots">Robots meta (optional)</label>
                                <input class="form-input" id="extras__seo_robots" name="extras__seo_robots" value="{{ _seo.get('robots','') }}" placeholder="index,follow | noindex,nofollow" maxlength="80">
                                <p class="form-help">Exemples: "index,follow" ou "noindex,nofollow".</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="extras__seo_og_image">Open Graph image URL (optional)</label>
                                <input class="form-input" id="extras__seo_og_image" name="extras__seo_og_image" value="{{ _seo.get('og_image','') }}" placeholder="https://..." maxlength="2000">
                                <p class="form-help">Image pour partage (Facebook/WhatsApp). Si vide, utilise cover/featured.</p>
                            </div>
                        </div>
                    </details>
                </details>

                <details class="form-card">
                    <summary class="form-card__summary">Internal editorial notes (optional)</summary>
                    {% set _notes = (extras or {}).get('notes', '') if extras is defined else '' %}
                    <p class="form-help" style="margin-top:.75rem;">Non visible publiquement. Pour checklist, fact-check, id√©es de mise √† jour.</p>
                    <div class="form-group" style="margin-top:.75rem;">
                        <label class="form-label" for="extras__notes">Editor notes</label>
                        <textarea class="form-textarea" id="extras__notes" name="extras__notes" rows="4" placeholder="Intent, updates to make, facts to verify‚Ä¶">{{ _notes }}</textarea>
                        <p class="form-help">Ex: sources √† ajouter, chiffres √† v√©rifier, am√©liorations SEO √† faire.</p>
                    </div>
                </details>

                <div class="form-actions form-actions--sticky" data-sticky-save>
                    <div class="form-submit__row">
                        {{ form.submit(class="btn btn-primary") }}
                        <a class="btn btn-ghost" href="{{ url_for('blog.index') }}">Back to blog</a>
                        <span class="form-help" style="margin-left:auto" data-autosave-status></span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script>
    (function () {
        const textarea = document.querySelector('textarea.js-ckeditor[name="content"]');
        if (!textarea) {
            console.error('CKEditor: textarea not found');
            return;
        }
        console.log('CKEditor: textarea found', textarea);

        // Progressive enhancement: if the CDN fails or is blocked by CSP,
        // the textarea remains fully functional.
        if (typeof ClassicEditor === 'undefined') {
            console.error('CKEditor: ClassicEditor not loaded from CDN');
            return;
        }
        console.log('CKEditor: ClassicEditor is available, initializing...');

        const originalValue = textarea.value;
        let dirty = false;
        let ignoreChanges = true;

        const editorialWarn = document.querySelector('[data-soft-warning="editorial-affiliate"]');
        function scanAffiliateLikeUrls(html) {
            if (!editorialWarn) return;
            const text = String(html || '').toLowerCase();
            const patterns = [
                'amzn.to',
                'amazon.',
                'bit.ly',
                't.co/',
                'ref=',
                'utm_',
                'affiliate',
                'tag=',
                'aff=',
                'affid=',
                'partner',
                'sponsored',
            ];
            const has = patterns.some((p) => text.includes(p));
            editorialWarn.textContent = has
                ? 'Soft warning: the editorial body contains link patterns that look like affiliate/tracking URLs. Keep affiliate links in ‚ÄúRecommendations‚Äù.'
                : '';
        }

        // Non-CKEditor fallback: still warn on manual edits.
        textarea.addEventListener('input', () => scanAffiliateLikeUrls(textarea.value));
        scanAffiliateLikeUrls(originalValue);

        ClassicEditor
            .create(textarea, {
                toolbar: {
                    items: [
                        'heading',
                        '|',
                        'bold', 'italic', 'underline', 'strikethrough',
                        '|',
                        'bulletedList', 'numberedList',
                        '|',
                        'link', 'blockQuote', 'insertTable',
                        '|',
                        'undo', 'redo'
                    ]
                },
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                        { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' }
                    ]
                },
                link: {
                    addTargetToExternalLinks: true,
                    defaultProtocol: 'https://'
                },
                table: {
                    contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                }
            })
            .then((editor) => {
                // Avoid marking the form dirty due to initialization-time changes.
                requestAnimationFrame(() => { ignoreChanges = false; });

                editor.model.document.on('change:data', () => {
                    if (ignoreChanges) return;
                    dirty = true;
                    textarea.value = editor.getData();
                    scanAffiliateLikeUrls(textarea.value);
                });

                const form = textarea.closest('form');
                if (form) {
                    form.addEventListener('submit', () => {
                        // Backward-compat guarantee: if admin didn't edit content,
                        // submit the original HTML unchanged.
                        textarea.value = dirty ? editor.getData() : originalValue;
                    });
                }
            })
            .catch(() => {
                // Fail closed: leave textarea as-is.
            });
    })();

    (function () {
        const dropzone = document.querySelector('[data-dropzone]');
        if (!dropzone) return;
        const input = dropzone.querySelector('input[type="file"]');
        const fileLabel = dropzone.querySelector('[data-dropzone-filename]');
        if (!input || !fileLabel) return;

        function updateLabel() {
            const file = input.files && input.files[0];
            fileLabel.textContent = file ? file.name : 'No file selected';
        }

        dropzone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropzone.classList.add('is-dragging');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('is-dragging');
        });

        dropzone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropzone.classList.remove('is-dragging');
            if (event.dataTransfer.files.length) {
                input.files = event.dataTransfer.files;
                updateLabel();
            }
        });

        input.addEventListener('change', updateLabel);
        updateLabel();
    })();

    (function () {
        // Soft SEO warnings (non-blocking)
        const titleInput = document.querySelector('input[name="meta_title"]');
        const descInput = document.querySelector('textarea[name="meta_description"]');
        const titleWarn = document.querySelector('[data-soft-warning="meta-title"]');
        const descWarn = document.querySelector('[data-soft-warning="meta-description"]');

        function warn(el, target, min, max) {
            if (!el || !target) return;
            const len = (el.value || '').trim().length;
            if (!len) {
                target.textContent = '';
                return;
            }
            if (len < min) target.textContent = `Tip: ${len} chars (try ${min}-${max}).`;
            else if (len > max) target.textContent = `Warning: ${len} chars (try ${min}-${max}).`;
            else target.textContent = `OK: ${len} chars.`;
        }

        function update() {
            warn(titleInput, titleWarn, 30, 60);
            warn(descInput, descWarn, 90, 160);
        }

        if (titleInput) titleInput.addEventListener('input', update);
        if (descInput) descInput.addEventListener('input', update);
        update();
    })();

    (function () {
        // Search preview (non-blocking)
        const titleField = document.querySelector('input[name="title"]');
        const metaTitle = document.querySelector('input[name="meta_title"]');
        const metaDesc = document.querySelector('textarea[name="meta_description"]');
        const previewTitle = document.querySelector('[data-preview-title]');
        const previewDesc = document.querySelector('[data-preview-desc]');
        if (!previewTitle || !previewDesc) return;

        function clamp(str, max) {
            const s = String(str || '').trim();
            if (!s) return '';
            return s.length > max ? (s.slice(0, max - 1) + '‚Ä¶') : s;
        }

        function update() {
            const t = (metaTitle && metaTitle.value.trim()) || (titleField && titleField.value.trim()) || 'Article title';
            const d = (metaDesc && metaDesc.value.trim()) || '';
            previewTitle.textContent = clamp(t, 70);
            previewDesc.textContent = clamp(d || 'Add a short meta description to improve click-through rate.', 170);
        }

        if (titleField) titleField.addEventListener('input', update);
        if (metaTitle) metaTitle.addEventListener('input', update);
        if (metaDesc) metaDesc.addEventListener('input', update);
        update();
    })();

    (function () {
        // Recommendations editor (progressive enhancement)
        const root = document.querySelector('[data-recs-editor]');
        if (!root) return;
        const rows = root.querySelector('[data-recs-rows]');
        const addBtn = root.querySelector('[data-rec-add]');
        const hidden = document.querySelector('[data-recs-json]');
        const warning = root.querySelector('[data-recs-warning]');
        if (!rows || !addBtn || !hidden) return;

        function toBool(value) {
            return String(value || '').trim() === '1';
        }

        function serialize() {
            const items = [];
            rows.querySelectorAll('[data-recs-row]').forEach((row) => {
                const type = (row.querySelector('[data-rec-type]') || {}).value || 'resource';
                const title = ((row.querySelector('[data-rec-title]') || {}).value || '').trim();
                const url = ((row.querySelector('[data-rec-url]') || {}).value || '').trim();
                const justification = ((row.querySelector('[data-rec-justification]') || {}).value || '').trim();
                const position = (row.querySelector('[data-rec-position]') || {}).value || 'end';
                const active = toBool((row.querySelector('[data-rec-active]') || {}).value);

                // Skip truly empty rows.
                if (!title && !url && !justification) return;

                items.push({ type, title, url, justification, position, active });
            });
            hidden.value = JSON.stringify(items);

            if (warning) {
                const activeCount = items.filter((r) => r.active && r.url && r.title).length;
                const missingJustification = items.some((r) => r.active && r.url && r.title && !r.justification);
                const missingUrl = items.some((r) => r.active && r.title && !r.url);
                const missingTitle = items.some((r) => r.active && r.url && !r.title);
                const parts = [];
                if (activeCount > 3) parts.push(`Soft warning: ${activeCount} active recommendations (only first 3 show).`);
                if (missingJustification) parts.push('Soft warning: some active items are missing justification.');
                if (missingUrl) parts.push('Soft warning: some active items are missing URLs.');
                if (missingTitle) parts.push('Soft warning: some active items are missing titles.');
                warning.textContent = parts.join(' ');
            }
        }

        function bindRow(row) {
            const remove = row.querySelector('[data-rec-remove]');
            if (remove) {
                remove.addEventListener('click', () => {
                    row.remove();
                    serialize();
                });
            }
            row.addEventListener('input', serialize);
            row.addEventListener('change', serialize);
        }

        rows.querySelectorAll('[data-recs-row]').forEach(bindRow);

        addBtn.addEventListener('click', () => {
            const row = document.createElement('div');
            row.className = 'recs-row';
            row.setAttribute('data-recs-row', '');
            row.innerHTML = `
                <div class="form-grid form-grid--2">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" data-rec-type>
                            <option value="product">Product</option>
                            <option value="tool">Tool</option>
                            <option value="service">Service</option>
                            <option value="resource" selected>Resource</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display title (neutral)</label>
                        <input class="form-input" value="" placeholder="e.g. Building cost calculator" data-rec-title>
                    </div>
                    <div class="form-group form-group--full">
                        <label class="form-label">Affiliate URL</label>
                        <input class="form-input" value="" placeholder="https://..." data-rec-url>
                    </div>
                    <div class="form-group form-group--full">
                        <label class="form-label">Short justification (why it helps)</label>
                        <textarea class="form-textarea" rows="2" placeholder="1‚Äì2 sentences. Keep it factual." data-rec-justification></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display position</label>
                        <select class="form-select" data-rec-position>
                            <option value="end" selected>End of article</option>
                            <option value="dedicated">Dedicated block</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Active</label>
                        <select class="form-select" data-rec-active>
                            <option value="1" selected>Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:.5rem;">
                    <button class="btn btn-ghost" type="button" data-rec-remove>Remove</button>
                </div>
            `;
            rows.appendChild(row);
            bindRow(row);
            serialize();
        });

        // Ensure hidden JSON is up-to-date even if server rendered rows.
        serialize();
    })();

    (function () {
        // Media editor (progressive enhancement)
        const root = document.querySelector('[data-media-editor]');
        if (!root) return;
        const hidden = document.querySelector('[data-media-json]');
        const galleryRows = root.querySelector('[data-gallery-rows]');
        const addBtn = root.querySelector('[data-gallery-add]');
        if (!hidden) return;

        function serialize() {
            const featuredUrl = ((root.querySelector('[data-featured-url]') || {}).value || '').trim();
            const featuredAlt = ((root.querySelector('[data-featured-alt]') || {}).value || '').trim();
            const featuredCaption = ((root.querySelector('[data-featured-caption]') || {}).value || '').trim();

            const payload = {};
            if (featuredUrl || featuredAlt || featuredCaption) {
                payload.featured = { url: featuredUrl, alt: featuredAlt, caption: featuredCaption };
            }

            if (galleryRows) {
                const gallery = [];
                galleryRows.querySelectorAll('[data-gallery-row]').forEach((row) => {
                    const url = ((row.querySelector('[data-gallery-url]') || {}).value || '').trim();
                    const alt = ((row.querySelector('[data-gallery-alt]') || {}).value || '').trim();
                    const caption = ((row.querySelector('[data-gallery-caption]') || {}).value || '').trim();
                    if (!url) return;
                    gallery.push({ url, alt, caption });
                });
                if (gallery.length) payload.gallery = gallery;
            }

            hidden.value = JSON.stringify(payload);
        }

        function bindGalleryRow(row) {
            const remove = row.querySelector('[data-gallery-remove]');
            if (remove) {
                remove.addEventListener('click', () => {
                    row.remove();
                    serialize();
                });
            }
            row.addEventListener('input', serialize);
            row.addEventListener('change', serialize);
        }

        root.addEventListener('input', serialize);
        root.addEventListener('change', serialize);

        if (galleryRows) {
            galleryRows.querySelectorAll('[data-gallery-row]').forEach(bindGalleryRow);
        }

        if (addBtn && galleryRows) {
            addBtn.addEventListener('click', () => {
                const row = document.createElement('div');
                row.className = 'media-row';
                row.setAttribute('data-gallery-row', '');
                row.innerHTML = `
                    <div class="form-grid form-grid--2">
                        <div class="form-group form-group--full">
                            <label class="form-label">Image URL</label>
                            <input class="form-input" value="" placeholder="https://..." data-gallery-url>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alt text</label>
                            <input class="form-input" value="" placeholder="Describe the image" data-gallery-alt>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Caption</label>
                            <input class="form-input" value="" placeholder="Optional" data-gallery-caption>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:.5rem;">
                        <button class="btn btn-ghost" type="button" data-gallery-remove>Remove</button>
                    </div>
                `;
                galleryRows.appendChild(row);
                bindGalleryRow(row);
                serialize();
            });
        }

        serialize();
    })();

    (function () {
        // Admin autosave (localStorage only). Never blocks submit.
        const form = document.querySelector('[data-admin-article-form]');
        if (!form) return;

        const status = document.querySelector('[data-autosave-status]');
        const key = (() => {
            // Prefer stable key for edits; fall back to URL for create.
            const postId = (document.querySelector('input[name="post_id"]') || {}).value;
            return postId ? `admin_blog_draft_${postId}` : `admin_blog_draft_${location.pathname}`;
        })();

        function setStatus(text) {
            if (status) status.textContent = text;
        }

        function snapshot() {
            const data = {};
            const fields = form.querySelectorAll('input, textarea, select');
            fields.forEach((el) => {
                if (!el.name) return;
                if (el.type === 'password' || el.type === 'file') return;
                data[el.name] = el.value;
            });
            return data;
        }

        let saveTimer = null;
        function scheduleSave() {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                try {
                    localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data: snapshot() }));
                    setStatus('Draft saved locally');
                } catch (e) {
                    // ignore
                }
            }, 450);
        }

        form.addEventListener('input', scheduleSave);

        // Optional restore UI (non-intrusive)
        try {
            const raw = localStorage.getItem(key);
            if (raw) {
                const parsed = JSON.parse(raw);
                if (parsed && parsed.data) {
                    const restoreBtn = document.createElement('button');
                    restoreBtn.type = 'button';
                    restoreBtn.className = 'btn btn-ghost';
                    restoreBtn.textContent = 'Restore autosave';
                    restoreBtn.addEventListener('click', () => {
                        try {
                            const data = parsed.data || {};
                            Object.keys(data).forEach((name) => {
                                const el = form.querySelector(`[name="${CSS.escape(name)}"]`);
                                if (el && el.type !== 'file') el.value = data[name];
                            });
                            setStatus('Autosave restored');
                        } catch (e) {
                            // ignore
                        }
                    });
                    const row = form.querySelector('.form-submit__row');
                    if (row) row.insertBefore(restoreBtn, row.children[1] || null);
                    setStatus('Autosave available');
                }
            }
        } catch (e) {
            // ignore
        }

        form.addEventListener('submit', () => {
            // Keep the autosave copy (in case submit fails).
            setStatus('Saving‚Ä¶');
        });
    })();

    (function () {
        // FAQ repeatable fields (progressive enhancement)
        const root = document.querySelector('[data-faq-editor]');
        if (!root) return;
        const rows = root.querySelector('[data-faq-rows]');
        const addBtn = root.querySelector('[data-faq-add]');
        const hidden = document.querySelector('[data-faq-json]');
        if (!rows || !addBtn || !hidden) return;

        function serialize() {
            const items = [];
            rows.querySelectorAll('[data-faq-row]').forEach((row) => {
                const q = (row.querySelector('[data-faq-q]') || {}).value || '';
                const a = (row.querySelector('[data-faq-a]') || {}).value || '';
                const qq = q.trim();
                const aa = a.trim();
                if (qq && aa) items.push({ question: qq, answer: aa });
            });
            hidden.value = JSON.stringify(items);
        }

        function bindRow(row) {
            const remove = row.querySelector('[data-faq-remove]');
            if (remove) {
                remove.addEventListener('click', () => {
                    row.remove();
                    serialize();
                });
            }
            row.addEventListener('input', serialize);
        }

        rows.querySelectorAll('[data-faq-row]').forEach(bindRow);

        addBtn.addEventListener('click', () => {
            const row = document.createElement('div');
            row.className = 'faq-row';
            row.setAttribute('data-faq-row', '');
            row.innerHTML = `
                <div class="form-grid form-grid--2">
                    <div class="form-group">
                        <label class="form-label">Question</label>
                        <input class="form-input" value="" data-faq-q>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Answer</label>
                        <textarea class="form-textarea" rows="2" data-faq-a></textarea>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:.5rem;">
                    <button class="btn btn-ghost" type="button" data-faq-remove>Remove</button>
                </div>
            `;
            rows.appendChild(row);
            bindRow(row);
            serialize();
        });

        // Initial sync so server receives structured FAQ even if fields prefilled.
        serialize();
    })();
</script>
{% endblock %}
