{% extends "base.html" %}

{% block content %}
{% set applied = filters or {} %}
{% set persist = query_args or {} %}
<div class="shell admin-shell">
    <header class="section-heading">
        <div>
            <p class="eyebrow">Content</p>
            <h1>House plans</h1>
            <p class="lead">Search, filter, and track every deliverable before publishing updates.</p>
        </div>
        <a href="{{ url_for('admin.add_plan') }}" class="btn btn-primary">Add new plan</a>
    </header>

    {% if stats %}
    <section class="admin-stats">
        <article>
            <p class="admin-stats__label">Total</p>
            <p class="admin-stats__value">{{ stats.total }}</p>
        </article>
        <article>
            <p class="admin-stats__label">Published</p>
            <p class="admin-stats__value">{{ stats.published }}</p>
        </article>
        <article>
            <p class="admin-stats__label">Drafts</p>
            <p class="admin-stats__value">{{ stats.draft }}</p>
        </article>
        <article>
            <p class="admin-stats__label">Free downloads</p>
            <p class="admin-stats__value">{{ stats.free }}</p>
        </article>
    </section>
    {% endif %}

    <section class="admin-filter-card">
        <form method="get" class="admin-filter-form" aria-label="Filter plans">
            <label>
                <span>Search</span>
                <input type="text" name="q" placeholder="Reference code or title" value="{{ applied.search or '' }}">
            </label>
            <label>
                <span>Status</span>
                <select name="status">
                    <option value="" {% if not applied.status %}selected{% endif %}>All</option>
                    <option value="published" {% if applied.status == 'published' %}selected{% endif %}>Published</option>
                    <option value="draft" {% if applied.status == 'draft' %}selected{% endif %}>Draft</option>
                </select>
            </label>
            <label>
                <span>Category</span>
                <select name="category">
                    <option value="" {% if not applied.category %}selected{% endif %}>All collections</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if applied.category == category.id %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                <span>Pack type</span>
                <select name="pack">
                    <option value="" {% if not applied.pack %}selected{% endif %}>All</option>
                    <option value="free" {% if applied.pack == 'free' %}selected{% endif %}>Free download ready</option>
                    <option value="paid" {% if applied.pack == 'paid' %}selected{% endif %}>Paid packs linked</option>
                </select>
            </label>
            <label>
                <span>Sort</span>
                <select name="sort">
                    <option value="newest" {% if applied.sort == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="updated" {% if applied.sort == 'updated' %}selected{% endif %}>Recently updated</option>
                    <option value="title" {% if applied.sort == 'title' %}selected{% endif %}>Title A → Z</option>
                    <option value="views" {% if applied.sort == 'views' %}selected{% endif %}>Most viewed</option>
                    <option value="price_low" {% if applied.sort == 'price_low' %}selected{% endif %}>Display price · Low → High</option>
                </select>
            </label>
            <label>
                <span>Rows</span>
                <select name="per_page">
                    {% for size in [10,20,50,100] %}
                    <option value="{{ size }}" {% if applied.per_page == size %}selected{% endif %}>{{ size }}</option>
                    {% endfor %}
                </select>
            </label>
            <div class="admin-filter-actions">
                <button type="submit" class="btn btn-primary">Apply</button>
                <a href="{{ url_for('admin.plans') }}" class="btn btn-soft">Reset</a>
            </div>
        </form>
    </section>

    <section class="admin-quick-tools" aria-label="Quick tools" data-admin-tools>
        <div class="admin-quick-tools__left">
            <label class="admin-quick-tools__search">
                <span>Quick search</span>
                <input type="text" placeholder="Filter this page" data-admin-search>
            </label>
            <div class="admin-quick-tools__meta" data-admin-count>Showing 0 of 0</div>
        </div>
        <div class="admin-quick-tools__right">
            <label class="admin-quick-tools__sort">
                <span>Sort</span>
                <select data-admin-sort>
                    <option value="updated">Updated (newest)</option>
                    <option value="title">Title A → Z</option>
                    <option value="views">Most viewed</option>
                    <option value="price">Price (low → high)</option>
                    <option value="status">Status</option>
                    <option value="ref">Reference</option>
                </select>
            </label>
            <button type="button" class="btn btn-soft" data-admin-select-all>Select all</button>
            <button type="button" class="btn btn-soft" data-admin-copy data-copy-type="refs">Copy refs</button>
            <button type="button" class="btn btn-soft" data-admin-copy data-copy-type="urls">Copy URLs</button>
            <button type="button" class="btn btn-primary" data-admin-export>Export CSV</button>
        </div>
    </section>

    <div class="table-responsive admin-table">
        <table>
            <thead>
                <tr>
                    <th class="admin-table__select">
                        <input type="checkbox" aria-label="Select all plans" data-admin-select-all-checkbox>
                    </th>
                    <th>Reference</th>
                    <th>Pricing tiers</th>
                    <th>Delivery</th>
                    <th>Status</th>
                    <th>Updated</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for p in plans.items %}
                <tr
                    data-plan-row
                    data-title="{{ p.title|e }}"
                    data-ref="{{ p.reference_code|e }}"
                    data-status="{{ 'published' if p.is_published else 'draft' }}"
                    data-updated="{{ p.updated_at.timestamp() if p.updated_at else 0 }}"
                    data-views="{{ p.views_count or 0 }}"
                    data-price="{{ p.price_pack_1 or 0 }}"
                    data-url="{{ url_for('main.pack_detail', slug=p.slug) }}"
                    data-category="{% if p.categories %}{{ p.categories | map(attribute='name') | join(', ') }}{% endif %}"
                    data-pack2="{{ 1 if p.gumroad_pack_2_url else 0 }}"
                    data-pack3="{{ 1 if p.gumroad_pack_3_url else 0 }}"
                >
                    <td class="admin-table__select">
                        <input type="checkbox" aria-label="Select {{ p.title }}" data-plan-select>
                    </td>
                    <td>
                        <div class="plan-ref">
                            <span class="plan-ref__code">{{ p.reference_code }}</span>
                            <div>
                                <strong>{{ p.title }}</strong>
                                {% if current_user.is_authenticated and current_user.role == 'superadmin' %}
                                <div class="muted">Created by: {{ (p.created_by.username if p.created_by else None)|default('System') }}</div>
                                {% endif %}
                                <div class="muted">
                                    {% if p.categories %}
                                        {% for category in p.categories %}
                                            <span class="badge badge--ghost">{{ category.name }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="badge badge--outline">Uncategorized</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="pack-stack">
                            <div>
                                <span class="pack-label">Free Pack</span>
                                <strong>{% if p.price_pack_1 and p.price_pack_1 > 0 %}${{ p.price_pack_1 }}{% else %}Free{% endif %}</strong>
                            </div>
                            <div>
                                <span class="pack-label">PDF Pro</span>
                                <strong>{% if p.price_pack_2 %}${{ p.price_pack_2 }}{% else %}&mdash;{% endif %}</strong>
                            </div>
                            <div>
                                <span class="pack-label">Ultimate CAD</span>
                                <strong>{% if p.price_pack_3 %}${{ p.price_pack_3 }}{% else %}&mdash;{% endif %}</strong>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="delivery-stack">
                            <span class="badge {% if p.free_pdf_file %}badge--soft{% else %}badge--outline{% endif %}">Free PDF {% if p.free_pdf_file %}ready{% else %}missing{% endif %}</span>
                            <span class="badge {% if p.gumroad_pack_2_url %}badge--soft{% else %}badge--outline{% endif %}">PDF Pro {% if p.gumroad_pack_2_url %}linked{% else %}pending{% endif %}</span>
                            <span class="badge {% if p.gumroad_pack_3_url %}badge--soft{% else %}badge--outline{% endif %}">CAD {% if p.gumroad_pack_3_url %}linked{% else %}pending{% endif %}</span>
                        </div>
                    </td>
                    <td>
                        {% if p.is_published %}
                            <span class="badge badge--glow">Published</span>
                        {% else %}
                            <span class="badge badge--outline">Draft</span>
                        {% endif %}
                        <div class="muted">Views: {{ p.views_count }}</div>
                    </td>
                    <td>
                        <div>{{ p.updated_at.strftime('%b %d, %Y') if p.updated_at else '—' }}</div>
                        <small class="muted">Created {{ p.created_at.strftime('%b %d, %Y') }}</small>
                    </td>
                    <td class="admin-table__actions">
                        <div class="admin-actions__inline">
                            <a class="btn btn-soft" href="{{ url_for('admin.edit_plan', id=p.id) }}" data-admin-edit data-plan-id="{{ p.id }}" data-plan-title="{{ p.title|e }}" data-plan-url="{{ url_for('main.pack_detail', slug=p.slug) }}">Edit</a>
                            <button type="button" class="btn btn-outline" data-admin-preview>Preview</button>
                            <button type="button" class="btn btn-outline" data-admin-copy-single data-copy-type="ref" data-copy-value="{{ p.reference_code }}">Copy ref</button>
                            <button type="button" class="btn btn-outline" data-admin-copy-single data-copy-type="url" data-copy-value="{{ url_for('main.pack_detail', slug=p.slug) }}">Copy URL</button>
                            {% if current_user.is_authenticated and current_user.role == 'superadmin' %}
                                <form method="post" action="{{ url_for('admin.toggle_plan_publish', id=p.id) }}" style="display:inline">
                                    {{ csrf_token() if csrf_token is defined else '' }}
                                    {% if p.is_published %}
                                        <button type="submit" class="btn btn-outline">Unpublish</button>
                                    {% else %}
                                        <button type="submit" class="btn btn-outline">Publish</button>
                                    {% endif %}
                                </form>
                                <form method="post" action="{{ url_for('admin.delete_plan', id=p.id) }}" style="display:inline" onsubmit="return confirm('Delete this plan? This action cannot be undone.');">
                                    {{ csrf_token() if csrf_token is defined else '' }}
                                    <button type="submit" class="btn btn-outline">Delete</button>
                                </form>
                            {% else %}
                                <button type="button" class="btn btn-outline" disabled title="Only the Owner can publish or delete plans">Owner-only</button>
                            {% endif %}
                        </div>
                        <div class="admin-actions__menu" data-admin-action-menu>
                            <button type="button" class="action-menu__toggle" aria-expanded="false" aria-label="Open actions">⋮</button>
                            <div class="action-menu__panel" role="menu">
                                <a class="action-menu__item" role="menuitem" href="{{ url_for('admin.edit_plan', id=p.id) }}" data-admin-edit data-plan-id="{{ p.id }}" data-plan-title="{{ p.title|e }}" data-plan-url="{{ url_for('main.pack_detail', slug=p.slug) }}">Edit</a>
                                <button type="button" class="action-menu__item" role="menuitem" data-admin-preview>Preview</button>
                                <button type="button" class="action-menu__item" role="menuitem" data-admin-copy-single data-copy-type="ref" data-copy-value="{{ p.reference_code }}">Copy ref</button>
                                <button type="button" class="action-menu__item" role="menuitem" data-admin-copy-single data-copy-type="url" data-copy-value="{{ url_for('main.pack_detail', slug=p.slug) }}">Copy URL</button>
                                {% if current_user.is_authenticated and current_user.role == 'superadmin' %}
                                    <form method="post" action="{{ url_for('admin.toggle_plan_publish', id=p.id) }}" style="display:inline">
                                        {{ csrf_token() if csrf_token is defined else '' }}
                                        {% if p.is_published %}
                                            <button type="submit" class="action-menu__item" role="menuitem">Unpublish</button>
                                        {% else %}
                                            <button type="submit" class="action-menu__item" role="menuitem">Publish</button>
                                        {% endif %}
                                    </form>
                                    <form method="post" action="{{ url_for('admin.delete_plan', id=p.id) }}" style="display:inline" onsubmit="return confirm('Delete this plan? This action cannot be undone.');">
                                        {{ csrf_token() if csrf_token is defined else '' }}
                                        <button type="submit" class="action-menu__item action-menu__item--danger" role="menuitem">Delete</button>
                                    </form>
                                {% else %}
                                    <button type="button" class="action-menu__item" role="menuitem" disabled>Owner-only</button>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if plans.items|length == 0 %}
        <div class="empty-state">
            <p>No plans match the selected filters.</p>
            <a href="{{ url_for('admin.plans') }}" class="btn btn-outline">Clear filters</a>
        </div>
        {% endif %}
    </div>

    <dialog class="admin-preview" data-admin-preview-dialog>
        <div class="admin-preview__header">
            <div>
                <p class="eyebrow">Plan preview</p>
                <h3 class="admin-preview__title">Plan</h3>
            </div>
            <button type="button" class="btn btn-soft" data-admin-preview-close>Close</button>
        </div>
        <div class="admin-preview__body">
            <div class="admin-preview__meta">
                <p><strong>Reference:</strong> <span data-admin-preview-ref>—</span></p>
                <p><strong>Status:</strong> <span data-admin-preview-status>—</span></p>
                <p><strong>Categories:</strong> <span data-admin-preview-categories>—</span></p>
                <p><strong>Views:</strong> <span data-admin-preview-views>—</span></p>
            </div>
            <div class="admin-preview__actions">
                <a class="btn btn-primary" data-admin-preview-link href="#" target="_blank" rel="noopener">Open public page</a>
                <button type="button" class="btn btn-soft" data-admin-preview-copy>Copy link</button>
            </div>
        </div>
    </dialog>

    <nav class="pagination" aria-label="Pagination">
        {% if plans.has_prev %}
            <a class="pagination__link" href="{{ url_for('admin.plans', page=plans.prev_num, **persist) }}">Previous</a>
        {% endif %}
        <span class="pagination__link is-active">Page {{ plans.page }} of {{ plans.pages }}</span>
        {% if plans.has_next %}
            <a class="pagination__link" href="{{ url_for('admin.plans', page=plans.next_num, **persist) }}">Next</a>
        {% endif %}
    </nav>
</div>
{% endblock %}