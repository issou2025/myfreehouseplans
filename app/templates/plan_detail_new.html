{% extends "base.html" %}

{% block title %}{{ plan.title|default('Plan', true) }} - {{ plan.display_reference }}{% endblock %}

{% block content %}
{% set placeholder = url_for('static', filename='images/placeholder.svg') %}

{# Image setup #}
{% set cover_value = plan.image_url if plan.image_url else '' %}
{% set floor_value = plan.floor_plan_image if plan.floor_plan_image else '' %}
{% set alt_value = plan.main_image if plan.main_image else '' %}

{% set cover_src = upload_url(cover_value) if cover_value else placeholder %}
{% set floor_src = upload_url(floor_value) if floor_value else '' %}
{% set alt_src = upload_url(alt_value) if alt_value else '' %}
{% set cover_srcset = srcset_for(cover_value, preset=HERO_PRESET, variant='base') %}
{% set floor_srcset = srcset_for(floor_value, preset=HERO_PRESET, variant='base') %}
{% set alt_srcset = srcset_for(alt_value, preset=HERO_PRESET, variant='base') %}

{# Key metrics #}
{% set area_m2 = plan.area_m2 if plan.area_m2 else None %}
{% set area_sqft = plan.area_sqft if plan.area_sqft else None %}
{% set beds = plan.bedrooms_count if plan.bedrooms_count is not none else None %}
{% set baths = plan.bathrooms_count if plan.bathrooms_count is not none else None %}
{% set floors = plan.floors_count if plan.floors_count is not none else None %}
{% set garage = plan.parking_count if plan.parking_count is not none else None %}

{# Modern Marketplace-Style Plan Detail Page #}
<div class="shell plan-detail">
  {# Breadcrumbs #}
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <a href="{{ url_for('main.index') }}">Home</a>
    <a href="{{ url_for('main.packs') }}">Plans</a>
    {% if plan.category %}<a href="{{ url_for('main.plans_by_category', category_slug=plan.category.slug) }}">{{ plan.category.name }}</a>{% endif %}
    <span aria-current="page">{{ plan.title|default('Plan', true) }}</span>
  </nav>

  {# HERO SECTION - Two Column Desktop, Stacked Mobile #}
  <section class="plan-hero" aria-label="Plan overview">
    <div class="plan-hero__content">
      {# Plan Title & Short Description #}
      <h1 class="plan-hero__title">{{ plan.title|default('Plan', true) }}</h1>
      
      {% if plan.short_description %}
      <p class="plan-hero__intro">{{ plan.short_description }}</p>
      {% elif plan.architectural_summary %}
      <p class="plan-hero__intro">{{ plan.architectural_summary }}</p>
      {% endif %}

      {# Badges Row - Key Metrics #}
      <div class="plan-hero__badges">
        {% if beds is not none %}
        <div class="metric-badge">
          <i class="fa-solid fa-bed" aria-hidden="true"></i>
          <span class="metric-badge__value">{{ beds }}</span>
          <span class="metric-badge__label">Bedroom{{ 's' if beds != 1 else '' }}</span>
        </div>
        {% endif %}
        
        {% if baths is not none %}
        <div class="metric-badge">
          <i class="fa-solid fa-bath" aria-hidden="true"></i>
          <span class="metric-badge__value">{{ baths }}</span>
          <span class="metric-badge__label">Bathroom{{ 's' if baths != 1 else '' }}</span>
        </div>
        {% endif %}
        
        {% if floors is not none %}
        <div class="metric-badge">
          <i class="fa-solid fa-building" aria-hidden="true"></i>
          <span class="metric-badge__value">{{ floors }}</span>
          <span class="metric-badge__label">Floor{{ 's' if floors != 1 else '' }}</span>
        </div>
        {% endif %}
        
        {% if area_m2 %}
        <div class="metric-badge metric-badge--area">
          <i class="fa-solid fa-ruler-combined" aria-hidden="true"></i>
          <div class="metric-badge__area-toggle">
            <button type="button" class="area-toggle" data-unit="m2">
              <span class="metric-badge__value area-m2">{{ area_m2|round(0)|int }}</span>
              <span class="metric-badge__label">m²</span>
            </button>
            {% if area_sqft %}
            <span class="area-divider">/</span>
            <button type="button" class="area-toggle" data-unit="sqft">
              <span class="metric-badge__value area-sqft">{{ area_sqft|round(0)|int }}</span>
              <span class="metric-badge__label">sqft</span>
            </button>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>

      {# Plan Code - Subtle Display #}
      <p class="plan-hero__code">
        <i class="fa-solid fa-hashtag" aria-hidden="true"></i>
        Plan Code: <strong>{{ plan.display_reference }}</strong>
      </p>
    </div>

    {# Main Image & CTA Buttons #}
    <div class="plan-hero__visual">
      <figure class="plan-hero__image">
        <img id="planMainImage" 
             src="{{ cover_src }}" 
             alt="{{ plan.title|default('Plan', true) }}" 
             loading="eager" 
             decoding="async" 
             {% if cover_srcset %}srcset="{{ cover_srcset }}" sizes="{{ HERO_PRESET.sizes }}"{% endif %}
             onerror="this.onerror=null;this.src='{{ placeholder }}';">
      </figure>

      {# Primary CTA Buttons #}
      <div class="plan-hero__actions">
        {% if plan.free_pdf_file %}
        <a href="{{ url_for('main.download_free', plan_id=plan.id) }}" class="btn btn-primary btn-block">
          <i class="fa-solid fa-download" aria-hidden="true"></i>
          Download Free Preview
        </a>
        {% endif %}
        
        {% set visible_tiers = filter_pack_tiers(plan.pricing_tiers, pack_visibility) %}
        {% if visible_tiers %}
          {% for tier in visible_tiers %}
            {% if tier.pack == 2 and tier.available %}
            <a href="{{ url_for('main.gumroad_redirect', slug=plan.slug, pack=2) }}" class="btn btn-accent btn-block" rel="nofollow">
              <i class="fa-solid fa-file-pdf" aria-hidden="true"></i>
              Buy PDF Pro Pack
            </a>
            {% endif %}
            {% if tier.pack == 3 and tier.available %}
            <a href="{{ url_for('main.gumroad_redirect', slug=plan.slug, pack=3) }}" class="btn btn-secondary btn-block" rel="nofollow">
              <i class="fa-solid fa-drafting-compass" aria-hidden="true"></i>
              Get CAD Pack
            </a>
            {% endif %}
          {% endfor %}
        {% endif %}
        
        <a href="{{ url_for('main.contact') }}" class="btn btn-ghost btn-block">
          <i class="fa-solid fa-message" aria-hidden="true"></i>
          Contact Us
        </a>
      </div>
    </div>
  </section>

  {# WHY THIS PLAN SECTION - Highlighted Box #}
  {% if plan.key_selling_point or plan.problems_this_plan_solves or plan.target_buyer %}
  <section class="plan-why" aria-label="Why this plan">
    <div class="plan-why__card">
      {% if plan.key_selling_point %}
      <h2 class="plan-why__headline">
        <i class="fa-solid fa-star" aria-hidden="true"></i>
        {{ plan.key_selling_point }}
      </h2>
      {% else %}
      <h2 class="plan-why__headline">
        <i class="fa-solid fa-bullseye" aria-hidden="true"></i>
        Why This Plan Works
      </h2>
      {% endif %}

      {% if plan.problems_this_plan_solves %}
      <p class="plan-why__text">{{ plan.problems_this_plan_solves }}</p>
      {% endif %}

      {% if plan.target_buyer %}
      <div class="plan-why__target">
        <i class="fa-solid fa-users" aria-hidden="true"></i>
        <strong>Perfect for:</strong> {{ plan.target_buyer }}
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}

  {# GALLERY SECTION - Image Thumbnails #}
  {% if (floor_src and floor_src != cover_src) or (alt_src and alt_src != cover_src and alt_src != floor_src) %}
  <section class="plan-gallery" aria-label="Plan gallery">
    <h2 class="plan-gallery__title">Gallery</h2>
    <div class="plan-gallery__grid">
      <button class="plan-gallery__thumb is-active" type="button" 
              data-src="{{ cover_src }}" 
              data-srcset="{{ cover_srcset }}" 
              data-sizes="{{ HERO_PRESET.sizes }}" 
              aria-label="View cover image">
        <img src="{{ cover_src }}" 
             alt="Cover" 
             loading="lazy" 
             decoding="async" 
             {% if cover_srcset %}srcset="{{ cover_srcset }}"{% endif %}
             onerror="this.onerror=null;this.src='{{ placeholder }}';">
      </button>
      
      {% if floor_src and floor_src != cover_src %}
      <button class="plan-gallery__thumb" type="button" 
              data-src="{{ floor_src }}" 
              data-srcset="{{ floor_srcset }}" 
              data-sizes="{{ HERO_PRESET.sizes }}" 
              aria-label="View floor plan">
        <img src="{{ floor_src }}" 
             alt="Floor plan" 
             loading="lazy" 
             decoding="async" 
             {% if floor_srcset %}srcset="{{ floor_srcset }}"{% endif %}
             onerror="this.onerror=null;this.src='{{ placeholder }}';">
      </button>
      {% endif %}
      
      {% if alt_src and alt_src != cover_src and alt_src != floor_src %}
      <button class="plan-gallery__thumb" type="button" 
              data-src="{{ alt_src }}" 
              data-srcset="{{ alt_srcset }}" 
              data-sizes="{{ HERO_PRESET.sizes }}" 
              aria-label="View alternate image">
        <img src="{{ alt_src }}" 
             alt="Alternate view" 
             loading="lazy" 
             decoding="async" 
             {% if alt_srcset %}srcset="{{ alt_srcset }}"{% endif %}
             onerror="this.onerror=null;this.src='{{ placeholder }}';">
      </button>
      {% endif %}
    </div>
  </section>
  {% endif %}

  {# QUICK SPECS GRID #}
  <section class="plan-specs" aria-label="Quick specifications">
    <h2 class="plan-specs__title">Quick Specs</h2>
    <div class="plan-specs__grid">
      {% if beds is not none %}
      <div class="spec-item">
        <i class="fa-solid fa-bed" aria-hidden="true"></i>
        <span class="spec-item__value">{{ beds }}</span>
        <span class="spec-item__label">Bedroom{{ 's' if beds != 1 else '' }}</span>
      </div>
      {% endif %}

      {% if baths is not none %}
      <div class="spec-item">
        <i class="fa-solid fa-bath" aria-hidden="true"></i>
        <span class="spec-item__value">{{ baths }}</span>
        <span class="spec-item__label">Bathroom{{ 's' if baths != 1 else '' }}</span>
      </div>
      {% endif %}

      {% if plan.living_rooms is not none %}
      <div class="spec-item">
        <i class="fa-solid fa-couch" aria-hidden="true"></i>
        <span class="spec-item__value">{{ plan.living_rooms }}</span>
        <span class="spec-item__label">Living Room{{ 's' if plan.living_rooms != 1 else '' }}</span>
      </div>
      {% endif %}

      {% if plan.kitchens is not none %}
      <div class="spec-item">
        <i class="fa-solid fa-kitchen-set" aria-hidden="true"></i>
        <span class="spec-item__value">{{ plan.kitchens }}</span>
        <span class="spec-item__label">Kitchen{{ 's' if plan.kitchens != 1 else '' }}</span>
      </div>
      {% endif %}

      {% if garage is not none %}
      <div class="spec-item">
        <i class="fa-solid fa-car" aria-hidden="true"></i>
        <span class="spec-item__value">{{ garage }}</span>
        <span class="spec-item__label">Garage Space{{ 's' if garage != 1 else '' }}</span>
      </div>
      {% endif %}

      {% if floors is not none %}
      <div class="spec-item">
        <i class="fa-solid fa-building" aria-hidden="true"></i>
        <span class="spec-item__value">{{ floors }}</span>
        <span class="spec-item__label">Floor{{ 's' if floors != 1 else '' }}</span>
      </div>
      {% endif %}

      {% if area_m2 %}
      <div class="spec-item">
        <i class="fa-solid fa-ruler-combined" aria-hidden="true"></i>
        <span class="spec-item__value">{{ area_m2|round(0)|int }} m²</span>
        <span class="spec-item__label">Total Area{% if area_sqft %} ({{ area_sqft|round(0)|int }} sqft){% endif %}</span>
      </div>
      {% endif %}

      {% if plan.min_plot_width or plan.min_plot_length %}
      <div class="spec-item">
        <i class="fa-solid fa-vector-square" aria-hidden="true"></i>
        <span class="spec-item__value">
          {% if plan.min_plot_width and plan.min_plot_length %}
            {{ plan.min_plot_width|round(1) }}×{{ plan.min_plot_length|round(1) }}m
          {% elif plan.min_plot_width %}
            {{ plan.min_plot_width|round(1) }}m
          {% elif plan.min_plot_length %}
            {{ plan.min_plot_length|round(1) }}m
          {% endif %}
        </span>
        <span class="spec-item__label">Min. Plot Size</span>
      </div>
      {% endif %}
    </div>
  </section>

  {# CLIMATE & BUILD SECTION - Show only if data exists #}
  {% if plan.climate_compatibility or plan.structure_type or plan.foundation_type or plan.roof_type or plan.construction_complexity or plan.estimated_build_time %}
  <section class="plan-build" aria-label="Climate and build information">
    <h2 class="plan-build__title">Climate & Build</h2>
    <div class="plan-build__grid">
      {% if plan.climate_compatibility %}
      <div class="build-item">
        <i class="fa-solid fa-cloud-sun" aria-hidden="true"></i>
        <div class="build-item__content">
          <strong>Climate</strong>
          <span>{{ plan.climate_compatibility }}</span>
        </div>
      </div>
      {% endif %}

      {% if plan.structure_type %}
      <div class="build-item">
        <i class="fa-solid fa-cubes" aria-hidden="true"></i>
        <div class="build-item__content">
          <strong>Structure</strong>
          <span>{{ plan.structure_type }}</span>
        </div>
      </div>
      {% endif %}

      {% if plan.foundation_type %}
      <div class="build-item">
        <i class="fa-solid fa-layer-group" aria-hidden="true"></i>
        <div class="build-item__content">
          <strong>Foundation</strong>
          <span>{{ plan.foundation_type }}</span>
        </div>
      </div>
      {% endif %}

      {% if plan.roof_type %}
      <div class="build-item">
        <i class="fa-solid fa-house-chimney" aria-hidden="true"></i>
        <div class="build-item__content">
          <strong>Roof</strong>
          <span>{{ plan.roof_type }}</span>
        </div>
      </div>
      {% endif %}

      {% if plan.construction_complexity %}
      <div class="build-item">
        <i class="fa-solid fa-gears" aria-hidden="true"></i>
        <div class="build-item__content">
          <strong>Complexity</strong>
          <span>{{ plan.construction_complexity }}</span>
        </div>
      </div>
      {% endif %}

      {% if plan.estimated_build_time %}
      <div class="build-item">
        <i class="fa-solid fa-clock" aria-hidden="true"></i>
        <div class="build-item__content">
          <strong>Build Time</strong>
          <span>{{ plan.estimated_build_time }}</span>
        </div>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}

  {# ESTIMATED COST SECTION - Show only if both values exist #}
  {% if plan.estimated_cost_low and plan.estimated_cost_high %}
  <section class="plan-cost" aria-label="Estimated construction cost">
    <div class="plan-cost__box">
      <i class="fa-solid fa-calculator" aria-hidden="true"></i>
      <div class="plan-cost__content">
        <strong>Estimated Construction Cost</strong>
        <p class="plan-cost__range">{{ format_cost_range(plan.estimated_cost_low, plan.estimated_cost_high) }}</p>
        <p class="plan-cost__note">Cost varies by country, materials, and local labor rates.{% if plan.estimated_construction_cost_note %} {{ plan.estimated_construction_cost_note }}{% endif %}</p>
      </div>
    </div>
  </section>
  {% endif %}

  {# DESCRIPTION SECTION #}
  <section class="plan-description" aria-label="Plan description">
    <div class="plan-description__content">
      {% if plan.design_philosophy %}
      <article class="description-card">
        <h2><i class="fa-solid fa-lightbulb" aria-hidden="true"></i> Design Philosophy</h2>
        <div class="rich-text">{{ render_richtext(plan.design_philosophy) }}</div>
      </article>
      {% endif %}

      {% if plan.description %}
      <article class="description-card">
        <h2><i class="fa-solid fa-align-left" aria-hidden="true"></i> Full Description</h2>
        <div class="rich-text">{{ render_richtext(plan.description) }}</div>
      </article>
      {% endif %}

      {% if plan.lifestyle_suitability %}
      <article class="description-card">
        <h2><i class="fa-solid fa-heart" aria-hidden="true"></i> Lifestyle Suitability</h2>
        <div class="rich-text">{{ render_richtext(plan.lifestyle_suitability) }}</div>
      </article>
      {% endif %}

      {% if plan.room_details %}
      <article class="description-card">
        <h2><i class="fa-solid fa-door-open" aria-hidden="true"></i> Room-by-Room Details</h2>
        <div class="rich-text">{{ render_richtext(plan.room_details) }}</div>
      </article>
      {% endif %}

      {% if plan.customization_potential %}
      <article class="description-card">
        <h2><i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i> Customization Potential</h2>
        <div class="rich-text">{{ render_richtext(plan.customization_potential) }}</div>
      </article>
      {% endif %}

      {% if not (plan.design_philosophy or plan.description or plan.lifestyle_suitability or plan.room_details or plan.customization_potential) %}
      <article class="description-card">
        <h2><i class="fa-solid fa-info-circle" aria-hidden="true"></i> About This Plan</h2>
        <p>Detailed description coming soon.</p>
      </article>
      {% endif %}
    </div>
  </section>

  {# PACK COMPARISON SECTION #}
  <section class="plan-packs" id="pricing" aria-label="Available packs">
    <h2 class="plan-packs__title">Choose Your Pack</h2>
    <p class="plan-packs__subtitle">Select the pack that best matches your project stage</p>

    {% set visible_tiers = filter_pack_tiers(plan.pricing_tiers, pack_visibility) %}
    {% if visible_tiers %}
    <div class="plan-packs__grid">
      {% for tier in visible_tiers %}
        {% set is_recommended = (tier.pack == 2) %}
        <article class="pack-card {% if is_recommended %}pack-card--recommended{% endif %}">
          {% if is_recommended %}
          <div class="pack-card__badge">
            <i class="fa-solid fa-star" aria-hidden="true"></i> Most Popular
          </div>
          {% endif %}

          <div class="pack-card__header">
            <h3 class="pack-card__name">{{ tier.label }}</h3>
            <div class="pack-card__price">
              {% if tier.is_free %}
                <span class="price">Free</span>
              {% elif tier.price is not none %}
                <span class="price">${{ tier.price|round(0)|int }}</span>
              {% else %}
                <span class="price">—</span>
              {% endif %}
            </div>
          </div>

          <ul class="pack-card__features">
            {% if tier.pack == 1 %}
              {% if plan.pack1_description %}
                {{ plan.pack1_description|safe }}
              {% else %}
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Free PDF preview</li>
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Basic elevations</li>
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Floor plan overview</li>
                <li><i class="fa-solid fa-xmark" aria-hidden="true"></i> No dimensions</li>
              {% endif %}
            {% elif tier.pack == 2 %}
              {% if plan.pack2_description %}
                {{ plan.pack2_description|safe }}
              {% else %}
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Complete PDF set</li>
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> All dimensions included</li>
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Detailed elevations</li>
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Ready for permits</li>
              {% endif %}
            {% else %}
              {% if plan.pack3_description %}
                {{ plan.pack3_description|safe }}
              {% else %}
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Editable CAD/DWG files</li>
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> All pack 2 benefits</li>
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Full customization</li>
                <li><i class="fa-solid fa-check" aria-hidden="true"></i> Professional use</li>
              {% endif %}
            {% endif %}
          </ul>

          <div class="pack-card__cta">
            {% if tier.pack == 1 %}
              {% if plan.free_pdf_file %}
                <a class="btn btn-primary btn-block" href="{{ url_for('main.download_free', plan_id=plan.id) }}">
                  <i class="fa-solid fa-download" aria-hidden="true"></i> Download Free
                </a>
              {% else %}
                <span class="btn btn-ghost btn-block is-disabled" aria-disabled="true">
                  <i class="fa-solid fa-clock" aria-hidden="true"></i> Coming Soon
                </span>
              {% endif %}
            {% elif tier.available %}
              <a class="btn btn-{% if is_recommended %}accent{% else %}primary{% endif %} btn-block" 
                 href="{{ url_for('main.gumroad_redirect', slug=plan.slug, pack=tier.pack) }}" 
                 rel="nofollow">
                <i class="fa-solid fa-bolt" aria-hidden="true"></i> Buy Now
              </a>
            {% else %}
              <span class="btn btn-ghost btn-block is-disabled" aria-disabled="true">
                <i class="fa-solid fa-clock" aria-hidden="true"></i> Coming Soon
              </span>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
    {% else %}
    <p class="plan-packs__empty">Packs are being prepared. Please check back soon or contact us for more information.</p>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    // Gallery thumbnail switcher
    const main = document.getElementById('planMainImage');
    const thumbs = document.querySelectorAll('.plan-gallery__thumb');
    
    if (main && thumbs.length) {
      thumbs.forEach(btn => {
        btn.addEventListener('click', function () {
          const src = btn.getAttribute('data-src');
          const srcset = btn.getAttribute('data-srcset');
          const sizes = btn.getAttribute('data-sizes');
          
          if (!src) return;
          
          main.setAttribute('src', src);
          if (srcset) {
            main.setAttribute('srcset', srcset);
            if (sizes) {
              main.setAttribute('sizes', sizes);
            }
          } else {
            main.removeAttribute('srcset');
            main.removeAttribute('sizes');
          }
          
          thumbs.forEach(t => t.classList.remove('is-active'));
          btn.classList.add('is-active');
        });
      });
    }

    // Area unit toggle (optional enhancement)
    const areaToggles = document.querySelectorAll('.area-toggle');
    if (areaToggles.length) {
      areaToggles.forEach(toggle => {
        toggle.addEventListener('click', function () {
          const unit = this.getAttribute('data-unit');
          areaToggles.forEach(t => t.classList.remove('is-active'));
          this.classList.add('is-active');
          
          // Store preference
          localStorage.setItem('preferred_area_unit', unit);
        });
      });

      // Load preference
      const preferredUnit = localStorage.getItem('preferred_area_unit');
      if (preferredUnit) {
        const preferredToggle = document.querySelector(`.area-toggle[data-unit="${preferredUnit}"]`);
        if (preferredToggle) {
          areaToggles.forEach(t => t.classList.remove('is-active'));
          preferredToggle.classList.add('is-active');
        }
      } else {
        // Default to m2
        const m2Toggle = document.querySelector('.area-toggle[data-unit="m2"]');
        if (m2Toggle) {
          m2Toggle.classList.add('is-active');
        }
      }
    }
  })();
</script>
{% endblock %}
