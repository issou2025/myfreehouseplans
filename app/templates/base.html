<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    {# SEO Meta Tags #}
    <title>{% block title %}{{ meta.title if meta else site_name }}{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}{{ meta.description if meta else site_description }}{% endblock %}">
    {% block meta_keywords %}
    {% if meta and meta.keywords %}
    <meta name="keywords" content="{{ meta.keywords }}">
    {% elif site_keywords %}
    <meta name="keywords" content="{{ site_keywords }}">
    {% endif %}
    {% endblock %}
    <meta name="robots" content="{% block meta_robots %}index,follow{% endblock %}">
    <link rel="canonical" href="{% block canonical %}{{ meta.canonical_url if meta else site_url }}{% endblock %}">
    
    {# Open Graph / Facebook #}
    <meta property="og:type" content="{% block og_type %}{{ meta.og_type if meta else 'website' }}{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ meta.og_url if meta else site_url }}{% endblock %}">
    <meta property="og:title" content="{% block og_title %}{{ meta.og_title if meta else site_name }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ meta.og_description if meta else site_description }}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ meta.og_image if meta and meta.og_image else url_for('static', filename='images/logo.png', _external=True) }}{% endblock %}">
    
    {# Twitter Card #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ meta.og_url if meta else site_url }}">
    <meta name="twitter:title" content="{{ meta.og_title if meta else site_name }}">
    <meta name="twitter:description" content="{{ meta.og_description if meta else site_description }}">
    <meta name="twitter:image" content="{{ meta.og_image if meta and meta.og_image else url_for('static', filename='images/logo.png', _external=True) }}">
    
    {# Favicon #}
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

    {# PWA #}
    <meta name="theme-color" content="#0b1220">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
    
    {# Stylesheets #}
    <meta name="color-scheme" content="light">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-mobile-ux.css') }}">
    {% block extra_css %}{% endblock %}
    
    {# Structured Data (global defaults) #}
    {% if organization_schema %}
    <script type="application/ld+json">{{ organization_schema | tojson | safe }}</script>
    {% endif %}
    {% if website_schema %}
    <script type="application/ld+json">{{ website_schema | tojson | safe }}</script>
    {% endif %}

    {# Structured Data (page-specific additions) #}
    {% block structured_data %}{% endblock %}

    {# Google Analytics 4 #}
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B74YY1J754"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-B74YY1J754');
    </script>
</head>
<body class="site-body theme-lux" data-img-fallback="{{ url_for('static', filename='images/placeholder.svg') }}">
    <a class="skip-link" href="#main">Skip to content</a>
    {# Header / Navigation #}
    <header class="site-header glass" role="banner">
        <div class="shell site-header__inner">
            <a class="site-brand" href="{{ url_for('main.index') }}" aria-label="Return to homepage">
                <span class="site-brand__logo">
                    <span class="site-brand__mark" aria-hidden="true"><i class="fa-solid fa-house-chimney"></i></span>
                    <span class="site-brand__name">{{ site_name }}</span>
                </span>
                <span class="site-brand__tagline">Curated architectural portfolio</span>
            </a>
            {% set current_endpoint = request.endpoint or '' %}
            <nav id="primary-navigation" class="nav" aria-label="Primary">
                <div class="nav__group" aria-label="Browse">
                    <p class="nav__heading">Browse</p>
                    <div class="nav__stack">
                        <a class="nav-link {% if current_endpoint == 'main.index' %}is-active{% endif %}" href="{{ url_for('main.index') }}" {% if current_endpoint == 'main.index' %}aria-current="page"{% endif %}>
                            <i class="fa-solid fa-house" aria-hidden="true"></i>
                            <span>Home</span>
                        </a>
                        <a class="nav-link {% if current_endpoint in ['main.packs', 'main.pack_detail', 'main.plans_by_category'] %}is-active{% endif %}" href="{{ url_for('main.packs') }}" {% if current_endpoint in ['main.packs', 'main.pack_detail', 'main.plans_by_category'] %}aria-current="page"{% endif %}>
                            <i class="fa-solid fa-compass-drafting" aria-hidden="true"></i>
                            <span>Plans</span>
                        </a>
                        <a class="nav-link {% if current_endpoint == 'main.insight_page' %}is-active{% endif %}" href="{{ url_for('main.insight_page', slug='choose-family-plan') }}" {% if current_endpoint == 'main.insight_page' %}aria-current="page"{% endif %}>
                            <i class="fa-solid fa-book-open" aria-hidden="true"></i>
                            <span>Guides</span>
                        </a>
                        <a class="nav-link {% if current_endpoint and current_endpoint.startswith('blog.') %}is-active{% endif %}" href="{{ url_for('blog.index') }}" {% if current_endpoint and current_endpoint.startswith('blog.') %}aria-current="page"{% endif %}>
                            <i class="fa-solid fa-pen-nib" aria-hidden="true"></i>
                            <span>Blog</span>
                        </a>
                    </div>
                </div>
                <div class="nav__group nav__group--tools" aria-label="Tools">
                    <p class="nav__heading">Tools</p>
                    <div class="nav__stack">
                        {% set tools_value = 'progress_intelligence' %}
                        {% if current_endpoint == 'main.favorites' %}
                            {% set tools_value = 'favorites' %}
                        {% elif current_endpoint in ['main.compare'] %}
                            {% set tools_value = 'compare' %}
                        {% elif current_endpoint and (current_endpoint.startswith('space_planner.') or current_endpoint.startswith('room_checker.')) %}
                            {% set tools_value = 'space_planner' %}
                        {% elif current_endpoint and (current_endpoint.startswith('planner.') or current_endpoint == 'space_planner.furniture_fit') %}
                            {% set tools_value = 'furniture_fit' %}
                        {% elif current_endpoint and current_endpoint.startswith('area_calculator.') %}
                            {% set tools_value = 'house_area' %}
                        {% elif current_endpoint and current_endpoint.startswith('progress_intelligence.') %}
                            {% set tools_value = 'progress_intelligence' %}
                        {% endif %}
                        <label class="sr-only" for="toolsSpinner">Tools</label>

                        {# Desktop: compact spinner. Mobile: tap-friendly list (select dropdowns can be clipped in slide-in nav). #}
                        <div class="nav__select" data-tools-desktop>
                            <i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i>
                            <span class="nav__select-label" aria-hidden="true">Tools</span>
                            <select id="toolsSpinner" class="nav__select-control" data-tools-spinner aria-label="Tools">
                                <option value="{{ url_for('progress_intelligence.landing') }}" {% if tools_value == 'progress_intelligence' %}selected{% endif %}>Progress Intelligence</option>
                                <option value="{{ url_for('main.favorites') }}" {% if tools_value == 'favorites' %}selected{% endif %}>Favorites</option>
                                <option value="{{ url_for('main.compare') }}" {% if tools_value == 'compare' %}selected{% endif %}>Compare</option>
                                <option value="{{ url_for('space_planner.index') }}" {% if tools_value == 'space_planner' %}selected{% endif %}>Space Planner</option>
                                <option value="{{ url_for('space_planner.furniture_fit') }}" {% if tools_value == 'furniture_fit' %}selected{% endif %}>Furniture Fit</option>
                                <option value="{{ url_for('area_calculator.index') }}" {% if tools_value == 'house_area' %}selected{% endif %}>House Area Calculator</option>
                                <option value="{{ url_for('floor_plan.landing') }}" {% if tools_value == 'floor_plan' %}selected{% endif %}>Floor Plan Analyzer</option>
                            </select>
                        </div>

                        <div class="nav__tools-links" data-tools-mobile>
                            <a class="nav-link {% if tools_value == 'progress_intelligence' %}is-active{% endif %}" href="{{ url_for('progress_intelligence.landing') }}" {% if tools_value == 'progress_intelligence' %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-chart-line" aria-hidden="true"></i>
                                <span>Progress Intelligence</span>
                            </a>
                            <a class="nav-link {% if tools_value == 'favorites' %}is-active{% endif %}" href="{{ url_for('main.favorites') }}" {% if tools_value == 'favorites' %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-heart" aria-hidden="true"></i>
                                <span>Favorites</span>
                            </a>
                            <a class="nav-link {% if tools_value == 'compare' %}is-active{% endif %}" href="{{ url_for('main.compare') }}" {% if tools_value == 'compare' %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-layer-group" aria-hidden="true"></i>
                                <span>Compare</span>
                            </a>
                            <a class="nav-link {% if tools_value == 'space_planner' %}is-active{% endif %}" href="{{ url_for('space_planner.index') }}" {% if tools_value == 'space_planner' %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-compass" aria-hidden="true"></i>
                                <span>Space Planner</span>
                            </a>
                            <a class="nav-link {% if tools_value == 'furniture_fit' %}is-active{% endif %}" href="{{ url_for('space_planner.furniture_fit') }}" {% if tools_value == 'furniture_fit' %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-ruler-combined" aria-hidden="true"></i>
                                <span>Furniture Fit</span>
                            </a>
                            <a class="nav-link {% if tools_value == 'house_area' %}is-active{% endif %}" href="{{ url_for('area_calculator.index') }}" {% if tools_value == 'house_area' %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-house" aria-hidden="true"></i>
                                <span>House Area Calculator</span>
                            </a>
                            <a class="nav-link {% if tools_value == 'floor_plan' %}is-active{% endif %}" href="{{ url_for('floor_plan.landing') }}" {% if tools_value == 'floor_plan' %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-magnifying-glass-chart" aria-hidden="true"></i>
                                <span>Floor Plan Analyzer</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="nav__group" aria-label="Company">
                    <p class="nav__heading">Company</p>
                    <div class="nav__stack">
                        <a class="nav-link {% if current_endpoint == 'main.about' %}is-active{% endif %}" href="{{ url_for('main.about') }}" {% if current_endpoint == 'main.about' %}aria-current="page"{% endif %}>
                            <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                            <span>About</span>
                        </a>
                        <a class="nav-link {% if current_endpoint == 'main.contact' %}is-active{% endif %}" href="{{ url_for('main.contact') }}" {% if current_endpoint == 'main.contact' %}aria-current="page"{% endif %}>
                            <i class="fa-solid fa-envelope-open-text" aria-hidden="true"></i>
                            <span>Contact</span>
                        </a>
                    </div>
                </div>
                {% if current_user.is_authenticated and current_user.is_admin %}
                    <div class="nav__group" aria-label="Admin tools">
                        <p class="nav__heading">Admin</p>
                        <div class="nav__stack">
                            <a class="nav-link {% if current_endpoint and current_endpoint.startswith('admin.') %}is-active{% endif %}" href="{{ url_for('admin.dashboard') if current_user.role == 'superadmin' else url_for('admin.plans') }}" {% if current_endpoint and current_endpoint.startswith('admin.') %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-shield-halved" aria-hidden="true"></i>
                                <span>Admin</span>
                            </a>
                            <a class="nav-link {% if current_endpoint == 'auth.profile' %}is-active{% endif %}" href="{{ url_for('auth.profile') }}" {% if current_endpoint == 'auth.profile' %}aria-current="page"{% endif %}>
                                <i class="fa-solid fa-user-gear" aria-hidden="true"></i>
                                <span>Account</span>
                            </a>
                        </div>
                    </div>
                {% endif %}
                <div class="nav__cta" aria-label="Navigation quick actions">
                    {% if current_user.is_authenticated %}
                        <a class="btn btn-primary" href="{{ url_for('auth.logout') }}">
                            <i class="fa-solid fa-arrow-right-from-bracket" aria-hidden="true"></i>
                            Logout
                        </a>
                    {% else %}
                        <a class="btn btn-primary" href="{{ url_for('auth.login') }}">
                            <i class="fa-solid fa-sparkles" aria-hidden="true"></i>
                            Premium Access
                        </a>
                    {% endif %}
                    <a class="nav__contact" href="tel:+22796380877">
                        <i class="fa-solid fa-phone" aria-hidden="true"></i>
                        <span>Need help? +227 96 38 08 77</span>
                    </a>
                </div>
            </nav>
            <div class="site-header__actions" aria-label="Quick actions">
                <a class="icon-btn" href="{{ url_for('main.packs') }}" aria-label="Search plans">
                    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                </a>
                {% if current_user.is_authenticated %}
                    <a class="btn btn-primary btn-cta" href="{{ url_for('auth.logout') }}">
                        <i class="fa-solid fa-arrow-right-from-bracket" aria-hidden="true"></i>
                        Logout
                    </a>
                {% else %}
                    <a class="btn btn-primary btn-cta" href="{{ url_for('auth.login') }}">
                        <i class="fa-solid fa-sparkles" aria-hidden="true"></i>
                        Premium Access
                    </a>
                {% endif %}
            </div>
            <button class="nav-toggle" aria-expanded="false" aria-controls="primary-navigation" aria-label="Toggle navigation">
                <span class="nav-toggle__icon"></span>
            </button>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay"></div>

    {# Toast Notifications (Flash Messages) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true">
                {% for category, message in messages %}
                    {% set variant = category %}
                    {% if variant == 'error' %}{% set variant = 'danger' %}{% endif %}
                    {% if variant not in ['success', 'danger', 'warning', 'info'] %}{% set variant = 'info' %}{% endif %}

                    <div class="toast toast--{{ variant }}" role="{{ 'alert' if variant in ['danger'] else 'status' }}" data-timeout="4000">
                        <div class="toast__icon" aria-hidden="true">
                            {% if variant == 'success' %}
                                <i class="fa-solid fa-circle-check"></i>
                            {% elif variant == 'danger' %}
                                <i class="fa-solid fa-triangle-exclamation"></i>
                            {% elif variant == 'warning' %}
                                <i class="fa-solid fa-circle-exclamation"></i>
                            {% else %}
                                <i class="fa-solid fa-circle-info"></i>
                            {% endif %}
                        </div>
                        <div class="toast__body">{{ message }}</div>
                        <button type="button" class="toast__close" aria-label="Close notification">&times;</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# Main Content #}
    <main id="main" role="main" class="page-shell">
        {% block content %}{% endblock %}

        {% if random_post %}
            <section class="shell" aria-label="Recommended reading" style="margin-top: 2.5rem;">
                <div class="glass" style="padding: 1.5rem; border-radius: 1rem;">
                    <p class="eyebrow" style="margin: 0 0 .5rem 0;">
                        <i class="fa-solid fa-book-open" aria-hidden="true"></i>
                        Recommended Reading
                    </p>
                    <h2 style="margin: 0 0 .75rem 0; font-family: 'Playfair Display', serif;">
                        <a href="{{ url_for('blog.detail', slug=random_post.slug) }}" style="text-decoration: none;">
                            {{ random_post.title }}
                        </a>
                    </h2>

                    {% set promo_text = random_post.meta_description or (random_post.content|striptags) %}
                    {% if promo_text %}
                        <div style="opacity: .92; margin-bottom: 1rem;">
                            {{ render_richtext(promo_text|truncate(240, True, 'â€¦')) }}
                        </div>
                    {% endif %}

                    <div style="display:flex; gap:.75rem; flex-wrap:wrap; align-items:center;">
                        <a class="btn btn-primary" href="{{ url_for('blog.detail', slug=random_post.slug) }}">
                            <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
                            Read article
                        </a>
                        <a class="btn btn-secondary" href="{{ url_for('blog.index') }}">
                            Browse blog
                        </a>
                    </div>
                </div>
            </section>
        {% endif %}
    </main>

    <div id="compareInlineBar" class="compare-inline" aria-live="polite" hidden></div>
    <div id="compareTray" class="compare-tray" aria-live="polite" hidden></div>

    {# Footer #}
    <footer class="site-footer">
        <div class="shell">
            <div class="footer-grid">
                <div class="footer-brand">
                    <div class="footer-brand__logo">
                        <span class="footer-brand__mark" aria-hidden="true"><i class="fa-solid fa-house-chimney"></i></span>
                        <span class="footer-brand__name">{{ site_name }}</span>
                    </div>
                    <p class="footer-brand__about">Professional house plans, optimized for builders and architects. Clear PDFs, smarter details, faster decisions.</p>
                    <div class="footer-social" aria-label="Social links">
                        <a href="https://wa.me/22796380877" target="_blank" rel="noopener" class="social-icon" aria-label="WhatsApp"><i class="fa-brands fa-whatsapp" aria-hidden="true"></i></a>
                        <a href="mailto:entreprise2rc@gmail.com" class="social-icon" aria-label="Email"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a>
                    </div>
                </div>

                <div class="footer-col">
                    <h4>Quick links</h4>
                    <ul>
                        <li><a href="{{ url_for('main.index') }}">Home</a></li>
                        <li><a href="{{ url_for('main.packs') }}">Plans</a></li>
                        <li><a href="{{ url_for('main.about') }}">About</a></li>
                        <li><a href="{{ url_for('main.contact') }}">Contact</a></li>
                        <li><a href="{{ url_for('main.privacy_policy') }}">Privacy Policy</a></li>
                        <li><a href="{{ url_for('main.terms_of_service') }}">Terms of Service</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>Categories</h4>
                    <ul>
                        <li><a href="{{ url_for('main.packs', category='modern') }}">Modern</a></li>
                        <li><a href="{{ url_for('main.packs', narrative='hot_climate') }}">Tropical</a></li>
                        <li><a href="{{ url_for('main.packs', narrative='compact_affordable') }}">Small Houses</a></li>
                        <li><a href="{{ url_for('main.packs', category='luxury') }}">Luxury</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>Newsletter</h4>
                    <p>Get notified when new plans drop. No spam.</p>
                    <form class="newsletter" action="{{ url_for('main.newsletter_signup') }}" method="post">
                        <label class="sr-only" for="newsletterEmail">Email</label>
                        <div class="newsletter__row">
                            <input id="newsletterEmail" name="email" type="email" placeholder="you@email.com" autocomplete="email" required>
                            <button class="btn btn-primary" type="submit">
                                <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
                                Sign up
                            </button>
                        </div>
                    </form>
                    <div class="footer-mini" aria-label="Contact info">
                        <div><i class="fa-solid fa-phone" aria-hidden="true"></i> <a href="tel:+22796380877">+227 96 38 08 77</a></div>
                        <div><i class="fa-solid fa-location-dot" aria-hidden="true"></i> Serving builders worldwide</div>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; {{ now.year if now else '2026' }} {{ site_name }}. All rights reserved.</p>
            </div>
        </div>
    </footer>

    {# JavaScript #}
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/enhanced-ux.js') }}"></script>
    <script>
        // PWA-lite: register service worker (root scope)
        (function(){
            if (!('serviceWorker' in navigator)) return;
            window.addEventListener('load', function(){
                navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(function(){});
            });
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
