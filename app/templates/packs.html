{% extends "base.html" %}

{% block content %}
<div class="shell">
    <header class="section-heading">
        <div>
            <p class="eyebrow">All plans</p>
            <h1>Residential catalog curated by architects</h1>
            <p class="lead">Use the filters to narrow by typology, bedroom count, or pricing tier. Every listing includes a free pack plus clear upgrade paths.</p>
        </div>
    </header>

    <section class="filters">
        <form class="filter-form" method="get" action="{{ url_for('main.packs') }}">
            <label>
                <span>Search</span>
                <input type="text" name="q" placeholder="Enter keywords" value="{{ request.args.get('q', '') }}">
            </label>

            <label>
                <span>Category</span>
                <select name="category">
                    <option value="">All collections</option>
                    {% for category in categories %}
                    <option value="{{ category.slug }}" {% if request.args.get('category') == category.slug %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </label>

            <label>
                <span>Bedrooms</span>
                <select name="bedrooms">
                    <option value="">Any</option>
                    {% for n in [1,2,3,4,5] %}
                    <option value="{{ n }}" {% if (request.args.get('bedrooms')|int) == n %}selected{% endif %}>{{ n }}+</option>
                    {% endfor %}
                </select>
            </label>

            <label>
                <span>Bathrooms</span>
                <select name="bathrooms">
                    <option value="">Any</option>
                    {% for n in [1,2,3,4] %}
                    <option value="{{ n }}" {% if (request.args.get('bathrooms')|int) == n %}selected{% endif %}>{{ n }}+</option>
                    {% endfor %}
                </select>
            </label>

            <label>
                <span>Sort by</span>
                <select name="sort">
                    <option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="price_low" {% if request.args.get('sort') == 'price_low' %}selected{% endif %}>Price · Low → High</option>
                    <option value="price_high" {% if request.args.get('sort') == 'price_high' %}selected{% endif %}>Price · High → Low</option>
                    <option value="popular" {% if request.args.get('sort') == 'popular' %}selected{% endif %}>Most viewed</option>
                </select>
            </label>

            <button type="submit" class="btn btn-primary">Apply filters</button>
        </form>
    </section>

    {% if plans %}
        <div class="plan-grid plan-grid--catalog">
            {% for plan in plans %}
            <article class="plan-card" itemscope itemtype="https://schema.org/Product">
                <a class="plan-card__media" href="{{ url_for('main.pack_detail', slug=plan.slug) }}" itemprop="url">
                    {% set card_image = plan.cover_image or plan.main_image %}
                    {% if card_image %}
                        <img src="{{ url_for('static', filename='uploads/' + card_image) }}" alt="{{ plan.title }}" itemprop="image">
                    {% else %}
                        <div class="plan-card__placeholder">Visual coming soon</div>
                    {% endif %}
                    <div class="plan-card__labels">
                        {% if plan.is_featured %}<span class="badge badge--glow">Featured</span>{% endif %}
                        {% if plan.is_on_sale %}<span class="badge badge--outline">On sale</span>{% endif %}
                    </div>
                </a>
                <div class="plan-card__body">
                    <p class="plan-card__eyebrow">
                        {% if plan.categories %}
                            {% for c in plan.categories %}
                                <a href="{{ url_for('main.plans_by_category', slug=c.slug) }}">{{ c.name }}</a>{% if not loop.last %} · {% endif %}
                            {% endfor %}
                        {% else %}
                            Residential
                        {% endif %}
                    </p>
                    <h3 itemprop="name"><a href="{{ url_for('main.pack_detail', slug=plan.slug) }}">{{ plan.title }}</a></h3>
                    <p class="plan-card__summary" itemprop="description">{{ plan.architectural_summary }}</p>
                    <dl class="plan-card__specs" aria-label="Key characteristics">
                        {% if plan.area_sqft %}<div><dt>Area</dt><dd>{{ plan.area_sqft|round|int }} sq ft</dd></div>{% endif %}
                        {% if plan.bedrooms_count %}<div><dt>Beds</dt><dd>{{ plan.bedrooms_count }}</dd></div>{% endif %}
                        {% if plan.bathrooms_count %}<div><dt>Baths</dt><dd>{{ plan.bathrooms_count }}</dd></div>{% endif %}
                        {% if plan.floors_count %}<div><dt>Levels</dt><dd>{{ plan.floors_count }}</dd></div>{% endif %}
                    </dl>
                    <div class="plan-card__tiers" aria-label="Pack pricing overview">
                        {% for tier in plan.pricing_tiers %}
                        <div class="plan-card__tier {% if not tier.available %}plan-card__tier--muted{% endif %}">
                            <span>Pack 0{{ tier.pack }}</span>
                            <span>
                                {% if tier.price and tier.price > 0 %}
                                    ${{ tier.price|round(0)|int }}
                                {% elif tier.pack == 1 %}
                                    Free
                                {% else %}
                                    Forthcoming
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="plan-card__footer" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                        <div class="plan-card__price plan-card__price--stack">
                            <span class="plan-card__ref">Ref {{ plan.reference_code }}</span>
                            {% if plan.starting_paid_price %}
                                <span class="price price--primary" itemprop="price">From ${{ plan.starting_paid_price|round(0)|int }}</span>
                            {% else %}
                                <span class="price price--primary" itemprop="price">Free</span>
                            {% endif %}
                            <meta itemprop="priceCurrency" content="USD">
                        </div>
                        <div class="plan-card__cta">
                            <a href="{{ url_for('main.pack_detail', slug=plan.slug) }}" class="btn btn-soft" aria-label="View plan {{ plan.title }}">View plan</a>
                            <a class="text-link" href="{{ url_for('main.contact') }}">Ask about packs</a>
                        </div>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>

        {% if pagination.pages > 1 %}
        <nav class="pagination" aria-label="Pagination">
            {% if pagination.has_prev %}
            <a class="pagination__link" href="{{ url_for('main.packs', page=pagination.prev_num, **request.args) }}">Previous</a>
            {% endif %}
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num == pagination.page %}
                    <span class="pagination__link is-active">{{ page_num }}</span>
                    {% else %}
                    <a class="pagination__link" href="{{ url_for('main.packs', page=page_num, **request.args) }}">{{ page_num }}</a>
                    {% endif %}
                {% else %}
                    <span class="pagination__ellipsis" aria-hidden="true">···</span>
                {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
            <a class="pagination__link" href="{{ url_for('main.packs', page=pagination.next_num, **request.args) }}">Next</a>
            {% endif %}
        </nav>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <p>No house plans match your filters.</p>
            <a href="{{ url_for('main.packs') }}" class="btn btn-outline">Reset filters</a>
        </div>
    {% endif %}
</div>
{% endblock %}
