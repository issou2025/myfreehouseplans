{% extends "base.html" %}

{% block content %}
<div class="shell">
    <header class="section-heading">
        <div>
            <p class="eyebrow">All plans</p>
            <h1>Residential catalog curated by architects</h1>
            <p class="lead">Use the filters to narrow by typology, bedroom count, or pricing tier. Every listing includes a free pack plus clear upgrade paths.</p>
        </div>
    </header>

    <section class="filters">
        <form class="filter-form" method="get" action="{{ url_for('main.packs') }}" data-plan-browser>
            <input type="hidden" name="narrative" value="{{ active_narrative }}" data-narrative-input>
            <label>
                <span>Search</span>
                <input type="text" name="q" placeholder="Reference code, keywords, area…" value="{{ request.args.get('q', '') }}" autocomplete="off" inputmode="search" aria-label="Search plans by keyword or reference">
            </label>

            <label>
                <span>Category</span>
                <select name="category">
                    <option value="">All collections</option>
                    {% for category in categories %}
                    <option value="{{ category.slug }}" {% if request.args.get('category') == category.slug %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </label>

            <label>
                <span>Bedrooms</span>
                <select name="bedrooms">
                    <option value="">Any</option>
                    {% for n in [1,2,3,4,5] %}
                    <option value="{{ n }}" {% if (request.args.get('bedrooms')|int) == n %}selected{% endif %}>{{ n }}+</option>
                    {% endfor %}
                </select>
            </label>

            <label>
                <span>Plan type</span>
                <select name="type">
                    <option value="" {% if not request.args.get('type') %}selected{% endif %}>All</option>
                    {% if plan_types %}
                        {% for plan_type in plan_types %}
                        <option value="{{ plan_type }}" {% if request.args.get('type') == plan_type %}selected{% endif %}>{{ plan_type|title }}</option>
                        {% endfor %}
                    {% else %}
                        {% for fallback in ['family','rental','luxury'] %}
                        <option value="{{ fallback }}" {% if request.args.get('type') == fallback %}selected{% endif %}>{{ fallback|title }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </label>

            <label>
                <span>Area min (sq ft)</span>
                <input type="number" name="area_min" min="0" step="10" value="{{ request.args.get('area_min', '') }}" placeholder="e.g. 900">
            </label>

            <label>
                <span>Area max (sq ft)</span>
                <input type="number" name="area_max" min="0" step="10" value="{{ request.args.get('area_max', '') }}" placeholder="e.g. 2800">
            </label>

            <label>
                <span>Budget min ($)</span>
                <input type="number" name="budget_min" min="0" step="10" value="{{ request.args.get('budget_min', '') }}" placeholder="e.g. 40">
            </label>

            <label>
                <span>Budget max ($)</span>
                <input type="number" name="budget_max" min="0" step="10" value="{{ request.args.get('budget_max', '') }}" placeholder="e.g. 120">
            </label>

            <label>
                <span>Bathrooms</span>
                <select name="bathrooms">
                    <option value="">Any</option>
                    {% for n in [1,2,3,4] %}
                    <option value="{{ n }}" {% if (request.args.get('bathrooms')|int) == n %}selected{% endif %}>{{ n }}+</option>
                    {% endfor %}
                </select>
            </label>

            <label>
                <span>Sort by</span>
                <select name="sort">
                    <option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="price_low" {% if request.args.get('sort') == 'price_low' %}selected{% endif %}>Price · Low → High</option>
                    <option value="price_high" {% if request.args.get('sort') == 'price_high' %}selected{% endif %}>Price · High → Low</option>
                    <option value="popular" {% if request.args.get('sort') == 'popular' %}selected{% endif %}>Most viewed</option>
                </select>
            </label>

            <div class="filter-form__actions">
                <button type="submit" class="btn btn-primary">Apply filters</button>
                <button type="button" class="btn btn-ghost" data-filters-reset>Reset</button>
            </div>

            <div class="narrative-filter-group" role="group" aria-label="Lifestyle filters">
                <p class="narrative-filter-group__label">Choisissez une intention&nbsp;:</p>
                <div class="narrative-filter-group__chips">
                    {% for key, meta in narrative_filters.items() %}
                    <button type="button" class="narrative-chip {% if active_narrative == key %}is-active{% endif %}" data-narrative-trigger data-value="{{ key }}" data-helper="{{ meta.helper }}" aria-pressed="{{ 'true' if active_narrative == key else 'false' }}">
                        <strong>{{ meta.label }}</strong>
                        <span>{{ meta.summary }}</span>
                    </button>
                    {% endfor %}
                </div>
                <p class="microcopy" data-narrative-helper>{{ narrative_filters.get(active_narrative, {}).get('helper', 'Filtrez par ambiance de vie plutôt que par simple critère technique.') }}</p>
            </div>

            <p class="filters__summary" data-results-summary role="status" aria-live="polite">{{ result_summary }}</p>
        </form>
    </section>

    <div class="catalog-results" data-plan-results>
        <div class="plan-grid plan-grid--catalog" id="planGrid" data-plan-grid data-next-page="{{ pagination.next_num if pagination.has_next else '' }}" data-fragment-url="{{ url_for('main.plans_fragment') }}">
            {% include "_plan_cards.html" with context %}
        </div>

        <div id="planEmptyState" class="empty-state" {% if plans %}hidden{% endif %}>
            <p>No house plans match your filters.</p>
            <button type="button" class="btn btn-outline" data-filters-reset>Reset filters</button>
        </div>
    </div>

    <div class="catalog-more" aria-label="More plans" data-load-more-wrapper>
        <button class="btn btn-outline" type="button" id="loadMorePlans" {% if not pagination.has_next %}hidden{% endif %}>Load more plans</button>
        <p class="muted" data-load-more-terminal {% if pagination.has_next %}hidden{% endif %}>You reached the end of this path. Try another filter to keep exploring.</p>
    </div>

    {% if suggestion_targets %}
    <section class="catalog-suggestions" aria-live="polite">
        <p class="catalog-suggestions__title">Vous venez d’explorer cette série. Essayez aussi :</p>
        <ul>
            {% for plan in suggestion_targets %}
            <li><a href="{{ url_for('main.pack_detail', slug=plan.slug) }}">{{ plan.title }} · Ref {{ plan.reference_code }}</a></li>
            {% endfor %}
        </ul>
        <p class="microcopy">Chaque clic ouvre un nouvel itinéraire de plans similaires.</p>
    </section>
    {% endif %}

    <div data-pagination-wrapper>
        {% include "_pagination.html" with context %}
    </div>

    <section class="plan-related plan-related--listing" aria-labelledby="listing-recently" data-recently-section hidden>
        <div class="section-heading">
            <div>
                <p class="eyebrow">Resume browsing</p>
                <h2 id="listing-recently">Recently viewed plans</h2>
                <p class="muted" data-recently-empty>Open any plan to start a personal trail.</p>
            </div>
        </div>
        <div class="plan-grid plan-grid--scroll plan-related__grid" data-recently-grid data-recently-limit="5"></div>
    </section>

    <section class="plan-related plan-related--listing" aria-labelledby="listing-similar" data-similar-section data-similar-source="history" hidden>
        <div class="section-heading">
            <div>
                <p class="eyebrow">Handpicked for you</p>
                <h2 id="listing-similar">You may also like</h2>
                <p class="muted">We look at your last viewed plan to surface close matches.</p>
            </div>
        </div>
        <div class="plan-grid plan-grid--scroll plan-related__grid" data-similar-grid></div>
    </section>

    {% if popular_plans %}
    <section class="plan-related plan-related--listing" aria-labelledby="popular-week">
        <div class="section-heading">
            <div>
                <p class="eyebrow">Popular this week</p>
                <h2 id="popular-week">Ce que les visiteurs comparent en ce moment</h2>
                <p class="muted">Basé sur les vues récentes et les demandes studio.</p>
            </div>
        </div>
        <div class="plan-grid plan-grid--scroll plan-related__grid">
            {% with plans=popular_plans %}
                {% include "_plan_cards.html" with context %}
            {% endwith %}
        </div>
    </section>
    {% endif %}

    {% if new_arrivals %}
    <section class="plan-related plan-related--listing" aria-labelledby="new-arrivals">
        <div class="section-heading">
            <div>
                <p class="eyebrow">New arrivals</p>
                <h2 id="new-arrivals">Dernières publications studio</h2>
                <p class="muted">Chaque plan est revu par l’équipe avant mise en ligne.</p>
            </div>
        </div>
        <div class="plan-grid plan-grid--scroll plan-related__grid">
            {% with plans=new_arrivals %}
                {% include "_plan_cards.html" with context %}
            {% endwith %}
        </div>
    </section>
    {% endif %}

    {% if climate_focus %}
    <section class="plan-related plan-related--listing" aria-labelledby="climate-rail">
        <div class="section-heading">
            <div>
                <p class="eyebrow">Climate-focused</p>
                <h2 id="climate-rail">Sélection tropicale</h2>
                <p class="muted">Toitures ventilées, débords généreux, pièces traversantes.</p>
            </div>
        </div>
        <div class="plan-grid plan-grid--scroll plan-related__grid">
            {% with plans=climate_focus %}
                {% include "_plan_cards.html" with context %}
            {% endwith %}
        </div>
    </section>
    {% endif %}

    <section class="insights-grid" aria-labelledby="insights-heading">
        <div class="section-heading">
            <div>
                <p class="eyebrow">Guides studio</p>
                <h2 id="insights-heading">Conseils rapides pour choisir</h2>
                <p class="muted">Des articles courts, rédigés par les architectes qui dessinent ces plans.</p>
            </div>
        </div>
        <div class="insights-grid__list">
            {% for slug, article in guides.items() %}
            <article class="insight-card">
                <h3>{{ article.title }}</h3>
                <p>{{ article.description }}</p>
                <a class="btn btn-soft" href="{{ url_for('main.insight_page', slug=slug) }}">Lire</a>
            </article>
            {% endfor %}
        </div>
    </section>

    <section class="newsletter-panel" aria-labelledby="newsletter-heading">
        <div>
            <p class="eyebrow">Studio updates</p>
            <h2 id="newsletter-heading">Recevez les nouvelles publications avant tout le monde</h2>
            <p class="muted">Un email synthétique, seulement quand nous ajoutons un plan ou un guide utile.</p>
        </div>
        <form class="newsletter-panel__form" method="post" action="{{ url_for('main.newsletter_signup') }}" data-newsletter-form>
            <label>
                <span>Votre email</span>
                <input type="email" name="email" placeholder="vous@email.com" required>
            </label>
            <button type="submit" class="btn btn-primary">Recevoir les updates</button>
            <p class="microcopy">Instant opt-in · Vous pouvez vous désinscrire en un clic.</p>
        </form>
        <p class="newsletter-panel__confirmation" data-newsletter-message role="status" aria-live="polite" hidden></p>
    </section>
</div>
{% endblock %}
