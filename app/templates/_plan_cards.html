{% for plan in plans %}
{% set plan_title = plan.title|default('House Plan', true) %}
{% set plan_ref = plan.reference_code|default(plan.id, true) %}
<article class="plan-card plan-card--lux" itemscope itemtype="https://schema.org/Product">
    <div class="plan-card__media" aria-hidden="true">
        {% set card_image = plan.cover_image or plan.main_image %}
        {% if card_image %}
            <div class="skeleton"></div>
            <a href="{{ url_for('main.pack_detail', slug=plan.slug) }}" title="Open {{ plan_title }}" itemprop="url">
                {{ picture_tag(card_image, alt='', preset=CARD_PRESET, variant='base', loading='lazy', css_class='plan-card__img js-lazy-img') }}
            </a>
        {% else %}
            <div class="plan-card__placeholder">Visual coming soon</div>
        {% endif %}
        <div class="plan-card__labels">
            {% if plan.is_featured %}<span class="badge badge--glow">Featured</span>{% endif %}
            {% if plan.is_on_sale %}<span class="badge badge--outline">On sale</span>{% endif %}
        </div>
        <button
            class="favorite-toggle"
            type="button"
            title="Save {{ plan_title }}"
            aria-pressed="false"
            data-favorite-toggle
            data-plan-id="{{ plan.id }}"
            data-plan-slug="{{ plan.slug }}"
            data-plan-title="{{ plan_title }}"
            data-plan-reference="{{ plan_ref }}"
            data-plan-thumb="{{ upload_url(card_image) if card_image else '' }}">
            <span class="favorite-toggle__icon" aria-hidden="true">♡</span>
            <span class="favorite-toggle__label">Add to favorites</span>
        </button>
    </div>
    <div class="plan-card__body">
        {% set raw_best_for = plan.lifestyle_suitability or plan.ideal_for or plan.design_philosophy %}
        {% if not raw_best_for and plan.categories %}
            {% set fallback_category = plan.categories|first %}
            {% if fallback_category %}
                {% set raw_best_for = 'Great for ' ~ fallback_category.name ~ ' living' %}
            {% endif %}
        {% endif %}
        {% if raw_best_for %}
            {% set best_for = (raw_best_for|replace('\n', ' ')).split('.')|first %}
            {% if best_for %}
            <div class="plan-card__bestfor" aria-label="Lifestyle fit">
                <span class="plan-card__bestfor-label">Best for</span>
                <span>{{ best_for|trim }}</span>
            </div>
            {% endif %}
        {% endif %}
        <div class="plan-card__top">
            <p class="plan-card__eyebrow">
                {% if plan.categories %}
                    {% for c in plan.categories %}
                        <a href="{{ url_for('main.plans_by_category', slug=c.slug) }}">{{ c.name }}</a>{% if not loop.last %} · {% endif %}
                    {% endfor %}
                {% else %}
                    Thoughtful living
                {% endif %}
            </p>
            <h3 class="plan-card__title" itemprop="name"><a href="{{ url_for('main.pack_detail', slug=plan.slug) }}">{{ plan_title }}</a></h3>
            <div class="plan-card__ref" aria-label="Reference code">Ref {{ plan_ref }}</div>
        </div>

        <div class="plan-card__quick-specs" aria-label="Quick specs">
            {% if plan.area_sqft %}
                <span class="plan-quick-spec" aria-label="{{ plan.area_sqft|round|int }} square feet of living space">
                    <small>Area</small>
                    <strong>{{ plan.area_sqft|round|int }} sq ft</strong>
                </span>
            {% endif %}
            {% if plan.bedrooms_count %}
                <span class="plan-quick-spec" aria-label="{{ plan.bedrooms_count }} bedroom{% if plan.bedrooms_count|int != 1 %}s{% endif %}">
                    <small>Beds</small>
                    <strong>{{ plan.bedrooms_count }}</strong>
                </span>
            {% endif %}
            {% if plan.bathrooms_count %}
                <span class="plan-quick-spec" aria-label="{{ plan.bathrooms_count }} bathroom{% if plan.bathrooms_count|int != 1 %}s{% endif %}">
                    <small>Baths</small>
                    <strong>{{ plan.bathrooms_count }}</strong>
                </span>
            {% endif %}
            {% if plan.floors_count %}
                <span class="plan-quick-spec" aria-label="{{ plan.floors_count }} floor{% if plan.floors_count|int != 1 %}s{% endif %}">
                    <small>Floors</small>
                    <strong>{{ plan.floors_count }}</strong>
                </span>
            {% endif %}
            {% if plan.parking_count %}
                <span class="plan-quick-spec" aria-label="{{ plan.parking_count }} parking space{% if plan.parking_count|int != 1 %}s{% endif %}">
                    <small>Parking</small>
                    <strong>{{ plan.parking_count }}</strong>
                </span>
            {% endif %}
        </div>

        {% set tiers = plan.pricing_tiers %}
        {% if tiers %}
        <div class="plan-card__tiers plan-card__tiers--inline" aria-label="Pack overview">
            {% for tier in tiers %}
            <div class="plan-card__tier {% if not tier.available %}plan-card__tier--muted{% endif %}">
                <span>Pack {{ '%02d'|format(tier.pack) }}</span>
                <span>
                    {% if tier.price and tier.price > 0 %}
                        ${{ tier.price|round(0)|int }}
                    {% elif tier.is_free %}
                        Free
                    {% else %}
                        Soon
                    {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="plan-card__footer" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
            {% if plan.starting_paid_price %}
                <div class="plan-card__price" itemprop="price">From ${{ plan.starting_paid_price|round(0)|int }}</div>
            {% else %}
                <div class="plan-card__price" itemprop="price">Free</div>
            {% endif %}
            <meta itemprop="priceCurrency" content="USD">
        </div>
        <div class="plan-card__actions">
            <a class="btn btn-ghost" href="{{ url_for('main.pack_detail', slug=plan.slug) }}">See plan details</a>
            <button
                class="compare-toggle"
                type="button"
                aria-pressed="false"
                data-compare-toggle
                data-plan-id="{{ plan.id }}"
                data-plan-slug="{{ plan.slug }}"
                data-plan-title="{{ plan_title }}"
                data-plan-reference="{{ plan_ref }}"
                data-plan-thumb="{{ upload_url(card_image) if card_image else '' }}"
                data-plan-area="{{ plan.area_sqft or plan.total_area_sqft or '' }}"
                data-plan-area-m2="{{ plan.area_m2 or '' }}"
                data-plan-bedrooms="{{ plan.bedrooms_count or '' }}"
                data-plan-bathrooms="{{ plan.bathrooms_count or '' }}"
                data-plan-floors="{{ plan.floors_count or '' }}"
                data-plan-parking="{{ plan.parking_count or '' }}"
                data-plan-price="{{ plan.starting_paid_price or '' }}"
                data-plan-free="{{ '1' if plan.has_free_download else '0' }}"
                data-plan-categories="{{ plan.categories|map(attribute='name')|join(' · ') if plan.categories else '' }}"
                data-plan-url="{{ url_for('main.pack_detail', slug=plan.slug) }}">
                <span class="compare-toggle__label">Add to compare</span>
            </button>
        </div>
        <p class="microcopy">Not sure yet? Save the plan or message us—guidance is always free.</p>
    </div>
</article>
{% endfor %}
